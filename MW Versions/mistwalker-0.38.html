<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mistwalker</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; }
body {
  font-family: Georgia, 'Times New Roman', serif;
  background: #0d0d14;
  color: #d4cfc6;
  min-height: 100vh;
  line-height: 1.55;
}
:root {
  --bg-deep: #0d0d14;
  --bg-panel: #151520;
  --bg-card: #1c1c2b;
  --bg-card-hover: #24243a;
  --bg-input: #12121e;
  --border: #2a2a3d;
  --text-primary: #d4cfc6;
  --text-secondary: #8a8678;
  --text-muted: #5a5750;
  --accent: #c9a96e;
  --accent-dim: #8a7444;
  --danger: #a83232;
  --danger-light: #c94444;
  --success: #3a7a3a;
  --success-light: #4a9a4a;
  --info: #3a5a8a;
  --info-light: #4a7aba;
  --warning: #8a6a2a;
  --warning-light: #ba8a3a;
  --expedition: #6a4a8a;
  --expedition-light: #8a6aaa;
}
#app {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto 1fr;
  height: 100vh;
  max-width: 1400px;
  margin: 0 auto;
}
.header {
  grid-column: 1 / 3;
  background: var(--bg-panel);
  border-bottom: 1px solid var(--border);
  padding: 10px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}
.header-title { font-size: 1.15rem; color: var(--accent); letter-spacing: 1px; white-space: nowrap; }
.header-day { font-size: 0.9rem; color: var(--text-secondary); display:flex; align-items:baseline; gap:8px; }
.header-day .day-num { font-size: 1.3rem; font-weight: bold; color: #e8c874; letter-spacing: 1px; }
@keyframes foodPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
.food-pulse { animation: foodPulse 1.5s ease-in-out infinite; }
.header-day .ver { font-size: 0.65rem; color: var(--text-muted); opacity: 0.6; }
.header-stats { display: flex; gap: 16px; font-size: 0.8rem; flex-wrap: wrap; }
.stat { display: flex; align-items: center; gap: 4px; position: relative; cursor: default; }
.stat[data-tip]:hover::after { content: attr(data-tip); position: absolute; left: 0; top: 100%; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.75rem; padding: 6px 10px; white-space: pre; z-index: 100; pointer-events: none; line-height: 1.6; min-width: 160px; }
.stat-label { color: var(--text-muted); }
.stat-value { color: var(--text-primary); font-weight: bold; }
.stat-value.danger { color: var(--danger-light); }
.stat-value.warning { color: var(--warning-light); }
.stat-value.good { color: var(--success-light); }
.btn-advance {
  background: var(--accent-dim); color: var(--bg-deep); border: none;
  padding: 8px 28px; font-family: Georgia, serif; font-size: 0.85rem;
  cursor: pointer; letter-spacing: 1px; transition: all 0.2s; white-space: nowrap;
}
.btn-advance:hover { background: var(--accent); }
.feed-panel { border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
.feed-header { padding: 10px 16px; font-size: 0.75rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border); background: var(--bg-panel); }
.feed-arrow:hover { opacity: 1 !important; color: var(--text-primary); }
.feed-scroll { flex: 1; overflow-y: auto; padding: 12px 16px; padding-bottom: 20px; }
.right-panel { display: flex; flex-direction: column; overflow: hidden; }
.tabs { display: flex; background: var(--bg-panel); border-bottom: 1px solid var(--border); padding: 0; flex-wrap: wrap; }
.tab { position: relative; padding: 8px 14px; cursor: pointer; color: var(--text-muted); border: none; border-bottom: 2px solid transparent; transition: all 0.2s; font-family: Georgia, serif; font-size: 0.8rem; background: none; }
.tab:hover { color: var(--text-secondary); }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }
.tab.has-action { position: relative; }
.tab.has-action::after { content: ''; position: absolute; top: 6px; right: 4px; width: 6px; height: 6px; border-radius: 50%; background: var(--accent); animation: tab-pulse 2s ease-in-out infinite; }
.badge-new { display:inline-block; background: var(--danger-light); color: #000; font-size: 9px; font-weight: bold; padding: 0 4px; border-radius: 3px; margin-left: 6px; vertical-align: middle; animation: tab-pulse 2s ease-in-out infinite; }
@keyframes tab-pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
.tab-content { flex: 1; overflow-y: auto; padding: 16px; }
.view { display: none; }
.view.active { display: block; }
.day-header { color: #e8c874; font-size: 0.8rem; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; margin: 18px 0 8px; padding-bottom: 5px; border-bottom: 1px solid rgba(232,200,116,0.25); }
.day-header:first-child { margin-top: 0; }
.message { background: var(--bg-card); border: 1px solid var(--border); padding: 10px 14px; margin-bottom: 6px; border-left: 3px solid var(--border); font-size: 0.88rem; }
.message.cat-alert { border-left-color: var(--danger-light); }
.message.cat-expedition { border-left-color: var(--expedition-light); }
.message.cat-perimeter { border-left-color: var(--info-light); }
.message.cat-system { border-left-color: var(--success-light); }
.message.cat-research { border-left-color: var(--warning-light); }
.message.cat-event { border-left-color: var(--accent); }
.message.cat-training { border-left-color: #6aaa8a; }
.message.cat-combat { border-left-color: #aa4444; }
.message.cat-dig { border-left-color: #7a6a5a; }
.msg-category { font-size: 0.65rem; letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 4px; font-family: monospace; }
.cat-alert .msg-category { color: var(--danger-light); }
.cat-expedition .msg-category { color: var(--expedition-light); }
.cat-perimeter .msg-category { color: var(--info-light); }
.cat-system .msg-category { color: var(--success-light); }
.cat-research .msg-category { color: var(--warning-light); }
.cat-event .msg-category { color: var(--accent); }
.cat-training .msg-category { color: #6aaa8a; }
.cat-combat .msg-category { color: #aa4444; }
.cat-dig .msg-category { color: #7a6a5a; }
.msg-text { font-size: 0.88rem; line-height: 1.5; }
.message.clickable { cursor: pointer; transition: background 0.15s, border-color 0.15s; position: relative; padding-right: 22px; }
.message.clickable:hover { background: var(--bg-card-hover); border-color: var(--accent-dim); }
.msg-goto { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); opacity: 0.3; font-size: 1.1rem; }
.message.clickable:hover .msg-goto { opacity: 0.7; }
.garrison-badge { display:inline-block;font-size:0.65rem;font-weight:700;color:var(--danger-light);background:rgba(255,80,80,0.12);border:1px solid var(--danger-light);border-radius:3px;padding:0 4px;margin-left:6px;letter-spacing:0.5px;vertical-align:middle; }
.msg-actions { margin-top: 8px; display: flex; gap: 6px; flex-wrap: wrap; }
.btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); padding: 5px 12px; font-family: Georgia, serif; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; }
.btn:hover { background: var(--bg-card-hover); border-color: var(--accent-dim); color: var(--accent); }
.btn-primary { background: var(--accent-dim); color: var(--bg-deep); border-color: var(--accent-dim); }
.btn-primary:hover { background: var(--accent); border-color: var(--accent); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; }
.dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.dash-card { background: var(--bg-card); border: 1px solid var(--border); padding: 12px; }
.dash-card h3 { font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; }
.dash-value { font-size: 1.5rem; color: var(--accent); margin-bottom: 2px; position: relative; cursor: default; }
.dash-value[data-tip]:hover::after { content: attr(data-tip); position: absolute; left: 0; top: 100%; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.75rem; padding: 6px 10px; white-space: pre; z-index: 100; pointer-events: none; line-height: 1.6; min-width: 160px; }
.dash-detail { font-size: 0.8rem; color: var(--text-secondary); }
.section-title { font-size: 0.7rem; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); margin: 16px 0 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
.section-title:first-child { margin-top: 0; }
.item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); margin-bottom: 4px; font-size: 0.85rem; }
.item-row:hover { background: var(--bg-card-hover); }
.item-row.clickable { cursor: pointer; }
.item-name { color: var(--text-primary); }
.item-detail { color: var(--text-secondary); font-size: 0.8rem; }
.status-good { color: var(--success-light); }
.status-warn { color: var(--warning-light); }
.status-bad { color: var(--danger-light); }
.status-info { color: var(--info-light); }
.status-expedition { color: var(--expedition-light); }
.role-group { margin-bottom: 16px; }
.role-header { font-size: 0.85rem; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--border); font-weight: 600; }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 200; }
.modal-overlay.open { display: block; }
.modal { background: var(--bg-panel); border: 1px solid var(--border); max-width: 520px; width: 90%; max-height: 70vh; overflow-y: auto; padding: 20px; position: absolute; }
.modal h2 { font-size: 1rem; color: var(--accent); margin-bottom: 12px; }
.modal p { font-size: 0.85rem; margin-bottom: 10px; color: var(--text-secondary); }
.modal-actions { margin-top: 14px; display: flex; gap: 8px; flex-wrap: wrap; }
.trait-bar { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; font-size: 0.8rem; }
.trait-label { width: 80px; color: var(--text-secondary); }
.trait-dots { display: flex; gap: 3px; }
.trait-dot { width: 9px; height: 9px; border-radius: 50%; background: var(--border); }
.trait-dot.filled { background: var(--accent); }
.trait-hint { font-size: 0.65rem; color: var(--text-muted); font-style: italic; }
.select-group { margin-bottom: 10px; }
.select-group label { display: block; font-size: 0.75rem; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; }
.select-group select { width: 100%; padding: 6px; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); font-family: Georgia, serif; font-size: 0.85rem; }
.reassign-section { margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--border); }
.reassign-section h3 { font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; }
.empty-state { text-align: center; color: var(--text-muted); padding: 30px; font-style: italic; font-size: 0.85rem; }
.location-card { background: var(--bg-card); border: 1px solid var(--border); padding: 10px 12px; margin-bottom: 6px; }
.location-card.locked { opacity: 0.5; }
.location-card.explored { border-left: 3px solid var(--success-light); }
.location-card.available { border-left: 3px solid var(--accent); }
.tip { position: relative; cursor: help; border-bottom: 1px dotted var(--text-muted); }
.tip:hover::after { content: attr(data-tip); position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-primary); padding: 4px 8px; font-size: 0.75rem; white-space: nowrap; z-index: 100; pointer-events: none; }
.intro-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-deep); z-index: 300; display: flex; justify-content: center; align-items: center; transition: opacity 1s; }
.intro-overlay.fading { opacity: 0; pointer-events: none; }
.intro-content { max-width: 500px; padding: 40px; text-align: center; }
.intro-content h1 { font-size: 1.8rem; color: var(--accent); margin-bottom: 20px; letter-spacing: 3px; }
.intro-content p { font-size: 0.95rem; line-height: 1.8; color: var(--text-secondary); margin-bottom: 12px; }
.gameover-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 300; justify-content: center; align-items: center; }
.gameover-overlay.open { display: flex; }
.gameover-content { max-width: 450px; padding: 40px; text-align: center; }
.gameover-content h1 { font-size: 1.5rem; color: var(--danger-light); margin-bottom: 12px; }
.gameover-content p { color: var(--text-secondary); margin-bottom: 10px; }
</style>
</head>
<body>
<div class="intro-overlay" id="intro">
  <div class="intro-content">
    <h1>MISTWALKER</h1>
    <p>The mist came. Your monastery survived. Protected by prayer, surrounded by farms, ringed by priests who hold back the fog.</p>
    <p>Sustain the monastery. Explore the mist. Discover what lies beyond.</p>
    <button class="btn btn-primary" onclick="startGame()" style="margin-top:20px; padding:10px 36px; font-size:0.95rem;">Begin</button>
  </div>
</div>
<div class="gameover-overlay" id="gameover">
  <div class="gameover-content">
    <h1>The Light Has Gone Out</h1>
    <p id="gameover-reason"></p>
    <p id="gameover-stats"></p>
    <button class="btn" onclick="location.reload()" style="margin-top:16px;">Try Again</button>
  </div>
</div>
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal-content"></div>
</div>
<div id="app">
  <div class="header">
    <div style="display:flex;align-items:center;gap:16px;">
      <div class="header-title">MISTWALKER</div>
      <div class="header-day" id="header-day">Day 1</div>
    </div>
    <div class="header-stats" id="header-stats"></div>
    <button class="btn-advance" onclick="advanceDay()">ADVANCE DAY</button>
  </div>
  <div class="feed-panel">
    <div class="feed-header" style="display:flex;align-items:center;justify-content:center;position:relative"><span id="feed-filter-label" onclick="toggleFeedDropdown()" style="cursor:pointer;user-select:none"></span><div id="feed-dropdown" style="display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);background:var(--bg-card);border:1px solid var(--border);border-radius:4px;z-index:100;min-width:120px;padding:4px 0;box-shadow:0 4px 12px rgba(0,0,0,0.4)"></div></div>
    <div class="feed-scroll" id="feed-scroll"></div>
  </div>
  <div class="right-panel">
    <div class="tabs">
      <button class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab" data-tab="people" onclick="switchTab('people')">Units</button>
      <button class="tab" data-tab="expeditions" onclick="switchTab('expeditions')">Mistwalker</button>
      <button class="tab" data-tab="research" onclick="switchTab('research')">Scholar</button>
      <button class="tab" data-tab="engineering" onclick="switchTab('engineering')">Engineer</button>
      <button class="tab" data-tab="artifacts" onclick="switchTab('artifacts')">Artifacts</button>
    </div>
    <div class="tab-content">
      <div class="view active" id="view-dashboard"></div>
      <div class="view" id="view-people"></div>
      <div class="view" id="view-expeditions"></div>
      <div class="view" id="view-research"></div>
      <div class="view" id="view-engineering"></div>
      <div class="view" id="view-artifacts"></div>
    </div>
  </div>
</div>
<script>
const VERSION='Alpha 0.38';
const NAMES={
locations:['The Sunken Chapel','Ashenveil Crossing','The Bone Orchard','Greymarch Bridge','Hollowspire','The Wailing Reach','Duskfield Ruins','Thornwall Keep','Misthollow Basin','The Pale Gate','Cindervault','Blackmere Depths','The Shattered Nave','Ironmoor Station','Rotstone Abbey','Gloomfen','The Veiled Stairs','Copperhead Ravine','Whispering Cairns','Old Mill Crossing','The Drowned Altar','Ashen Arbor','Frostbind Pass','The Hungering Dark','Lichen Crypt','Blight Hollow','Starfall Terrace','The Warden Ring','Salt Flat Sanctum','Mirewatch Tower','The Severed Path','Ghostmist Landing','Dreadfall Cleft','The Gilt Tomb','Ravenmoor','Blightwell','The Iron Parish','Coldvein Mine','Fogmantle Ridge','The Broken Loom','Embervault','Hushwood','The Obsidian Table','Rothelm Barracks','Gallowsreach','The Lost Reliquary','Mistfang Gorge','Penitent Hill','The Stoneblood Gate','Veilwatch Outpost'],
creaturesPhysical:['Hollow Stalker','Ashmouth','Mistfang','Blighthound','Thornback','Bonepick','Shriek Bat','Duskwolf','Rootmaw','Mist Serpent','Scorch Drake','Blight Worm','Frostmaw','Deadwood Strider','Rot Wasp','Ash Bear','Cinder Wolf','Thorn Horror','Mist Drake','Nightcrawler'],
creaturesSpiritual:['Veilwraith','The Pale Ones','Flickergeist','Carrion Shade','The Wailing','Weeping One','Shadeweaver','The Faceless','Grey Ghoul','Fog Stalker','Cryptwyrm','Rattlebone','The Hungering','Cinderspawn','Gloom Crawler','Ash Widow'],
creaturesCorrupted:['Rotweaver','Husk Shambler','The Eyeless','Marrow Leech','Sporespawn','Bonewalker','Gloom Hulk','Petrified Shambler','The Withered','Huskling','Mireborn','Fog Lurker','Embertick','Veilspider'],
digLevels:['The Shallow Cellars','The Forgotten Crypts','The Sunken Archive','The Deep Foundry'],
survivors:['Soren','Elara','Matthias','Wren','Isadora','Beric','Calla','Aldous','Thessa','Rowan','Mira','Godric','Yara','Leander','Faye','Corwin','Elsa','Draven','Ingrid','Willem','Brienne','Ashton','Delia','Gareth','Hazel','Kael','Lisbeth','Milo','Nerissa','Oswin','Priya','Quillan','Rhea','Stellan','Tanith','Ulric','Vera','Wystan','Xara','Yorick','Zara','Anselm','Britta','Caspian','Dagny','Emeric','Fiora','Gunnar','Hestia','Ivo'],
clueTextsLocation:[
'Worn stone markers point further into the mist. Something deliberate lies ahead.',
'Old boot prints fossilized in ash. Someone walked here with purpose.',
'A carved symbol — a waypoint. This trail leads somewhere specific.',
'Fragments of a map etched into bark. The destination is partially legible.',
'The mist parts briefly, revealing distant walls. A structure, waiting.',
'Wind carries the scent of old mortar and worked stone from this direction.',
'The creatures avoid a particular path. They know something is there.',
'A faded signpost, half-consumed by mist. The letters suggest a name.',
'Prayer beads strung between dead trees — pilgrims came this way once.',
'Scratch marks on a boulder. Someone counted the days to reach something.',
'An abandoned campsite. Whoever rested here was heading deeper, deliberately.',
'The ground is smoother here — an old road, buried under ash and silence.',
'A child\'s drawing on a wall fragment: buildings in the mist, with a path.',
'Bones arranged in an arrow. A final message from someone who found the way.',
'The mist eddies around a gap in the terrain. A passage, perhaps.'
],
clueTextsFinal:[
'The mist flows like a river here — and rivers have a source.',
'A low hum at the edge of hearing. It comes from everywhere and nowhere.',
'The corruption is stronger here. Whatever poisons the land, it is close.',
'Ancient text speaks of a wound in the world. The mist bleeds from it.',
'The creatures grow more frantic near this place. They are drawn to it.',
'A priest\'s journal, half-dissolved: "The center holds. The center hungers."',
'Stone tablets describe a gate — not to keep things out, but to keep something in.',
'The mist has a heartbeat here. Slow. Patient. Waiting.',
'Symbols on the walls match across every ruin. They all point the same direction.',
'A scholar\'s dying note: "It is not weather. It is not natural. It was opened."',
'The air tastes of iron and old grief. The source of all this suffering is near.',
'Fossilized roots grow upward here, toward something beneath the earth.',
'Every compass spins when brought this deep. Something pulls at the world.',
'The mist is not fog — it is breath. Something vast exhales it endlessly.',
'A final waystone, cracked but legible: "BEYOND HERE, THE WOUND."'
]
};

const FLAVOR={
locDesc:[
['Barely visible through the mist. Broken walls catch what little light remains.','Close enough to hear sounds on quiet nights. Something shifts in the fog.','The outline is familiar — a place like the monastery, but long abandoned.','Pale stone shows through the grey. Whatever happened here happened quickly.','The mist thins here occasionally, revealing dark windows and collapsed roofing.','Wind carries a faint smell from this direction. Old wood. Old stone. Old death.'],
['A dark shape at the edge of perception. The mist seems thicker there.','Faint lights have been reported. Whether firelight or something else, none can say.','The priests sense something from that direction. Cold and patient.','Occasionally the wind carries sounds — grinding stone, or perhaps just the earth settling.','A landmark the old maps agree on, though they disagree on everything else.','Mist walkers report the fog behaves strangely near this place. It pulls.'],
['Beyond the easy reach of prayer. Whatever waits there has waited a long time.','Only the most experienced walkers have glimpsed it. They came back quiet.','Deep in the mist. The air grows strange near it — charged, almost electric.','The old chronicles mention this place. They advise against going. They do not say why.','So far that even the mist seems different there. Thicker. Older. Hungry.','At the very edge of what the walkers can reach. A place of last resorts.']
],
depart:[
'{name} steps beyond the perimeter. The mist closes behind like a curtain.',
'{name} adjusts pack and gear, nods to the gate priests. The grey swallows the rest.',
'The gate opens. {name} walks into the fog without looking back.',
'A brief prayer from the perimeter priests, then {name} is gone.',
'{name} takes one last breath of clean air and steps through.',
'The mist parts reluctantly for {name}. It will be less courteous on the way back.'
],
midway:[
'No sign of {name}. The mist offers no answers.',
'A brief flash of light in the distance. Perhaps {name}\'s signal. Perhaps not.',
'{name} is still out there. The perimeter priests say they can still sense the connection.',
'Nothing from {name}\'s direction. Silence is usually good news.',
'Day {day} without word. The monastery carries on.',
'Some claim they heard footsteps beyond the perimeter last night. Probably not {name}.'
],
returnPeace:[
'{name} emerged from the mist, tired but whole. "Quiet out there," was all the report.',
'{name} returned with pack heavy and spirits intact. The mist was merciful today.',
'The gate priests spotted {name} approaching at dusk. No wounds. No pursuit.',
'{name} came back with dust on every surface and a look of grim satisfaction.',
'A shape in the fog — then {name}, alive and laden with findings.'
],
returnWin:[
'{name}\'s team held their ground. Steel and faith proved enough.',
'The {creature} came fast. {name} was ready.',
'{name} reports the {creature} scattered after the first real blow.',
'The {creature} tested {name}\'s resolve and found it unyielding.'
],
returnNarrow:[
'{name} limped back with the team. "We won, but barely."',
'Victory against the {creature}, but the cost was written on their faces.',
'The {creature} fought hard. {name}\'s team fought harder — just.',
'{name}\'s expedition survived the {creature}, though not without scars.'
],
returnLoss:[
'{name} came back at a run, team in tow. "Too many. We had to fall back."',
'The {creature} overwhelmed them. {name} made the call to retreat.',
'They tried. The {creature} were simply too numerous.',
'{name} emerged from the mist supporting a wounded companion.'
],
discExp:[
'Among the ruins: {disc}. Fragile, but intact enough to study.',
'Half-buried in debris: {disc}. The scholars will want to see this.',
'{name} found something remarkable — {disc}.',
'Wrapped in oilcloth, as if someone meant to protect it: {disc}.',
'In a sealed chamber untouched by mist: {disc}. Ancient, and invaluable.'
],
discDig:[
'The engineers broke through to a sealed space. Within: {disc}.',
'Picks struck hollow stone. Beyond it, carefully preserved: {disc}.',
'Dust and centuries of silence, then: {disc}. As if it had been waiting.',
'Deep beneath the foundations: {disc}. The builders knew this was here.'
],
artFound:[
'Something glints in the rubble — {art}. It hums faintly when touched.',
'Wrapped in rotting cloth: {art}. The craftsmanship is beyond anything here.',
'{art}, buried among the bones of its last owner. Still potent.',
'Hidden behind a false wall: {art}. Someone hid this deliberately.'
],
defWin:[
'The {creature} lunged. The line held without flinching.',
'A textbook defense. The {creature} never breached the formation.',
'Blades met claws and the result was simple: the monastery stood firm.',
'The {creature} broke against the defenders like fog against stone.'
],
defNarrow:[
'The {creature} found a gap in the line. Blood was spilled before it was sealed.',
'A desperate few minutes. The defenders held, but the cost was real.',
'Touch and go. The {creature} nearly broke through before being driven back.',
'The line bent but did not break. Someone paid the price for that.'
],
defLoss:[
'The {creature} came in waves. The line buckled, then broke.',
'Too many, too fast. The defenders fought for every step and lost most of it.',
'A breach. The {creature} poured through before anyone could react.',
'The defense crumbled under sheer numbers.'
],
threatSeen:[
'Movement in the mist. {creature} — {count} of them, from the {dir}.',
'The watchers report shapes in the fog. {creature}, {count} strong, from the {dir}.',
'A scout barely made it back. {creature}, at least {count}, from the {dir}.',
'The mist ripples with purpose. Something approaches from the {dir}. {creature}. {count} of them.'
],
idle:[
'{name} was found praying alone in the chapel before dawn.',
'{name} and {name2} shared a flask of something by the fire. Neither spoke much.',
'{name} spent the evening sharpening blades. The rhythm carried through the halls.',
'{name} worked extra hours. "Keeps the mind off things."',
'{name} stood at the perimeter for a long time, watching the mist.',
'A few gathered to hear {name} tell stories of before the mist.',
'Someone left wildflowers on the memorial stones. {name} was seen nearby.',
'{name} repaired a section of wall that didn\'t strictly need repairing.',
'{name} couldn\'t sleep and spent the night cataloguing supplies.',
'{name} taught {name2} a card game from before. Laughter echoed briefly.',
'An argument between {name} and {name2} over watch duties ended in grudging agreement.',
'{name} carved a small figure from scrap wood. It sits on the windowsill now.',
'The smell of cooking — {name} found herbs in the garden and made something almost pleasant.',
'{name} was caught talking to the monastery cat. "Best listener here," was the defense.'
],
research:[
'After days of careful study, the meaning becomes clear.',
'Pages of notes, sleepless nights. But the knowledge was worth it.',
'The text was old, the language archaic. But the secrets within are real.',
'What seemed like gibberish at first reveals its patterns.',
'The scholars emerged exhausted but certain. They have something.'
],
digCleared:[
'The last stones gave way. A new space opens beneath the monastery.',
'Air rushes up from below — stale, ancient, but breathable. They\'re through.',
'Lantern light spills into a chamber no one has entered in centuries.',
'The engineers emerge covered in dust, grinning. "You should see what\'s down there."'
]
};
function flavorText(pool,vars){let t=pick(pool);if(vars)for(let[k,v]of Object.entries(vars))t=t.split('{'+k+'}').join(v);return t}

const CONFIG={foodPerPerson:1,startingFood:120,trainingDays:{priest:14,fighter:7,mistwalker:21,scholar:10,engineer:8,worker:3,mystic:14,alchemist:12},baseStats:{fighter:{attack:2,defense:2},priest:{shields:2,endurance:0},scholar:{researchSpeed:1.0,insight:1},engineer:{buildSpeed:1.0,digSpeed:1.0},mistwalker:{attack:2,defense:2,mistEndurance:0},worker:{yield:3,chopRate:1,digSpeed:0.5},mystic:{attack:1.5,defense:1.5},alchemist:{brewSpeed:1.0,insight:0.5}},defenseValue:{fighter:1.0,mistwalker:1.0,mystic:1.0,worker:0.5,priest:0.3,scholar:0.2,engineer:0.2,alchemist:0.2,unassigned:0.25,training:0},baseAttentionPerDay:0.5,expeditionAttention:5,threatThreshold:20,threatSpawnInterval:8,maxOverlappingThreats:2,survivorCheckFrequency:10,survivorChanceBase:50,survivorChanceAfterDeath:65,scoutingDays:1,recallSpeedMultiplier:2,mistRings:[{id:'shallows',label:'The Shallows',minRange:1,encounterChance:10,injuryMin:2,injuryMax:3,rewards:[{type:'location',w:35},{type:'discovery',w:25},{type:'food',w:15},{type:'nothing',w:15},{type:'survivor',w:10}]},{id:'greyreach',label:'The Grey Reach',minRange:4,encounterChance:20,injuryMin:4,injuryMax:5,rewards:[{type:'location',w:30},{type:'discovery',w:25},{type:'survivor',w:15},{type:'weakness',w:15},{type:'nothing',w:15}]},{id:'deep',label:'The Deep',minRange:7,encounterChance:30,injuryMin:6,injuryMax:8,rewards:[{type:'discovery',w:25},{type:'location',w:20},{type:'survivor',w:20},{type:'weakness',w:15},{type:'artifact',w:10},{type:'nothing',w:10}]}]};

// PROCEDURAL ITEM GENERATION POOLS
const ITEM_POOLS={categories:['combat','perimeter','research','production','defense','mist'],baseTypes:{combat:[{label:'Blade',roles:['fighter','mistwalker']},{label:'Claw',roles:['fighter','mistwalker']},{label:'Staff',roles:['mystic','scholar']},{label:'Bow',roles:['fighter','mistwalker']},{label:'Spear',roles:['fighter','mistwalker']}],perimeter:[{label:'Censer',roles:['priest']},{label:'Chalice',roles:['priest']},{label:'Icon',roles:['priest']},{label:'Bell',roles:['priest']},{label:'Vestment',roles:['priest']}],research:[{label:'Tome',roles:['scholar','alchemist']},{label:'Grimoire',roles:['scholar','alchemist']},{label:'Tablet',roles:['scholar']},{label:'Codex',roles:['scholar']},{label:'Scroll',roles:['scholar','alchemist']}],production:[{label:'Hammer',roles:['worker','engineer']},{label:'Pick',roles:['worker','engineer']},{label:'Scythe',roles:['worker']},{label:'Saw',roles:['engineer']},{label:'Trowel',roles:['worker','engineer']}],defense:[{label:'Talisman',roles:['fighter','priest','scholar','mystic','mistwalker','worker','engineer','alchemist']},{label:'Amulet',roles:['fighter','priest','scholar','mystic','mistwalker','worker','engineer','alchemist']},{label:'Ring',roles:['fighter','priest','scholar','mystic','mistwalker','worker','engineer','alchemist']},{label:'Pendant',roles:['fighter','priest','scholar','mystic','mistwalker','worker','engineer','alchemist']},{label:'Brooch',roles:['fighter','priest','scholar','mystic','mistwalker','worker','engineer','alchemist']}],mist:[{label:'Lantern',roles:['mistwalker']},{label:'Compass',roles:['mistwalker']},{label:'Cloak',roles:['mistwalker']},{label:'Veil',roles:['mistwalker']},{label:'Mask',roles:['mistwalker']}]},modifiers:{combat:['War','Fury','Blood','Iron','Flame','Wrath','Thunder','Ruin','Storm','Carnage','Slaughter','Dread','Shadow','Bone','Ash','Vengeance','Night','Sorrow','Spite','Rage','Doom','Conquest','Havoc','Blight','Venom'],perimeter:['Wards','Sanctity','Grace','Vigilance','Devotion','Shelter','Faith','Light','Blessing','Communion','Passage','Threshold','Radiance','Stillness','Peace','Resolve','Purity','Virtue','Hope','Dawn','Solace','Patience','Harmony','Serenity','Temperance'],research:['Secrets','Lore','Ancients','Clarity','Wisdom','Knowledge','Sight','Truth','Understanding','Insight','Mystery','Binding','Runes','Glyphs','Stars','Memory','Language','Thought','Echo','Resonance','Prophecy','Time','Origin','Riddles','Depths'],production:['Harvest','Plenty','Making','Industry','Craft','Growth','Toil','Creation','Yield','Bounty','Labor','Skill','Mastery','Forging','Building','Mending','Shaping','Cutting','Thrift','Diligence','Renewal','Foundation','Structure','Abundance','Efficiency'],defense:['Fortune','Warding','Spirit','Preservation','Endurance','Resilience','Fortitude','Vigor','Vitality','Guard','Haven','Refuge','Steadfast','Anchor','Stone','Calm','Balance','Aegis','Shell','Bastion','Bulwark','Pact','Oath','Binding','Covenant'],mist:['Veil','Passage','Depths','Wandering','Fog','Grey','Silence','Drifting','Seeking','Lost','Pathways','Beyond','Between','Threshold','Haze','Twilight','Whisper','Stillness','Fading','Reaching','Void','Distance','Return','Wanderlust','Horizons']},prefixes:{common:['Worn','Crude','Simple','Plain','Old','Tarnished','Dull','Weathered','Battered','Rustic'],uncommon:['Sturdy','Blessed','Honed','Tempered','Fine','Polished','Keen','Hardy','True','Proven'],rare:['Ancient','Luminous','Consecrated','Mist-Touched','Hallowed','Radiant','Gilded','Runic','Fabled','Storied'],legendary:['Eternal','Primordial','Void-Forged','Sanctified','Mythic','Transcendent','Awakened','Celestial']},suffixes:{combat:['Bane','Render','Reaper','Scourge','Fang','Edge','Fury','Sunder','Pierce','Rend','Cleave','Smite','Strike','Ruin'],perimeter:['Ward','Aegis','Sentinel','Vigil','Watch','Shield','Bastion','Guard','Refuge','Sanctum','Keep','Light','Beacon'],research:['Codex','Lexicon','Archive','Thesis','Cipher','Index','Oracle','Sage','Compendium','Repository','Chronicle','Grimoire'],production:['Smith','Harvester','Crafter','Builder','Artisan','Mason','Wright','Forger','Mender','Shaper','Maker','Hewer'],defense:['Anchor','Bulwark','Haven','Keeper','Warden','Protector','Guardian','Steadfast','Pact','Bond','Covenant','Seal'],mist:['Walker','Drifter','Seeker','Guide','Wayfinder','Strider','Piercer','Breaker','Navigator','Pathfinder','Wanderer','Scout']}};
const RARITY={common:{mult:1.0,suffixChance:0},uncommon:{mult:1.4,suffixChance:25},rare:{mult:1.8,suffixChance:50},legendary:{mult:2.5,suffixChance:80}};
const LORE_POOLS={prefixes:['Treatise on','Codex of','Chronicle of','Study of','Fragment:','Notes on','Manual of','Compendium of','Record of','Analysis of','Doctrine of','Guide to','Principles of','Secrets of','Writings on'],subjects:{globalBuff:['Ward Construction','Crop Rotation','Defensive Formations','Perimeter Reinforcement','Food Preservation','Signal Methods','Fortification Techniques','Shield Harmonics','Weapon Tempering','Supply Management','Spiritual Fortitude','Garrison Optimization','Harvest Blessing','Structural Integrity','Patrol Coordination'],statBoost:['Body Conditioning','Spiritual Attunement','Mental Acuity Training','Resilience Building','Meditative Focus','Physical Endurance','Cognitive Enhancement','Spirit Channeling','Mind Sharpening','Willpower Forging','Breath Control','Inner Strength','Neural Pathways','Awareness Expansion','Reflex Training'],creatureIntel:['Beast Behavior','Creature Anatomy','Mist Fauna','Predator Patterns','Hunting Grounds','Weakness Analysis','Species Classification','Attack Patterns','Territorial Markers','Feeding Habits'],trainingShortcut:['Accelerated Combat','Swift Priesthood','Rapid Engineering','Fast Scholarship','Efficient Worker Methods','Advanced Teaching','Training Optimization','Muscle Memory','Instinctive Learning','Compressed Curriculum'],eventModifier:['Mist Calming Rites','Protective Incantations','Luck Enchantments','Warding Prayers','Safety Protocols','Risk Mitigation','Fortune Charms','Blessing Circles','Danger Avoidance','Cautionary Wards'],oneTimeEffect:['Emergency Rations Cache','Banishment Ritual','Mass Healing Prayer','Fortification Burst','Rally Cry Formula','Mist Repulsion Wave','Divine Intervention','Last Stand Protocol','Sanctuary Invocation','Emergency Beacon'],herbUnlock:['Herbal Cultivation','Botanical Studies','Plant Identification','Root Medicine','Fungal Properties','Flower Essences','Bark Remedies','Moss Applications','Leaf Preparations','Seed Germination'],recipeUnlock:['Alchemical Formula','Brewing Techniques','Potion Crafting','Tincture Methods','Elixir Distillation','Salve Preparation','Compound Mixing','Extract Refinement','Decoction Process','Infusion Methods']},herbs:{adj:['Silvermoon','Dusk','Ember','Frost','Whisper','Pale','Deep','Ashen','Gloom','Spirit','Mist','Shadow','Dawn','Crimson','Azure','Twilight','Wither','Golden','Iron','Bone','Storm','Silent','Ancient','Bitter','Sweet'],part:['Root','Leaf','Moss','Petal','Bark','Bloom','Spore','Seed','Vine','Bud','Cap','Stem','Berry','Thorn','Frond']},recipes:{base:['Tincture','Elixir','Potion','Draught','Salve','Balm','Brew','Extract','Decoction','Infusion','Compound','Mixture'],modifier:['Vigor','Mending','Clarity','Fortitude','Swiftness','Endurance','Courage','Insight','Resilience','Vitality','Calm','Focus','Strength','Protection','Renewal']}};
function rollRarity(table){let roll=rand(100);if(table==='daily'){if(roll<70)return'common';if(roll<92)return'uncommon';if(roll<99)return'rare';return'legendary'}if(table==='conquest'){if(roll<40)return'common';if(roll<75)return'uncommon';if(roll<95)return'rare';return'legendary'}return'common'}
function generateEquipEffects(category,tier,rarity){let fx={};let m=RARITY[rarity].mult;if(category==='combat'){fx.attack=Math.round((1+Math.floor(tier*0.7))*m);fx.defense=Math.round(Math.floor(tier*0.4)*m)}else if(category==='perimeter'){fx.endurance=Math.round((1+Math.floor(tier*0.5))*m);fx.shields=Math.round(Math.floor(tier*0.6)*m)}else if(category==='research'){fx.researchSpeed=Math.round((0.15+tier*0.1)*m*10)/10}else if(category==='production'){fx.yield=Math.round(tier*m);fx.buildSpeed=Math.round((0.1+tier*0.05)*m*10)/10}else if(category==='defense'){fx.defense=Math.round((1+Math.floor(tier*0.5))*m);fx.endurance=Math.round(Math.floor(tier*0.3)*m)}else if(category==='mist'){fx.mistEndurance=Math.round(tier*m);fx.detection=Math.round(Math.floor(tier*0.4)*m)}let cl={};for(let k in fx)if(fx[k]>0)cl[k]=fx[k];return cl}
function generateLoreName(loreType){let prefix=pick(LORE_POOLS.prefixes);let subjects=LORE_POOLS.subjects[loreType]||LORE_POOLS.subjects.globalBuff;return prefix+' '+pick(subjects)}
function generateHerbName(){return pick(LORE_POOLS.herbs.adj)+' '+pick(LORE_POOLS.herbs.part)}
function generateRecipeName(){return pick(LORE_POOLS.recipes.base)+' of '+pick(LORE_POOLS.recipes.modifier)}
function generateEquipment(tier,rarity,catOverride){let category=catOverride||pick(ITEM_POOLS.categories);let bt=pick(ITEM_POOLS.baseTypes[category]);let prefix=pick(ITEM_POOLS.prefixes[rarity]);let modifier=pick(ITEM_POOLS.modifiers[category]);let name=prefix+' '+bt.label+' of '+modifier;if(chance(RARITY[rarity].suffixChance)){name+=' '+pick(ITEM_POOLS.suffixes[category])}let effects=generateEquipEffects(category,tier,rarity);let emoji=artEmoji(name);return{id:'art-'+state.artifacts.length,label:emoji+' '+name,forRole:bt.roles[0],effects:effects,tier:tier,rarity:rarity,category:category,found:false,equippedTo:null}}

// AUDIO SYSTEM
let audioCtx=null;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}
function playSound(type){try{let ctx=getAudioCtx();let t=ctx.currentTime;if(type==='pop'){let o=ctx.createOscillator();let g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(660,t);o.frequency.exponentialRampToValueAtTime(440,t+0.08);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.1);o.start(t);o.stop(t+0.1)}else if(type==='alert'){let o=ctx.createOscillator();let g=ctx.createGain();o.type='sawtooth';o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(220,t);o.frequency.setValueAtTime(180,t+0.15);o.frequency.setValueAtTime(220,t+0.3);g.gain.setValueAtTime(0.06,t);g.gain.linearRampToValueAtTime(0.06,t+0.35);g.gain.exponentialRampToValueAtTime(0.001,t+0.5);o.start(t);o.stop(t+0.5)}else if(type==='treasure'){let freqs=[523,659,784,1047];freqs.forEach((f,i)=>{let o=ctx.createOscillator();let g=ctx.createGain();o.type='sine';o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(f,t+i*0.1);g.gain.setValueAtTime(0,t+i*0.1);g.gain.linearRampToValueAtTime(0.12,t+i*0.1+0.02);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.1+0.3);o.start(t+i*0.1);o.stop(t+i*0.1+0.3)})}else if(type==='injury'){let o=ctx.createOscillator();let g=ctx.createGain();o.type='sine';o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(80,t+0.3);g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.001,t+0.35);o.start(t);o.stop(t+0.35)}else if(type==='victory'){let notes=[349,440,523,698];notes.forEach((f,i)=>{let o=ctx.createOscillator();let g=ctx.createGain();o.type='sawtooth';o.connect(g);g.connect(ctx.destination);let start=t+i*0.13;o.frequency.setValueAtTime(f,start);g.gain.setValueAtTime(0,start);g.gain.linearRampToValueAtTime(0.08,start+0.02);g.gain.linearRampToValueAtTime(0.06,start+0.1);g.gain.exponentialRampToValueAtTime(0.001,start+(i===3?0.5:0.2));o.start(start);o.stop(start+(i===3?0.5:0.2))})}else if(type==='defeat'){let notes=[523,440,349,262];notes.forEach((f,i)=>{let o=ctx.createOscillator();let g=ctx.createGain();o.type='sawtooth';o.connect(g);g.connect(ctx.destination);let start=t+i*0.15;o.frequency.setValueAtTime(f,start);g.gain.setValueAtTime(0,start);g.gain.linearRampToValueAtTime(0.07,start+0.02);g.gain.linearRampToValueAtTime(0.05,start+0.1);g.gain.exponentialRampToValueAtTime(0.001,start+(i===3?0.5:0.22));o.start(start);o.stop(start+(i===3?0.5:0.22))})}else if(type==='mist'){let buf=ctx.createBuffer(1,ctx.sampleRate*3.6,ctx.sampleRate);let data=buf.getChannelData(0);for(let i=0;i<data.length;i++){data[i]=(Math.random()*2-1)*Math.sin(i/data.length*Math.PI)}let src=ctx.createBufferSource();src.buffer=buf;let bp=ctx.createBiquadFilter();bp.type='bandpass';bp.frequency.setValueAtTime(600,t);bp.frequency.linearRampToValueAtTime(200,t+3.0);bp.Q.value=1.5;let g=ctx.createGain();src.connect(bp);bp.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(0.1,t+0.6);g.gain.linearRampToValueAtTime(0.08,t+2.1);g.gain.exponentialRampToValueAtTime(0.001,t+3.6);src.start(t);src.stop(t+3.6)}else if(type==='death'){let o=ctx.createOscillator();let g=ctx.createGain();o.type='sine';o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(440,t);o.frequency.exponentialRampToValueAtTime(110,t+0.8);g.gain.setValueAtTime(0.12,t);g.gain.linearRampToValueAtTime(0.1,t+0.3);g.gain.exponentialRampToValueAtTime(0.001,t+0.9);o.start(t);o.stop(t+0.9)}else if(type==='arrival'){let freqs=[330,440,554];freqs.forEach((f,i)=>{let o=ctx.createOscillator();let g=ctx.createGain();o.type='triangle';o.connect(g);g.connect(ctx.destination);o.frequency.setValueAtTime(f,t+i*0.12);g.gain.setValueAtTime(0,t+i*0.12);g.gain.linearRampToValueAtTime(0.13,t+i*0.12+0.03);g.gain.exponentialRampToValueAtTime(0.001,t+i*0.12+0.35);o.start(t+i*0.12);o.stop(t+i*0.12+0.35)})}}catch(e){}}
let lastTabStates={};

const STARTING_PEOPLE=[
{id:1,name:'Sister Agatha',role:'priest',assignment:'perimeter',traits:{spirit:3,body:2,mind:2},exp:6,status:'active',completedTraining:['priest']},
{id:2,name:'Brother Ivan',role:'priest',assignment:'perimeter',traits:{spirit:2,body:2,mind:2},exp:4,status:'active',completedTraining:['priest']},
{id:3,name:'Sister Maren',role:'priest',assignment:'perimeter',traits:{spirit:3,body:1,mind:2},exp:3,status:'active',completedTraining:['priest']},
{id:4,name:'Brother Aldric',role:'priest',assignment:'perimeter',traits:{spirit:2,body:2,mind:1},exp:1,status:'active',completedTraining:['priest']},
{id:5,name:'Brother Marcus',role:'mistwalker',assignment:'available',traits:{spirit:3,body:3,mind:2},exp:5,status:'active',completedTraining:['priest','fighter','mistwalker']},
{id:6,name:'Petra',role:'scholar',assignment:'available',traits:{spirit:1,body:1,mind:3},exp:4,status:'active',completedTraining:['scholar']},
{id:7,name:'Thomas',role:'fighter',assignment:'garrison',traits:{spirit:1,body:3,mind:1},exp:3,status:'active',completedTraining:['fighter']},
{id:8,name:'Cassius',role:'fighter',assignment:'garrison',traits:{spirit:1,body:3,mind:2},exp:4,status:'active',completedTraining:['fighter']},
{id:9,name:'Elena',role:'fighter',assignment:'garrison',traits:{spirit:2,body:2,mind:2},exp:2,status:'active',completedTraining:['fighter']},
{id:10,name:'Hilde',role:'worker',assignment:'farms',traits:{spirit:1,body:2,mind:2},exp:5,status:'active',completedTraining:['worker']},
{id:11,name:'Oren',role:'worker',assignment:'farms',traits:{spirit:1,body:2,mind:3},exp:3,status:'active',completedTraining:['worker']},
{id:12,name:'Bram',role:'worker',assignment:'farms',traits:{spirit:1,body:3,mind:1},exp:4,status:'active',completedTraining:['worker']},
{id:13,name:'Lily',role:'worker',assignment:'farms',traits:{spirit:2,body:1,mind:2},exp:2,status:'active',completedTraining:['worker']},
{id:14,name:'Jonas',role:'worker',assignment:'farms',traits:{spirit:1,body:2,mind:1},exp:3,status:'active',completedTraining:['worker']},
{id:15,name:'Ruth',role:'worker',assignment:'farms',traits:{spirit:1,body:2,mind:2},exp:2,status:'active',completedTraining:['worker']},
{id:16,name:'Maria',role:'unassigned',assignment:'none',traits:{spirit:3,body:1,mind:2},exp:0,status:'active',completedTraining:[]},
{id:17,name:'Cedric',role:'unassigned',assignment:'none',traits:{spirit:1,body:3,mind:1},exp:0,status:'active',completedTraining:[]},
{id:18,name:'Nadia',role:'engineer',assignment:'available',traits:{spirit:2,body:2,mind:3},exp:3,status:'active',completedTraining:['engineer']},
{id:19,name:'Felix',role:'unassigned',assignment:'none',traits:{spirit:1,body:2,mind:2},exp:0,status:'active',completedTraining:[]},
{id:20,name:'Greta',role:'unassigned',assignment:'none',traits:{spirit:2,body:1,mind:2},exp:0,status:'active',completedTraining:[]},
];

let state={};
function initState(){state={day:1,food:CONFIG.startingFood,attention:0,maxDistanceTraveled:0,people:JSON.parse(JSON.stringify(STARTING_PEOPLE)),messages:[],expeditions:[],mistExplorations:[],threats:[],training:[],activeResearch:[],activeBuild:null,activeDig:null,builtSystems:[],equippedArtifacts:{},locations:[],discoveries:[],artifacts:[],creatures:[],buildables:[],digLevels:[],exploredLocations:[],foundDiscoveries:[],studiedDiscoveries:[],foundArtifacts:[],knownWeaknesses:[],knownCreatures:[],compounds:0,traps:0,carcasses:0,wood:0,metal:0,salvageRuns:[],maxDepthEntered:'none',seenDiscoveries:[],seenClues:[],seenArtifacts:[],clues:[],activeDeciphering:[],pendingClues:[],decipheredClues:{locations:{},final:{shallows:0,greyreach:0,deep:0}},nextClueId:0,flags:{},nextId:21,gameOver:false,knownHerbs:[],herbSupply:{},knownRecipes:[],consumables:[]};generateContent();}

function revealCreature(crId){if(!state.knownCreatures.includes(crId))state.knownCreatures.push(crId)}
function creatureKnown(crId){return state.knownCreatures.includes(crId)}
function alive(){return state.people.filter(p=>p.status!=='dead')}
function combat_ready(){return alive().filter(p=>p.status!=='injured'&&p.status!=='training'&&p.status!=='expedition'&&p.status!=='lost'&&p.status!=='rescuing')}
function byRole(r){return alive().filter(p=>p.role===r)}
function getPerson(id){return state.people.find(p=>p.id===id)}
function rand(n){return Math.floor(Math.random()*n)}
function pick(arr){return arr[rand(arr.length)]}
function chance(pct){return Math.random()*100<pct}
function pluralize(name,count){if(count<=1)return name;if(name.startsWith('The '))return name;return name+'s'}
function addMessage(cat,text,actions,clickAction){state.messages.push({day:state.day,category:cat,text:text,actions:actions||[],clickAction:clickAction||null,id:Date.now()+Math.random(),sound:null})}
function tagLastSound(type){let m=state.messages[state.messages.length-1];if(m)m.sound=type}
let feedStaggering=false;let feedStaggerTimer=null;let feedRevealIdx=0;let feedDayMsgStart=0;
function mc(type,id){return{type:type,id:id}}
function handleFeedClick(idx){let fMsgs=feedFilteredMsgs();let m=fMsgs[idx];if(!m||!m.clickAction)return;let ca=m.clickAction;if(ca.type==='person'){let p=getPerson(ca.id);if(p)showPersonModal(ca.id)}else if(ca.type==='tab'){switchTab(ca.id)}else if(ca.type==='threat'){switchTab('dashboard')}}
let feedFilterTypes=['all','alert','combat','event','expedition','research','training','system','dig','perimeter'];
let feedFilterIdx=0;
let feedFilterColors={all:'var(--text-muted)',alert:'var(--danger-light)',combat:'#aa4444',event:'var(--accent)',expedition:'var(--expedition-light)',research:'var(--warning-light)',training:'#6aaa8a',system:'var(--success-light)',dig:'#7a6a5a',perimeter:'var(--info-light)'};
function toggleFeedDropdown(){let dd=document.getElementById('feed-dropdown');if(!dd)return;if(dd.style.display==='none'){let html='';for(let i=0;i<feedFilterTypes.length;i++){let ft=feedFilterTypes[i];let label=ft==='all'?'All':ft.charAt(0).toUpperCase()+ft.slice(1);html+='<div onclick="feedFilterIdx='+i+';renderFeed();toggleFeedDropdown()" style="padding:5px 14px;cursor:pointer;font-size:0.75rem;letter-spacing:1px;text-transform:uppercase;color:'+(feedFilterColors[ft]||'var(--text-muted)')+(i===feedFilterIdx?';font-weight:bold':'')+'">'+label+'</div>'}dd.innerHTML=html;dd.style.display='block'}else{dd.style.display='none'}}
function feedFilteredMsgs(){let src=feedStaggering?state.messages.slice(0,feedRevealIdx):[...state.messages];let msgs=src.reverse();if(feedFilterTypes[feedFilterIdx]==='all')return msgs;return msgs.filter(m=>m.category===feedFilterTypes[feedFilterIdx])}
function roleLabel(r){return{priest:'Priest',fighter:'Fighter',worker:'Worker',mistwalker:'Mistwalker',mystic:'Mystic',scholar:'Scholar',engineer:'Engineer',alchemist:'Alchemist',unassigned:'Unassigned',training:'Training'}[r]||r}
function personTag(p){let l=p.exp>=5?'vet':p.exp>=3?'exp':p.exp>=1?'trn':'nov';return p.name+' ['+roleLabel(p.role)+', '+l+']'}

function getPersonStats(p){
  let b=JSON.parse(JSON.stringify(CONFIG.baseStats[p.role]||{}));
  let eb=Math.floor(p.exp/3);
  if(p.role==='fighter'){b.attack=(b.attack||0)+eb;b.defense=(b.defense||0)+Math.floor(eb/2)}
  if(p.role==='priest'){b.endurance=p.traits.spirit+Math.floor(p.exp/5)}
  if(p.role==='scholar'){b.researchSpeed=(b.researchSpeed||0)+eb*0.15}
  if(p.role==='mistwalker'){b.attack=(b.attack||0)+eb;b.defense=(b.defense||0)+Math.floor(eb/2);b.mistEndurance=p.traits.spirit+Math.floor(p.exp/5)}
  if(p.role==='engineer'){b.buildSpeed=(b.buildSpeed||0)+eb*0.15;b.digSpeed=(b.digSpeed||0)+eb*0.15}
  if(p.role==='mystic'){b.attack=(b.attack||0)+eb;b.defense=(b.defense||0)+Math.floor(eb/2)}
  if(p.role==='worker'){let rb=p.traits.body*0.25;b.yield=(b.yield||0)+Math.floor(eb/2);b.chopRate=(b.chopRate||1)+Math.floor(eb/3)+rb;b.digSpeed=(b.digSpeed||0.5)+eb*0.1+rb}
  if(p.role==='alchemist'){b.brewSpeed=(b.brewSpeed||0)+eb*0.15;b.insight=(b.insight||0)+eb*0.1}
  if(b.attack!==undefined)b.attack+=Math.max(0,p.traits.body-1);
  if(b.defense!==undefined)b.defense+=Math.max(0,p.traits.body-1);
  if(b.researchSpeed!==undefined)b.researchSpeed+=(p.traits.mind-1)*0.2;
  if(b.buildSpeed!==undefined)b.buildSpeed+=(p.traits.mind-1)*0.2;
  if(b.digSpeed!==undefined)b.digSpeed+=(p.traits.mind-1)*0.2;
  if(b.yield!==undefined)b.yield+=Math.max(0,p.traits.body-1);
  if(b.shields!==undefined)b.shields+=Math.max(0,p.traits.spirit-1);
  if(b.brewSpeed!==undefined)b.brewSpeed+=(p.traits.spirit-1)*0.15;
  let eq=state.equippedArtifacts[p.id]||[];
  for(let aId of eq){let art=state.artifacts.find(a=>a.id===aId);if(art)for(let[k,v]of Object.entries(art.effects))if(b[k]!==undefined)b[k]+=v;}
  for(let k in b)if(typeof b[k]==='number')b[k]=Math.round(b[k]*100)/100;
  return b;
}

// PROCEDURAL GENERATION
function pickNames(pool,count){let a=[...pool];for(let i=a.length-1;i>0;i--){let j=rand(i+1);[a[i],a[j]]=[a[j],a[i]]}return a.slice(0,count)}
function generateContent(){generateLocations();generateCreatures();generateDiscoveries();generateArtifacts();generateBuildables();generateDigLevels();linkContent();generateClues()}

function generateLocations(){
  state.locations=[];let idx=0;
  let tiers=[{t:1,count:3,dMin:1,dMax:3},{t:2,count:3,dMin:4,dMax:6},{t:3,count:3,dMin:7,dMax:9}];
  let names=pickNames(NAMES.locations,10);
  for(let spec of tiers){for(let i=0;i<spec.count;i++){let dist=spec.dMin+rand(spec.dMax-spec.dMin+1);let descTier=dist<=3?0:dist<=6?1:2;state.locations.push({id:'loc-'+idx,label:names[idx],tier:spec.t,distance:dist,risk:10+spec.t*15+rand(10),desc:pick(FLAVOR.locDesc[descTier]),yields:[],artifactId:null,prereq:null,explored:false,revealed:false,scouted:false,luckyFind:false});idx++}}
  state.locations.push({id:'loc-9',label:'The Source of the Mist',tier:4,distance:9,risk:90,desc:'The wound in the world. The mist pours from it endlessly. Whatever opened this gate still dwells within.',yields:[],artifactId:null,prereq:null,explored:false,revealed:false,scouted:false,luckyFind:false});
}
function generateClues(){
  state.clues=[];state.nextClueId=0;
  let tierMap={1:'shallows',2:'greyreach',3:'deep'};
  let locPool=[...NAMES.clueTextsLocation];let finPool=[...NAMES.clueTextsFinal];
  function pickUnique(pool,src){if(pool.length===0){pool.push(...src);for(let i=pool.length-1;i>0;i--){let j=rand(i+1);[pool[i],pool[j]]=[pool[j],pool[i]]}}let idx=rand(pool.length);return pool.splice(idx,1)[0]}
  for(let t=1;t<=3;t++){let tier=tierMap[t];let tierLocs=state.locations.filter(l=>l.tier===t);
  for(let loc of tierLocs){for(let i=0;i<3;i++){state.clues.push({id:'clue-'+state.nextClueId++,tier:tier,type:'location',targetId:loc.id,targetLabel:loc.label,label:pickUnique(locPool,NAMES.clueTextsLocation),found:false,deciphered:false})}
  state.clues.push({id:'clue-'+state.nextClueId++,tier:tier,type:'final',targetId:loc.id,targetLabel:'The Source',label:pickUnique(finPool,NAMES.clueTextsFinal),found:false,deciphered:false})}}
}
function generateCreatures(){
  state.creatures=[];
  // Tier 1: Physical only (3-4 creatures)
  // Tier 2: Physical (stronger) + Corrupted (2-3 total)
  // Tier 3: Physical (strongest) + Corrupted + Spiritual (3-4 total)
  let specs=[];
  // Tier 1: 3-4 physical
  let t1Count=3+rand(2);
  for(let i=0;i<t1Count;i++)specs.push({cat:'physical',tier:1});
  // Tier 2: physical + corrupted (2-3 total)
  let t2Count=2+rand(2);
  for(let i=0;i<t2Count;i++)specs.push({cat:i<Math.ceil(t2Count/2)?'physical':'corrupted',tier:2});
  // Tier 3: physical + corrupted + spiritual (3-4 total)
  let t3Count=3+rand(2);
  for(let i=0;i<t3Count;i++){let idx=i%3;let cat=idx===0?'physical':idx===1?'corrupted':'spiritual';specs.push({cat:cat,tier:3});}
  let catPools={physical:NAMES.creaturesPhysical,spiritual:NAMES.creaturesSpiritual,corrupted:NAMES.creaturesCorrupted};
  let catCounts={physical:specs.filter(s=>s.cat==='physical').length,spiritual:specs.filter(s=>s.cat==='spiritual').length,corrupted:specs.filter(s=>s.cat==='corrupted').length};
  let catNames={physical:pickNames(catPools.physical,catCounts.physical),spiritual:pickNames(catPools.spiritual,catCounts.spiritual),corrupted:pickNames(catPools.corrupted,catCounts.corrupted)};
  let ci={physical:0,spiritual:0,corrupted:0};
  for(let i=0;i<specs.length;i++){let s=specs[i];let tier=s.tier;let name=catNames[s.cat][ci[s.cat]++];
  state.creatures.push({id:'crt-'+i,label:name,category:s.cat,tier:tier,attack:2+tier+rand(3),defense:1+tier+rand(3),packMin:1+tier,packMax:2+tier*2,weaknessDiscovery:null,weaknessBonus:2+rand(3),lootArtifact:null,locationIds:[]});}
}
function generateDiscoveries(){
  state.discoveries=[];let idx=0;
  // Lore types and their tier weights: [t1weight, t2weight, t3weight]
  let loreTypes=[{type:'buff',w:[40,25,20]},{type:'statBoost',w:[15,15,15]},{type:'creatureIntel',w:[15,15,10]},{type:'trainingShortcut',w:[5,10,10]},{type:'eventModifier',w:[5,10,10]},{type:'oneTimeEffect',w:[0,5,15]},{type:'herbUnlock',w:[15,10,10]},{type:'recipeUnlock',w:[5,10,10]}];
  let tierSt=[function(){return 3+rand(3)},function(){return 5+rand(4)},function(){return 8+rand(5)}];
  for(let t=1;t<=3;t++){let count=6+rand(2);let weights=loreTypes.map(lt=>lt.w[t-1]);let totalW=weights.reduce((s,w)=>s+w,0);
  for(let i=0;i<count;i++){let roll=rand(totalW);let cum=0;let chosenType='buff';for(let j=0;j<loreTypes.length;j++){cum+=weights[j];if(roll<cum){chosenType=loreTypes[j].type;break}}
  let label=generateLoreName(chosenType);let st=tierSt[t-1]();
  // All discoveries start as type='buff', unlocksId=null so linkContent() can claim them for buildable/weakness/detection.
  // New lore types are tagged with _loreType metadata; linkContent() converts remaining buffs after claiming what it needs.
  let _loreType=null;let _loreUnlocksId=null;let _loreUnlockLabel='';
  if(chosenType==='statBoost'){let stats=['spirit','body','mind'];let s=pick(stats);_loreType='statBoost';_loreUnlocksId='stat-'+s;_loreUnlockLabel='+1 '+s+' (choose person)'}
  else if(chosenType==='trainingShortcut'){let roles=['fighter','priest','scholar','engineer','worker'];let r=pick(roles);_loreType='trainingShortcut';_loreUnlocksId='train-'+r;_loreUnlockLabel='-2d '+r+' training'}
  else if(chosenType==='eventModifier'){let mods=['mistProtection','survivorChance','foodSpoilage'];let m=pick(mods);_loreType='eventModifier';_loreUnlocksId='event-'+m;_loreUnlockLabel='Passive: improved '+m.replace(/([A-Z])/g,' $1').toLowerCase()}
  else if(chosenType==='oneTimeEffect'){let fx=['repelAttack','healAll','foodSurge','revealAllLocations'];let f=pick(fx);_loreType='oneTimeEffect';_loreUnlocksId='once-'+f;_loreUnlockLabel='One-time: '+f.replace(/([A-Z])/g,' $1').toLowerCase()}
  else if(chosenType==='herbUnlock'){let hName=generateHerbName();label='Herbology: '+hName;_loreType='herbUnlock';_loreUnlocksId='herb-'+hName.replace(/\s/g,'-').toLowerCase();_loreUnlockLabel='Unlock herb: '+hName}
  else if(chosenType==='recipeUnlock'){let rName=generateRecipeName();label='Recipe: '+rName;_loreType='recipeUnlock';_loreUnlocksId='recipe-'+rName.replace(/\s/g,'-').toLowerCase();_loreUnlockLabel='Unlock recipe: '+rName}
  state.discoveries.push({id:'disc-'+idx,label:label,studyTime:st,tier:t,type:'buff',unlocksId:null,unlockLabel:'',sourceType:null,sourceId:null,found:false,studied:false,_loreType:_loreType,_loreUnlocksId:_loreUnlocksId,_loreUnlockLabel:_loreUnlockLabel});idx++}}
}
function artEmoji(l){l=l.toLowerCase();if(/blade|dagger|edge|glaive|sword|tooth/.test(l))return'🗡️';if(/shield|buckler|aegis|ward/.test(l))return'🛡️';if(/staff|rod/.test(l))return'🪄';if(/ring|pendant|amulet|bracers|chain|seal|tether/.test(l))return'💎';if(/helm|crown/.test(l))return'👑';if(/tome|codex/.test(l))return'📜';if(/torch|lantern|candle/.test(l))return'🔥';if(/cloak|mantle|gloves|gauntlet/.test(l))return'🧤';if(/vial/.test(l))return'⚗️';if(/bell/.test(l))return'🔔';if(/horn/.test(l))return'📯';if(/bow/.test(l))return'🏹';if(/mace|hammer/.test(l))return'🔨';if(/compass/.test(l))return'🧭';if(/spear/.test(l))return'🔱';if(/key/.test(l))return'🔑';if(/eye/.test(l))return'👁️';if(/star/.test(l))return'⭐';if(/plate|armor/.test(l))return'⚔️';return'✨'}
function generateArtifacts(){
  state.artifacts=[];let tierCfg=[{tier:1,count:4+rand(2)},{tier:2,count:4+rand(2)},{tier:3,count:3+rand(2)}];
  for(let tc of tierCfg){let ci=0;for(let i=0;i<tc.count;i++){let cat=ITEM_POOLS.categories[ci%ITEM_POOLS.categories.length];let rarity=rollRarity('daily');state.artifacts.push(generateEquipment(tc.tier,rarity,cat));ci++}}
}
function generateBuildableName(effect){
  let bases={defense:['Watchtower','Palisade','Barricade','Guard Post','Rampart','Bulwark','Battlement','Stockade'],food:['Granary','Irrigation','Root Cellar','Greenhouse','Seed Vault','Mill House','Smokehouse','Compost Works'],perimeter:['Ward Stone','Prayer Sanctum','Bell Tower','Reliquary','Meditation Cell','Vestment Hall','Consecrated Pillar','Shrine'],research:['Library','Observatory','Archival Chamber','Study Hall','Scriptorium','Astrolabe Tower','Chronicle Vault','Sage Hall'],range:['Beacon','Signal Tower','Lookout Platform','Spire','Lighthouse','Vantage Point','Signal Pyre','Watch Spire']};
  let mods={defense:['of Iron','of Stone','of the Watch','of Shelter','of the Keep','of Steadfast Walls','of the Garrison'],food:['of Plenty','of Harvest','of Growth','of Abundance','of Nourishment','of the Fertile Earth','of Bounty'],perimeter:['of Warding','of Grace','of Sanctity','of the Faithful','of Radiance','of the Covenant','of Blessed Ground'],research:['of Insight','of the Ancients','of Deep Thought','of Revelation','of Knowing','of the Learned','of Discovery'],range:['of Far Sight','of the Horizon','of Vigilance','of Clarity','of the Mist Edge','of Long Reach','of the Watchers']};
  let b=bases[effect]||bases.defense;let m=mods[effect]||mods.defense;return pick(b)+' '+pick(m);
}
function generateBuildables(){
  state.buildables=[];
  let tpl=[{effect:'defense',label:'+1 global defense',mag:1,wood:5,metal:0},{effect:'food',label:'+1 worker yield',mag:1,wood:5,metal:0},{effect:'perimeter',label:'+1 priest endurance',mag:1,wood:5,metal:0},{effect:'research',label:'+0.25 research speed',mag:0.25,wood:8,metal:3},{effect:'defense',label:'+2 global defense',mag:2,wood:8,metal:3},{effect:'food',label:'+2 worker yield',mag:2,wood:12,metal:6},{effect:'range',label:'+2 mist endurance',mag:2,wood:12,metal:6}];
  let usedNames=new Set();
  for(let i=0;i<tpl.length;i++){let t=tpl[i];let name;do{name=generateBuildableName(t.effect)}while(usedNames.has(name));usedNames.add(name);let wVar=Math.floor(t.wood*(0.8+Math.random()*0.4));let mVar=Math.floor(t.metal*(0.8+Math.random()*0.4));state.buildables.push({id:'bld-'+i,label:name,buildTime:3+i+rand(3),reqDiscovery:null,effect:t.effect,effectLabel:t.label,magnitude:t.mag,woodCost:wVar||t.wood,metalCost:mVar||t.metal,built:false});}
}
function generateDigLevels(){
  state.digLevels=[];
  for(let d=1;d<=4;d++)state.digLevels.push({id:'dig-'+d,label:d<=NAMES.digLevels.length?NAMES.digLevels[d-1]:'Depth '+d,depth:d,laborDays:8+d*6+rand(4),scholarsNeeded:Math.min(d,3),yields:[],cleared:false});
}
function addDigLevel(){let d=state.digLevels.length+1;let discIdx=state.discoveries.length;let tier=Math.min(3,Math.floor(d/2)+1);let label=generateLoreName('buff');let st=[6+rand(4),9+rand(5),12+rand(6)][tier-1];let disc={id:'disc-'+discIdx,label:label,studyTime:st,tier:tier,type:'buff',unlocksId:null,unlockLabel:'',sourceType:'dig',sourceId:'dig-'+d,found:false,studied:false};let buffTypes=[{label:'+1 fighter attack',id:'buff-fighter-attack'},{label:'+1 priest endurance',id:'buff-priest-end'},{label:'+1 mist endurance',id:'buff-mw-end'},{label:'+1 worker yield',id:'buff-worker-yield'},{label:'+1 global defense',id:'buff-defense'}];if(chance(30)&&state.buildables.length<20){let effects=[{effect:'defense',label:'+1 global defense',mag:1},{effect:'food',label:'+1 worker yield',mag:1},{effect:'range',label:'+1 mist endurance',mag:1},{effect:'perimeter',label:'+1 priest endurance',mag:1}];let eff=pick(effects);let bName=generateBuildableName(eff.effect);let wCost=5+d*2;let mCost=d>=3?3+d:0;let bld={id:'bld-'+state.buildables.length,label:bName,buildTime:4+d+rand(3),reqDiscovery:disc.id,effect:eff.effect,effectLabel:eff.label,magnitude:eff.mag,woodCost:wCost,metalCost:mCost,built:false};state.buildables.push(bld);disc.type='buildable';disc.unlocksId=bld.id;disc.unlockLabel=bld.label+' ('+bld.effectLabel+')'}else{let bt=buffTypes[d%buffTypes.length];disc.type='buff';disc.unlocksId=bt.id;disc.unlockLabel=bt.label}state.discoveries.push(disc);let lv={id:'dig-'+d,label:d<=NAMES.digLevels.length?NAMES.digLevels[d-1]:'Depth '+d,depth:d,laborDays:8+d*6+rand(4),scholarsNeeded:Math.min(d,3),yields:[disc.id],cleared:false};state.digLevels.push(lv)}

function linkContent(){
  let disc=state.discoveries,locs=state.locations,arts=state.artifacts,blds=state.buildables,crts=state.creatures,digs=state.digLevels;
  function shuffle(a){for(let i=a.length-1;i>0;i--){let j=rand(i+1);[a[i],a[j]]=[a[j],a[i]]}return a}
  function locTier(l){return l.tier||( l.distance<=3?1:l.distance<=6?2:3)}
  function crtTier(c,i){return Math.floor((i/crts.length)*3)+1}
  // Assign discovery types — buildables spread across tiers (round-robin 1,2,3)
  for(let bi=0;bi<blds.length;bi++){let targetTier=(bi%3)+1;let d=disc.find(x=>x.tier===targetTier&&x.unlocksId===null);if(!d)d=disc.find(x=>x.unlocksId===null);if(d){d.type='buildable';d.unlocksId=blds[bi].id;d.unlockLabel=blds[bi].label+' ('+blds[bi].effectLabel+')';blds[bi].reqDiscovery=d.id}}
  for(let c of crts){let d=disc.find(x=>x.unlocksId===null);if(d){d.type='weakness';d.unlocksId=c.id;d.unlockLabel=c.label+' weakness (-'+c.weaknessBonus+' def)';c.weaknessDiscovery=d.id}}
  // Convert remaining tagged discoveries to their desired lore types (ones not claimed by buildable/weakness)
  for(let d of disc){if(d.unlocksId===null&&d._loreType){d.type=d._loreType;d.unlocksId=d._loreUnlocksId;d.unlockLabel=d._loreUnlockLabel}}
  for(let d of disc){delete d._loreType;delete d._loreUnlocksId;delete d._loreUnlockLabel}
  let buffTypes=[{label:'+1 fighter attack',id:'buff-fighter-attack'},{label:'+1 priest endurance',id:'buff-priest-end'},{label:'+1 mist endurance',id:'buff-mw-end'},{label:'+1 worker yield',id:'buff-worker-yield'}];
  let bfi=0;for(let d of disc){if(d.unlocksId===null){let bt=buffTypes[bfi%buffTypes.length];d.unlocksId=bt.id;d.unlockLabel=bt.label;bfi++}}
  // Assign discoveries to locations by matching tier to distance
  shuffle(disc);
  let discByTier={1:disc.filter(d=>d.tier===1),2:disc.filter(d=>d.tier===2),3:disc.filter(d=>d.tier===3)};
  let locsByTier={1:locs.filter(l=>l.tier===1),2:locs.filter(l=>l.tier===2),3:locs.filter(l=>l.tier===3)};
  // Distribute ~65% to locations, rest to dig
  for(let t=1;t<=3;t++){let td=discByTier[t]||[];let tl=locsByTier[t]||[];let locCount=Math.ceil(td.length*0.65);for(let i=0;i<locCount&&i<td.length;i++){let loc=tl.length>0?tl[i%tl.length]:locs[i%locs.length];td[i].sourceType='location';td[i].sourceId=loc.id;loc.yields.push(td[i].id)}}
  // Assign remaining discoveries to digs (escalating tier per depth)
  let unassigned=disc.filter(d=>!d.sourceType);let digI=0;
  for(let i=0;i<unassigned.length;i++){if(digI<digs.length){unassigned[i].sourceType='dig';unassigned[i].sourceId=digs[digI].id;digs[digI].yields.push(unassigned[i].id);digI++}else{let loc=locs[i%locs.length];unassigned[i].sourceType='location';unassigned[i].sourceId=loc.id;loc.yields.push(unassigned[i].id)}}
  // Assign artifacts to locations and creatures by tier
  let artsByTier={1:arts.filter(a=>a.tier===1),2:arts.filter(a=>a.tier===2),3:arts.filter(a=>a.tier===3)};
  for(let t=1;t<=3;t++){let ta=artsByTier[t]||[];shuffle(ta);let tl=locsByTier[t]||[];let ai=0;for(let li=0;li<tl.length&&ai<ta.length;li++){tl[li].artifactId=ta[ai].id;ai++}for(;ai<ta.length;ai++){let crtPool=crts.filter((c,ci)=>crtTier(c,ci)===t);if(crtPool.length>0){let c=crtPool[ai%crtPool.length];c.lootArtifact=ta[ai].id}else{crts[ai%crts.length].lootArtifact=ta[ai].id}}}
  // Assign creatures to locations
  for(let ci=0;ci<crts.length;ci++){let c=crts[ci];let ct=crtTier(c,ci);let n=1+rand(2);for(let j=0;j<n;j++){let pool=locs.filter(l=>locTier(l)>=ct);if(pool.length===0)pool=locs;let l=pool[rand(pool.length)];if(!c.locationIds.includes(l.id))c.locationIds.push(l.id)}}
  // Guarantee every location has at least one creature guardian
  for(let loc of locs){let hasCreature=crts.some(c=>c.locationIds.includes(loc.id));if(!hasCreature){let lt=locTier(loc);let pool=crts.filter((c,ci)=>crtTier(c,ci)<=lt);if(pool.length===0)pool=crts;let c=pick(pool);c.locationIds.push(loc.id)}}
  disc.sort((a,b)=>parseInt(a.id.split('-')[1])-parseInt(b.id.split('-')[1]));
  // Guarantee first dig level yields detection upgrade
  if(digs.length>0&&digs[0].yields.length>0){let fd=disc.find(d=>d.id===digs[0].yields[0]);
  if(fd&&fd.type==='buildable'){let swap=disc.find(d=>d.sourceType==='location'&&d.type!=='buildable');if(swap){let oldSrc=swap.sourceId;swap.sourceType='dig';swap.sourceId=digs[0].id;fd.sourceType='location';fd.sourceId=oldSrc;let srcLoc=locs.find(l=>l.id===oldSrc);if(srcLoc){srcLoc.yields=srcLoc.yields.filter(y=>y!==swap.id);srcLoc.yields.push(fd.id)}digs[0].yields=[swap.id];fd=swap}}
  if(fd){fd.type='detection';fd.unlocksId='detection-base';fd.unlockLabel='Threat detection +1 day warning';fd.label='Watcher\'s Sigil Patterns';fd.studyTime=3}}
}

// CORE MECHANICS
function getFoodProduction(){let w=alive().filter(p=>p.assignment==='farms');let t=0;let yb=getGlobalBuff('food');for(let p of w){if(p.role==='worker'){let s=getPersonStats(p);t+=(s.yield||3)+yb}else{t+=2}}return Math.round(t*10)/10}
function getFoodConsumption(){return alive().filter(p=>p.status!=='lost').length*CONFIG.foodPerPerson}
function getPerimeterPriests(){return alive().filter(p=>p.assignment==='perimeter'||p.assignment==='tending').length}
function getPerimeterStability(){let total=0;let priests=alive().filter(p=>p.assignment==='perimeter');for(let p of priests){let s=getPersonStats(p);total+=15+(s.endurance||0)*2}total+=getGlobalBuff('perimeter')*10;return Math.min(100,Math.round(total))}
function getPerimeterBreakdown(){let priests=alive().filter(p=>p.assignment==='perimeter');let detail=[];for(let p of priests){let s=getPersonStats(p);let contrib=15+(s.endurance||0)*2;detail.push({name:p.name,contrib:contrib})}let buff=getGlobalBuff('perimeter')*10;if(buff>0)detail.push({name:'Global Buffs',contrib:buff});return detail}
function getDefenseStrength(){let r=getDefenseBreakdown();return r.total}
function getDefenseBreakdown(){let garr=alive().filter(p=>(p.assignment==='garrison'||p.assignment==='available')&&p.status!=='expedition');let fromGarr=0;let detail=[];for(let p of garr){let s=getPersonStats(p);let d=s.defense||0;if(d===0&&p.assignment==='garrison')d=Math.max(1,p.traits.body);if(d>0){fromGarr+=d;detail.push({name:p.name,role:p.role,defense:d})}}let fromBuffs=getGlobalBuff('defense');if(fromBuffs>0)detail.push({name:'Global Buffs',role:'buff',defense:fromBuffs});let rawTotal=Math.round((fromGarr+fromBuffs)*10)/10;let perimPct=getPerimeterStability();let gap=100-perimPct;let perimScale=perimPct/100;let total=Math.round(rawTotal*perimScale*10)/10;return{total:total,rawTotal:rawTotal,fromGarr:Math.round(fromGarr*10)/10,fromBuffs:fromBuffs,perimPct:perimPct,gap:gap,detail:detail}}
function getTeamAttack(ids){let t=0;for(let id of ids){let p=getPerson(id);if(!p||p.status==='dead')continue;let s=getPersonStats(p);t+=(s.attack||0)}t+=getGlobalBuff('defense');return t}
function getCategoryEffectiveness(role,category){let t={fighter:{physical:1.5,spiritual:0.25,corrupted:0.75},priest:{physical:0.5,spiritual:1.5,corrupted:0.75},mistwalker:{physical:1.0,spiritual:1.0,corrupted:1.25},mystic:{physical:1.0,spiritual:1.25,corrupted:0.75},scholar:{physical:0.25,spiritual:0.5,corrupted:1.25},engineer:{physical:0.5,spiritual:0.25,corrupted:0.5},worker:{physical:0.3,spiritual:0.15,corrupted:0.3},alchemist:{physical:0.4,spiritual:1.0,corrupted:0.8}};return(t[role]&&t[role][category])||0.5}
function getTeamAttackVs(ids,category,opts){opts=opts||{};let t=0;for(let id of ids){let p=getPerson(id);if(!p||p.status==='dead')continue;let s=getPersonStats(p);let atk=s.attack||0;let mult=getCategoryEffectiveness(p.role,category);if(opts.mysticBoost&&category==='spiritual'){mult=Math.max(mult,getCategoryEffectiveness(p.role,'physical'))}if(opts.compoundBoost&&category==='corrupted'){if(p.role==='mistwalker'){mult=mult*1.5}else{mult=Math.max(mult,getCategoryEffectiveness(p.role,'physical'))}}t+=atk*mult}t+=getGlobalBuff('defense');return Math.round(t*10)/10}
function getDefenseStrengthVs(category,opts){let r=getDefenseBreakdownVs(category,opts);return r.total}
function getDefenseBreakdownVs(category,opts){opts=opts||{};let garr=alive().filter(p=>(p.assignment==='garrison'||p.assignment==='available')&&p.status!=='expedition');let fromGarr=0;let detail=[];for(let p of garr){let s=getPersonStats(p);let d=s.defense||0;if(d===0&&p.assignment==='garrison')d=Math.max(1,p.traits.body);let mult=getCategoryEffectiveness(p.role,category);if(opts.mysticBoost&&category==='spiritual'){mult=Math.max(mult,getCategoryEffectiveness(p.role,'physical'))}if(opts.compoundBoost&&category==='corrupted'){if(p.role==='mistwalker'){mult=mult*1.5}else{mult=Math.max(mult,getCategoryEffectiveness(p.role,'physical'))}}let eff=Math.round(d*mult*10)/10;if(eff>0||d>0){fromGarr+=eff;detail.push({name:p.name,role:p.role,defense:eff,raw:d,mult:mult})}}let fromBuffs=getGlobalBuff('defense');if(fromBuffs>0)detail.push({name:'Global Buffs',role:'buff',defense:fromBuffs});let rawTotal=Math.round((fromGarr+fromBuffs)*10)/10;let perimPct=getPerimeterStability();let gap=100-perimPct;let perimScale=perimPct/100;let total=Math.round(rawTotal*perimScale*10)/10;return{total:total,rawTotal:rawTotal,fromGarr:Math.round(fromGarr*10)/10,fromBuffs:fromBuffs,perimPct:perimPct,gap:gap,detail:detail}}
function getCategoryLabel(cat){return{physical:'\u2694\ufe0f physical',spiritual:'\u2728 spiritual',corrupted:'\u26a0 corrupted'}[cat]||cat}
function getEffectivenessSummary(role){let cats=['physical','spiritual','corrupted'];let parts=[];for(let c of cats){let m=getCategoryEffectiveness(role,c);if(m>=1.25)parts.push('Strong vs '+c);else if(m<=0.3)parts.push('Weak vs '+c)}return parts.join(', ')||'Average effectiveness'}
function getMysticInGarrison(){return alive().some(p=>p.role==='mystic'&&(p.assignment==='garrison'||p.assignment==='available')&&p.status!=='expedition'&&p.status!=='injured')}
function getMysticInParty(ids){return ids.some(id=>{let p=getPerson(id);return p&&p.status!=='dead'&&p.role==='mystic'})}
function getTeamDefense(ids){let t=0;for(let id of ids){let p=getPerson(id);if(!p||p.status==='dead')continue;let s=getPersonStats(p);t+=(s.defense||0)}return t}
function getMistWalkerRange(pid){let p=getPerson(pid);if(!p)return 0;let s=getPersonStats(p);return(s.mistEndurance||0)+getGlobalBuff('range')}
function getDetectionRange(){let base=3;let digBonus=state.digLevels.filter(l=>l.cleared).length;return base+digBonus}
function getGlobalBuff(type){let t=0;for(let bId of state.builtSystems){let b=state.buildables.find(x=>x.id===bId);if(b&&b.effect===type)t+=b.magnitude}for(let dId of state.studiedDiscoveries){let d=state.discoveries.find(x=>x.id===dId);if(d&&d.type==='buff'){if(type==='defense'&&d.unlocksId==='buff-fighter-attack')t+=1;if(type==='perimeter'&&d.unlocksId==='buff-priest-end')t+=1;if(type==='range'&&d.unlocksId==='buff-mw-end')t+=1;if(type==='food'&&d.unlocksId==='buff-worker-yield')t+=1}}return t}

// INJURY & CASUALTY SYSTEM
function injure(p,days,cause){p.status='injured';p.assignment='resting';p.injuryDays=days;p.injuryStartDay=state.day;addMessage('combat',p.name+' ('+roleLabel(p.role)+') injured: '+cause+'. Recovery: '+days+'d.',[],mc('person',p.id));tagLastSound('injury')}
function killPerson(p,cause){p.status='dead';p.assignment='none';p.deathDay=state.day;addMessage('alert',p.name+' ('+roleLabel(p.role)+') killed'+( cause?': '+cause:'')+'.',[],mc('person',p.id));tagLastSound('death')}
function recoverArtifacts(pid){let arts=(state.equippedArtifacts[pid]||[]).slice();if(arts.length===0)return;for(let aId of arts){let a=state.artifacts.find(x=>x.id===aId);if(a){a.equippedTo=null;addMessage('event',a.label+' recovered from the fallen.',[],mc('person',pid))}}state.equippedArtifacts[pid]=[]}
function pickCasualty(pool){
  // Priority: fighters/garrison first, then workers, then others. Higher defense = more frontline
  let pri=pool.map(p=>{let w=0;if(p.assignment==='garrison')w+=10;if(p.role==='fighter'||p.role==='mistwalker'||p.role==='mystic')w+=5;if(p.assignment==='farms')w+=3;if(p.role==='worker')w+=2;if(p.role==='priest'&&p.assignment==='perimeter')w+=1;return{p:p,w:w}});
  pri.sort((a,b)=>b.w-a.w);
  // Weighted random favoring frontline: top half gets 3x weight
  let half=Math.max(1,Math.ceil(pri.length/2));
  let weighted=[];for(let i=0;i<pri.length;i++){let mult=i<half?3:1;for(let j=0;j<mult;j++)weighted.push(pri[i].p)}
  return pick(weighted);
}
function processInjuries(){let injured=alive().filter(p=>p.status==='injured');let priestsNeeded=injured.length>0?Math.ceil(injured.length/5):0;let tending=alive().filter(p=>p.role==='priest'&&p.assignment==='tending');while(tending.length>priestsNeeded){let pr=tending.pop();pr.assignment='perimeter';addMessage('event',pr.name+' returns to the perimeter. All injuries healed.',[],mc('person',pr.id))}if(tending.length<priestsNeeded){let perim=alive().filter(p=>p.role==='priest'&&p.assignment==='perimeter');perim.sort((a,b)=>(getPersonStats(a).endurance||0)-(getPersonStats(b).endurance||0));while(tending.length<priestsNeeded&&perim.length>1){let pr=perim.shift();pr.assignment='tending';tending.push(pr);addMessage('event',pr.name+' leaves the perimeter to tend the injured.',[],mc('person',pr.id))}}let tendCap=tending.length*5;let tc=0;for(let p of injured){if(p.injuryStartDay===state.day)continue;let td=tc<tendCap;if(td)tc++;p.injuryDays-=td?2:1;if(p.injuryDays<=0){p.status='active';p.assignment=getDefaultAssignment(p.role);addMessage('event',p.name+' ('+roleLabel(p.role)+') recovered from injuries.',[],mc('person',p.id))}}let si=alive().filter(p=>p.status==='injured').length;let nn=si>0?Math.ceil(si/5):0;tending=alive().filter(p=>p.role==='priest'&&p.assignment==='tending');while(tending.length>nn){let pr=tending.pop();pr.assignment='perimeter';addMessage('event',pr.name+' returns to the perimeter. All injuries healed.',[],mc('person',pr.id))}}

// SCHOLAR CRAFTING & ENGINEER TRAPPING
function processScholarCrafting(){let crafters=alive().filter(p=>p.role==='scholar'&&p.assignment==='crafting'&&p.status==='active');if(crafters.length===0)return;let canProduce=Math.min(crafters.length,state.carcasses);if(canProduce>0){state.carcasses-=canProduce;state.compounds+=canProduce}for(let s of crafters){s.craftDays=(s.craftDays||0)+1;if(s.craftDays%5===0){s.exp=Math.min(10,s.exp+1)}}if(state.day%3===0&&crafters.length>0){if(canProduce>0){addMessage('event',crafters[0].name+' distills '+canProduce+' compound'+(canProduce>1?'s':'')+' from carcasses. (Carcasses: '+state.carcasses+', Compounds: '+state.compounds+')',[],mc('tab','dashboard'))}else{addMessage('event',crafters[0].name+' has no carcasses to process. Crafting idle.',[],mc('tab','dashboard'))}}}
function processEngineerTrapping(){let trappers=alive().filter(p=>p.role==='engineer'&&p.assignment==='trapping'&&p.status==='active');if(trappers.length===0)return;let built=Math.min(trappers.length,state.wood);if(built>0){state.wood-=built;state.traps+=built}for(let eng of trappers){eng.trapDays=(eng.trapDays||0)+1;if(eng.trapDays%5===0){eng.exp=Math.min(10,eng.exp+1)}}if(state.day%3===0){if(built>0){addMessage('event',trappers[0].name+' rigs defenses. '+built+' trap'+(built>1?'s':'')+' built ('+built+' wood used). Traps: '+state.traps,[],mc('tab','dashboard'))}else{addMessage('event',trappers[0].name+' has no wood for traps. Trapping idle.',[],mc('tab','dashboard'))}}}

function processWoodChopping(){let choppers=alive().filter(p=>p.role==='worker'&&p.assignment==='chopping'&&p.status==='active');if(choppers.length===0)return;let total=0;for(let w of choppers){let s=getPersonStats(w);total+=(s.chopRate||1);w.chopDays=(w.chopDays||0)+1;if(w.chopDays%5===0){w.exp=Math.min(10,w.exp+1)}}state.wood+=total;if(state.day%3===0&&total>0){addMessage('event',choppers[0].name+(choppers.length>1?' and '+(choppers.length-1)+' others':'')+' chopped '+total+' wood. (Total: '+state.wood+')',[],mc('tab','dashboard'))}}
function processHerbCultivation(){if(state.knownHerbs.length===0)return;let gardeners=alive().filter(p=>p.assignment==='herbgarden'&&p.status==='active');if(gardeners.length===0)return;for(let g of gardeners){g.herbDays=(g.herbDays||0)+1;let s=getPersonStats(g);let yieldMod=1+(((s.yield||0)-3)*0.1);if(g.herbDays%2===0){let herb=state.knownHerbs[rand(state.knownHerbs.length)];let amt=Math.max(1,Math.round(yieldMod));state.herbSupply[herb.id]=(state.herbSupply[herb.id]||0)+amt;if(state.day%5===0)addMessage('event',g.name+' harvested '+amt+' '+herb.name+'. (Supply: '+state.herbSupply[herb.id]+')',[],mc('tab','dashboard'))}if(g.herbDays%5===0){g.exp=Math.min(10,g.exp+1)}}}
function processAlchemy(){let brewers=alive().filter(p=>p.role==='alchemist'&&p.assignment==='brewing'&&p.status==='active');for(let b of brewers){if(!b.brewingRecipe){let available=state.knownRecipes.filter(r=>{let canBrew=true;for(let ing of r.ingredients){if((state.herbSupply[ing.herbId]||0)<ing.count)canBrew=false}return canBrew});if(available.length>0){let recipe=available[0];for(let ing of recipe.ingredients)state.herbSupply[ing.herbId]-=ing.count;b.brewingRecipe=recipe.id;b.brewProgress=0}else{if(state.day%5===0)addMessage('event',b.name+' has no herbs to brew with. Idle.',[],mc('tab','people'));continue}}if(b.brewingRecipe){let recipe=state.knownRecipes.find(r=>r.id===b.brewingRecipe);if(!recipe){b.brewingRecipe=null;continue}let st=getPersonStats(b);b.brewProgress=(b.brewProgress||0)+(st.brewSpeed||1);if(b.brewProgress>=recipe.brewTime){state.consumables.push({id:'cons-'+Date.now()+'-'+rand(999),label:recipe.name,effectId:recipe.id,used:false,tier:recipe.tier,effect:recipe.effect});addMessage('event',b.name+' brewed '+recipe.name+'!',[],mc('tab','dashboard'));b.brewingRecipe=null;b.brewProgress=0;b.exp=Math.min(10,b.exp+1)}}}let experimenters=alive().filter(p=>p.role==='alchemist'&&p.assignment==='experimenting'&&p.status==='active');for(let e of experimenters){e.expDays=(e.expDays||0)+1;let st=getPersonStats(e);let discoveryChance=8+(st.insight||0)*2;if(chance(discoveryChance)&&state.knownHerbs.length>0){let rName=generateRecipeName();let herbs=[];let numIngredients=1+rand(2);for(let i=0;i<numIngredients;i++){let herb=state.knownHerbs[rand(state.knownHerbs.length)];herbs.push({herbId:herb.id,count:1+rand(2)})}let recipe={id:'recipe-exp-'+rName.replace(/\s/g,'-').toLowerCase(),name:rName,tier:Math.min(3,1+Math.floor(e.exp/3)),ingredients:herbs,brewTime:3+rand(3),effect:{type:'buff',magnitude:1+rand(2)}};if(!state.knownRecipes.some(r=>r.name===rName)){state.knownRecipes.push(recipe);addMessage('research',e.name+' discovered recipe: '+rName+'!',[],mc('tab','research'));e.exp=Math.min(10,e.exp+1)}}if(e.expDays%5===0){e.exp=Math.min(10,e.exp+1)}}}
function processSalvageRuns(){for(let i=state.salvageRuns.length-1;i>=0;i--){let sr=state.salvageRuns[i];sr.daysOut++;if(sr.daysOut>=sr.duration){let eng=getPerson(sr.engineerId);let loc=state.locations.find(l=>l.id===sr.locationId);let tier=loc?loc.tier||1:1;let metalYield=tier===1?2+rand(3):tier===2?4+rand(4):6+rand(5);state.metal+=metalYield;if(eng&&eng.status!=='dead'){eng.status='active';eng.assignment='available';eng.exp=Math.min(10,eng.exp+1)}addMessage('event',(eng?eng.name:'Engineer')+' returns from salvaging '+(loc?loc.label:'?')+' with '+metalYield+' metal. (Total: '+state.metal+')',[],mc('tab','engineering'));state.salvageRuns.splice(i,1)}}}

// DAY ADVANCEMENT
function advanceDay(){if(state.gameOver||feedStaggering)return;let preMsgCount=state.messages.length;state.day++;state.attention+=CONFIG.baseAttentionPerDay;processScouting();processRescue();processFood();processWoodChopping();processPerimeter();processTraining();processExpeditions();processSalvageRuns();processMistExplorations();processDeciphering();processResearch();processBuild();processDig();processScholarCrafting();processEngineerTrapping();processHerbCultivation();processAlchemy();processThreats();processInjuries();generateEvents();if(!state.gameOver){let dayMsgs=state.messages.filter(m=>m.day===state.day);if(dayMsgs.length===0){let ppl=alive();if(ppl.length>=2){let a=pick(ppl);let b=pick(ppl.filter(p=>p.id!==a.id));addMessage('event',flavorText(FLAVOR.idle,{name:a.name,name2:b.name}))}else if(ppl.length===1){addMessage('event',flavorText(FLAVOR.idle,{name:ppl[0].name,name2:ppl[0].name}))}}let newMsgs=state.messages.length-preMsgCount;if(newMsgs>0&&typeof setTimeout!=='undefined'){feedStaggering=true;feedDayMsgStart=preMsgCount;feedRevealIdx=preMsgCount;renderHeader();renderDashboard();renderPeople();renderExpeditions();renderResearch();renderEngineering();renderArtifacts();updateTabIndicators();renderFeed();let soundDurations={alert:600,treasure:750,victory:950,defeat:1050,injury:400,arrival:650,mist:3700,death:950};function revealNext(){if(feedRevealIdx>=state.messages.length){feedStaggering=false;return}let m=state.messages[feedRevealIdx];if(m.sound)playSound(m.sound);feedRevealIdx++;renderFeed();let fc=document.getElementById('feed-scroll');if(fc)fc.scrollTop=0;if(feedRevealIdx<state.messages.length){let next=state.messages[feedRevealIdx];let delay=m.sound?(soundDurations[m.sound]||500):80;setTimeout(revealNext,delay)}else{feedStaggering=false}}revealNext()}else{render()}}}

function processFood(){let farmers=alive().filter(p=>p.assignment==='farms'&&p.status==='active');for(let f of farmers){f.farmDays=(f.farmDays||0)+1;if(f.farmDays%5===0){f.exp=Math.min(10,f.exp+1)}}let p=getFoodProduction(),c=getFoodConsumption();state.food+=p-c;state.food=Math.round(state.food*10)/10;if(state.food<=0){state.food=0;addMessage('alert','Granary empty. Starvation.',[],mc('tab','dashboard'));let cands=alive().filter(p=>p.role!=='priest');if(cands.length>0){let v=pick(cands);v.status='dead';v.assignment='none';v.deathDay=state.day;recoverArtifacts(v.id);addMessage('alert',personTag(v)+' died of starvation.',[],mc('person',v.id))}if(alive().length<=3)endGame('Starvation.')}else if(state.food<20&&state.day%3===0)addMessage('alert','Food critical: '+Math.round(state.food),[],mc('tab','dashboard'))}

function processPerimeter(){if(getPerimeterPriests()===0)endGame('No priests. Mist pours in.');let perimPriests=alive().filter(p=>p.role==='priest'&&p.assignment==='perimeter'&&p.status==='active');for(let pp of perimPriests){pp.perimDays=(pp.perimDays||0)+1;if(pp.perimDays%5===0){pp.exp=Math.min(10,pp.exp+1)}}let ps=getPerimeterStability();if(ps>=100){if(!state.flags.perimTipDismissed&&state.flags.perimTipShown)state.flags.perimTipDismissed=true;return}let gap=100-ps;let riskPct=gap*0.10;let perimTip='';if(!state.flags.perimTipDismissed){state.flags.perimTipShown=true;perimTip='<br><span style="color:var(--warning-light);font-style:italic">Tip: train or assign more priests to the perimeter.</span>'}let foodLost=0;for(let i=0;i<Math.floor(state.food);i++){if(chance(riskPct))foodLost++}if(foodLost>0){state.food=Math.max(0,state.food-foodLost);addMessage('perimeter','Mist crept through the perimeter. <span style="color:var(--danger-light);font-style:italic">'+foodLost+' food spoiled.</span>'+perimTip,[],mc('tab','dashboard'))}let exposed=alive().filter(p=>p.status==='active'&&(p.assignment==='perimeter'||p.assignment==='farms'||p.assignment==='garrison'));for(let p of exposed){if(chance(riskPct)){let roll=rand(3);if(roll===0){p.status='lost';p.assignment='lost';p.lostDay=state.day;addMessage('alert',p.name+' ('+roleLabel(p.role)+') wandered into the mist. A Mistwalker must find them.',[],mc('person',p.id));tagLastSound('mist')}else if(roll===1){let days=5+rand(6);p.status='injured';p.assignment='resting';p.injuryDays=days;addMessage('perimeter',p.name+' ('+roleLabel(p.role)+') touched by the mist \u2014 madness. Recovery: '+days+'d.',[],mc('person',p.id));tagLastSound('mist')}else{let cr=pick(state.creatures);if(cr){let pDef=(getPersonStats(p).defense||0);if(pDef>=cr.attack){injure(p,3+rand(4),'attacked by '+cr.label+' in the mist')}else{killPerson(p,'killed by '+cr.label+' in the mist');recoverArtifacts(p.id)}}else{injure(p,3+rand(4),'attacked by something in the mist')}}}}let lost=state.people.filter(p=>p.status==='lost');for(let p of lost){if(state.day-p.lostDay>=10){killPerson(p,'lost to the mist \u2014 never found')}}}

function rescueLost(mwId,lostId){let mw=getPerson(mwId);let lp=getPerson(lostId);if(!mw||!lp)return;if(mw.status!=='active'||mw.assignment!=='available'){addMessage('event',mw.name+' is not available to rescue.',[],mc('person',mw.id));render();return}let daysLost=Math.max(1,state.day-(lp.lostDay||state.day));let searchDays=1+rand(Math.max(1,daysLost));mw.assignment='rescuing';mw.status='rescuing';mw.rescueTarget=lostId;mw.rescueEndDay=state.day+searchDays;addMessage('expedition',mw.name+' ventures into the mist to find '+lp.name+'. Est. '+searchDays+'d.',[],mc('person',lp.id));closeModal();render()}
function processRescue(){let rescuers=alive().filter(p=>p.status==='rescuing');for(let mw of rescuers){if(state.day>=mw.rescueEndDay){let lp=getPerson(mw.rescueTarget);mw.status='active';mw.assignment='available';mw.exp=Math.min(10,mw.exp+1);delete mw.rescueTarget;delete mw.rescueEndDay;if(lp&&lp.status==='lost'){let days=3+rand(3);lp.status='injured';lp.assignment='resting';lp.injuryDays=days;delete lp.lostDay;addMessage('event',mw.name+' found '+lp.name+' in the mist. '+lp.name+' recovering ('+days+'d).',[],mc('person',lp.id))}else{addMessage('event',mw.name+' returned from rescue. Target already gone.',[],mc('person',mw.id))}}}}
function processTraining(){for(let i=state.training.length-1;i>=0;i--){let t=state.training[i];t.daysRemaining--;if(t.daysRemaining<=0){let p=getPerson(t.personId);if(p&&p.status!=='dead'){if(t.targetRole==='mistwalker'){let successChance=p.traits.body>=3?100:50;if(!chance(successChance)){let attempt=(p.mwAttempts||0)+1;p.mwAttempts=attempt;if(attempt>=2){p.mwPermFail=true;p.role=t.previousRole||'unassigned';p.assignment=getDefaultAssignment(p.role);p.status='active';addMessage('training',p.name+' failed Mistwalker training a second time. The mist will never accept them.',[],mc('person',p.id));state.training.splice(i,1);continue}else{p.role=t.previousRole||'unassigned';p.assignment=getDefaultAssignment(p.role);p.status='active';addMessage('training',p.name+' washed out of Mistwalker training. May try once more.',[],mc('person',p.id));state.training.splice(i,1);continue}}}p.role=t.targetRole;p.assignment=getDefaultAssignment(t.targetRole);p.status='active';p.exp=Math.max(p.exp,1);if(!p.completedTraining.includes(t.targetRole))p.completedTraining.push(t.targetRole);let stats=getPersonStats(p);let sStr=Object.entries(stats).map(([k,v])=>k+':'+v).join(' ');addMessage('training',p.name+' completed '+roleLabel(t.targetRole)+' training. ['+sStr+']',[],mc('person',p.id))}state.training.splice(i,1)}}}

function getDefaultAssignment(r){return{priest:'perimeter',fighter:'garrison',worker:'farms',mistwalker:'available',mystic:'garrison',scholar:'available',engineer:'available',alchemist:'available'}[r]||'none'}

function processExpeditions(){for(let i=state.expeditions.length-1;i>=0;i--){let e=state.expeditions[i];e.daysOut++;if(e.recalling&&state.day>=e.recallDay&&!e.returnEndDay){let recallMW=getPerson(e.recallMWId);if(recallMW)recallMW.assignment='expedition';let returnDays=Math.max(1,Math.ceil(e.daysOut/2));e.returnEndDay=state.day+returnDays;let loc=state.locations.find(l=>l.id===e.locationId);addMessage('expedition','Recall reaches '+e.leaderName+' at '+(loc?loc.label:'?')+'. Returning in ~'+returnDays+'d.',[],mc('tab','expeditions'))}if(e.returnEndDay&&state.day>=e.returnEndDay){resolveRecalledExpedition(e);state.expeditions.splice(i,1);continue}if(!e.recalling&&!e.returnEndDay){if(!e.travelEncounter&&chance(10)){let mw=getPerson(e.leaderId);let cr=pick(state.creatures);if(cr){let trvAlive=e.team.filter(id=>{let p=getPerson(id);return p&&p.status!=='dead'});let trvMystic=getMysticInParty(trvAlive);let trvCompound=e.compounds>0;let tAtk=getTeamAttackVs(trvAlive,cr.category,{mysticBoost:trvMystic,compoundBoost:trvCompound});let ps=1+rand(2);let eAtk=cr.attack*ps;let crPl=pluralize(cr.label,ps);if(tAtk>=eAtk){addMessage('combat',e.leaderName+'\'s expedition encountered '+ps+' '+crPl+' en route. Fought them off.',[],mc('tab','expeditions'))}else{e.travelEncounter=true;e.pendingInjury={days:2+rand(3),cause:'ambushed by '+crPl+' en route'}}}}if(e.daysOut===Math.floor(e.duration/2)){addMessage('expedition',flavorText(FLAVOR.midway,{name:e.leaderName,day:String(e.daysOut)}),[],mc('tab','expeditions'));if(e.priestId){let priest=getPerson(e.priestId);if(priest&&priest.status!=='dead'){let ps=getPersonStats(priest);let pEnd=ps.endurance||0;let failChance=Math.max(0,(e.duration*5)-(pEnd*10));if(rand(100)<failChance){let mw=getPerson(e.leaderId);let survivors=[e.leaderId,e.priestId];let dead=e.team.filter(id=>!survivors.includes(id));for(let id of dead){let p=getPerson(id);if(p){p.status='dead';p.deathDay=state.day;recoverArtifacts(p.id);addMessage('death',p.name+' was lost when the shield failed.',[],mc('person',p.id))}}for(let id of survivors){let p=getPerson(id);if(p){p.assignment='available';p.status='available'}}addMessage('expedition','The mist shield falters! '+priest.name+'\'s endurance gives out. '+mw.name+' holds a desperate barrier — but it is too small.'+(dead.length>0?' '+dead.length+' escort lost to the mist.':' The team barely survives.'),[],mc('tab','expeditions'));if(e.compounds>0){state.compounds+=e.compounds;addMessage('expedition',e.compounds+' compound'+(e.compounds>1?'s':'')+' recovered from the failed expedition.',[],mc('tab','expeditions'))}state.expeditions.splice(i,1);continue}}}}if(e.daysOut>=e.duration){resolveExpedition(e);state.expeditions.splice(i,1)}}}}

function resolveExpedition(exp){
  let loc=state.locations.find(l=>l.id===exp.locationId);let teamAlive=exp.team.filter(id=>{let p=getPerson(id);return p&&p.status!=='dead'});
  let crtsHere=state.creatures.filter(c=>c.locationIds.includes(loc.id));let hadCombat=false,combatWon=true;
  let isSoloMW=teamAlive.length===1&&getPerson(teamAlive[0])&&getPerson(teamAlive[0]).role==='mistwalker';
  loc.scouted=true;
  if(crtsHere.length>0){let cr=pick(crtsHere);let ps=cr.packMin+rand(cr.packMax-cr.packMin+1);let eAtk=cr.attack*ps;let eDef=cr.defense*ps;let crPl=pluralize(cr.label,ps);
  if(state.knownWeaknesses.includes(cr.id)){let red=cr.weaknessBonus*ps;eAtk=Math.max(ps,eAtk-red);eDef=Math.max(ps,eDef-red)}
  let expMystic=getMysticInParty(teamAlive);let expCompound=exp.compounds>0;let nonMWTeam=teamAlive.filter(id=>{let p=getPerson(id);return p&&p.role!=='mistwalker'});let expUsed=Math.min(exp.compounds,nonMWTeam.length);let tAtk=getTeamAttackVs(teamAlive,cr.category,{mysticBoost:expMystic,compoundBoost:expCompound});if(expCompound&&cr.category==='corrupted'){exp.compounds-=expUsed;addMessage('combat','Anti-corruption compounds used against '+cr.label+'! ('+expUsed+' consumed by team)',[],mc('tab','expeditions'))}
  // SOLO MW ASSESSMENT: if outmatched, scout only and retreat
  if(isSoloMW&&tAtk<eDef){let mw=getPerson(teamAlive[0]);if(chance(10)){injure(mw,2+rand(3),'caught briefly near '+loc.label)}let crStr=crtsHere.map(c=>c.label+' \u27d0 '+c.category+' (~'+c.packMin+'-'+c.packMax+(creatureKnown(c.id)?', atk:'+c.attack+' def:'+c.defense:'')+')'  ).join(', ');addMessage('expedition',mw.name+' assessed '+loc.label+': '+crStr+'. Too dangerous alone — retreating with intel.',[],mc('tab','expeditions'));let yStr=loc.yields.map(dId=>{let d=state.discoveries.find(x=>x.id===dId);return d?d.label:'?'}).join(', ');if(yStr)addMessage('expedition','Scouted: '+yStr+(loc.artifactId?'. Artifact detected.':''),[],mc('tab','expeditions'));for(let id of exp.team){let p=getPerson(id);if(p&&p.status!=='dead'&&p.status!=='injured'){p.assignment=getDefaultAssignment(p.role);p.status='active';p.exp=Math.min(10,p.exp+1)}}if(exp.pendingInjury){let pi=getPerson(exp.leaderId);if(pi&&pi.status!=='dead'){injure(pi,exp.pendingInjury.days,exp.pendingInjury.cause)}}state.attention+=CONFIG.expeditionAttention;return}
  hadCombat=true;
  // DECISIVE WIN: team atk >= enemy def. No casualties.
  if(tAtk>=eDef){addMessage('combat',flavorText(FLAVOR.returnWin,{name:exp.leaderName,creature:cr.label})+' '+ps+' '+crPl+' defeated. (Atk '+tAtk+' vs Def '+eDef+').',[],mc('tab','expeditions'));if(cr.lootArtifact&&!state.foundArtifacts.includes(cr.lootArtifact)&&chance(40)){state.foundArtifacts.push(cr.lootArtifact);let a=state.artifacts.find(x=>x.id===cr.lootArtifact);if(a){a.found=true;addMessage('expedition','Loot: '+a.label,[],mc('tab','research'));tagLastSound('treasure')}};let carcYield=ps;state.carcasses+=carcYield;addMessage('combat','Carcasses collected: '+carcYield,[],mc('tab','expeditions'))}
  // NARROW WIN: atk >= 60% of enemy def. Injury likely, death rare.
  else if(tAtk>=eDef*0.6){let escortAlive=teamAlive.filter(id=>{let p=getPerson(id);return p.role!=='mistwalker'});let vic=escortAlive.length>0?pick(escortAlive):pick(teamAlive);if(vic){let vp=getPerson(vic);if(chance(15)){killPerson(vp,'killed fighting '+crPl)}else{injure(vp,3+rand(3),'wounded fighting '+crPl)}}addMessage('combat',flavorText(FLAVOR.returnNarrow,{name:exp.leaderName,creature:cr.label})+' '+ps+' '+crPl+'. (Atk '+tAtk+' vs Def '+eDef+').',[],mc('tab','expeditions'));let carcYield=Math.ceil(ps*0.5);state.carcasses+=carcYield;addMessage('combat','Carcasses collected: '+carcYield,[],mc('tab','expeditions'))}
  // DEFEAT: retreat with injuries and possible deaths.
  else{combatWon=false;let cas=Math.min(2,teamAlive.length);let expDeathOccurred=false;for(let c=0;c<cas;c++){let pool=teamAlive.filter(id=>{let p=getPerson(id);return p.status!=='dead'&&p.status!=='injured'});if(pool.length===0)break;let escPool=pool.filter(id=>{let p=getPerson(id);return p.role!=='mistwalker'});let vic=escPool.length>0?pick(escPool):pick(pool);let vp=getPerson(vic);if(c===0&&!expDeathOccurred){killPerson(vp,'killed by '+crPl);expDeathOccurred=true}else if(chance(30)){killPerson(vp,'killed by '+crPl)}else{injure(vp,4+rand(4),'badly wounded by '+crPl)}}addMessage('combat',flavorText(FLAVOR.returnLoss,{name:exp.leaderName,creature:cr.label})+' Overwhelmed by '+ps+' '+crPl+'. (Atk '+tAtk+' vs Def '+eDef+').',[],mc('tab','expeditions'));let carcYield=rand(2);if(carcYield>0){state.carcasses+=carcYield;addMessage('combat','Carcass salvaged: '+carcYield,[],mc('tab','expeditions'))}}crtsHere.forEach(c=>revealCreature(c.id))}
  let expSurv=exp.team.filter(id=>{let p=getPerson(id);return p&&p.status!=='dead'});if(expSurv.length>0){for(let id of exp.team){let p=getPerson(id);if(p&&p.status==='dead'&&p.deathDay===state.day)recoverArtifacts(p.id)}}
  for(let id of exp.team){let p=getPerson(id);if(p&&p.status!=='dead'&&p.status!=='injured'){p.assignment=getDefaultAssignment(p.role);p.status='active';p.exp=Math.min(10,p.exp+1)}}
  if(!hadCombat||combatWon){loc.explored=true;if(!state.exploredLocations.includes(loc.id))state.exploredLocations.push(loc.id);
  for(let dId of loc.yields){if(!state.foundDiscoveries.includes(dId)){state.foundDiscoveries.push(dId);let d=state.discoveries.find(x=>x.id===dId);if(d){d.found=true;d.foundDay=state.day;addMessage('expedition',flavorText(FLAVOR.discExp,{name:exp.leaderName,disc:d.label})+' Needs '+d.studyTime+'d research. Unlocks: '+d.unlockLabel,[],mc('tab','research'))}}}

  if(loc.artifactId&&!state.foundArtifacts.includes(loc.artifactId)){state.foundArtifacts.push(loc.artifactId);let a=state.artifacts.find(x=>x.id===loc.artifactId);if(a){a.found=true;let fx=Object.entries(a.effects).map(([k,v])=>k+':+'+v).join(', ');addMessage('expedition',flavorText(FLAVOR.artFound,{art:a.label})+' ('+roleLabel(a.forRole)+'): '+fx,[],mc('tab','research'));tagLastSound('treasure')}}
  // Conquest bonus: 1-2 procedurally generated items, at least one uncommon+
  let conquestCount=1+rand(2);for(let ci=0;ci<conquestCount;ci++){let cr=rollRarity('conquest');if(ci===0&&cr==='common')cr='uncommon';let ca=generateEquipment(loc.tier||1,cr);ca.found=true;state.artifacts.push(ca);state.foundArtifacts.push(ca.id);let cfx=Object.entries(ca.effects).map(([k,v])=>k+':+'+v).join(', ');addMessage('expedition','Found: '+ca.label+' ('+roleLabel(ca.forRole)+', '+ca.rarity+'): '+cfx,[],mc('tab','research'));tagLastSound('treasure')}

  let expLoc=state.locations.find(l=>l.id===exp.locationId);
  if(expLoc&&combatWon!==false){
    let sourceClue=state.clues.find(c=>c.type==='final'&&c.targetId===expLoc.id&&!c.found);
    if(sourceClue){sourceClue.found=true;sourceClue.foundDay=state.day;state.pendingClues.push(sourceClue.id);addMessage('research','Ancient knowledge recovered from '+expLoc.label+': "'+sourceClue.label+'" — points toward the Source.',[],mc('tab','research'))}

    let nextTierNum=Math.min(expLoc.tier+1,3);
    let nextTier=nextTierNum===1?'shallows':nextTierNum===2?'greyreach':'deep';
    let clueRolls=1+rand(2);
    for(let cr=0;cr<clueRolls;cr++){
      let roll=rand(100);let clue=null;
      if(roll<50){
        let pool=state.clues.filter(c=>c.tier===nextTier&&c.type==='location'&&!c.found);
        if(pool.length>0)clue=pick(pool);
      }
      if(clue){clue.found=true;clue.foundDay=state.day;state.pendingClues.push(clue.id);
        addMessage('research','Clue found at '+expLoc.label+': "'+clue.label+'" — hints at '+clue.targetLabel+'.',[],mc('tab','research'));}
    }
  }

  addMessage('expedition',flavorText(hadCombat?FLAVOR.returnWin:FLAVOR.returnPeace,{name:exp.leaderName,creature:''})+' Returned from '+loc.label+'.',[],mc('tab','expeditions'))}else addMessage('expedition',flavorText(FLAVOR.returnLoss,{name:exp.leaderName,creature:'the threats'})+' Driven back from '+loc.label+'.',[],mc('tab','expeditions'));
  if(exp.pendingInjury){let pi=getPerson(exp.leaderId);if(pi&&pi.status!=='dead'&&pi.status!=='injured'){injure(pi,exp.pendingInjury.days,exp.pendingInjury.cause)}}
  if(exp.compounds>0){state.compounds+=exp.compounds;addMessage('expedition',exp.compounds+' unused compound'+(exp.compounds>1?'s':'')+' returned to stockpile.',[],mc('tab','expeditions'))}
  state.attention+=CONFIG.expeditionAttention;
}

function processResearch(){for(let i=state.activeResearch.length-1;i>=0;i--){let r=state.activeResearch[i];let sch=r.scholarIds.map(id=>getPerson(id)).filter(p=>p&&p.status==='active');if(sch.length===0){state.activeResearch.splice(i,1);continue}let spd=0;for(let s of sch){let st=getPersonStats(s);spd+=st.researchSpeed||1}if(sch.length>1)spd*=0.85;r.progress+=spd;let d=state.discoveries.find(x=>x.id===r.discoveryId);if(r.progress>=d.studyTime){d.studied=true;if(!state.studiedDiscoveries.includes(d.id))state.studiedDiscoveries.push(d.id);sch.forEach(s=>{s.assignment='available';s.exp=Math.min(10,s.exp+1)});state.activeResearch.splice(i,1);addMessage('research',pick(FLAVOR.research)+' '+d.label+' complete. Result: '+d.unlockLabel,[],mc('tab','research'));if(d.type==='location'){let l=state.locations.find(x=>x.id===d.unlocksId);if(l){l.revealed=true;addMessage('event','New location: '+l.label+' (dist '+l.distance+')',[],mc('tab','expeditions'))}}if(d.type==='weakness'){if(!state.knownWeaknesses.includes(d.unlocksId))state.knownWeaknesses.push(d.unlocksId);revealCreature(d.unlocksId);let c=state.creatures.find(x=>x.id===d.unlocksId);if(c)addMessage('research',c.label+' weakness: -'+c.weaknessBonus+' atk/def per creature in combat. Stats revealed: atk '+c.attack+', def '+c.defense+'.',[],mc('tab','research'))}if(d.type==='buildable')addMessage('research','Can now build: '+d.unlockLabel,[],mc('tab','engineering'));if(d.type==='buff')addMessage('research','Knowledge: '+d.unlockLabel,[],mc('tab','research'));if(d.type==='detection')addMessage('research','Detection extended. Threats now visible '+getDetectionRange()+' days out.',[],mc('tab','dashboard'));if(d.type==='statBoost'){let parts=d.unlocksId.split('-');let statName=parts[1];state.flags['pendingStatBoost']=statName;addMessage('research','Stat boost unlocked: +1 '+statName+'. Assign via person modal.',[],mc('tab','people'))}if(d.type==='trainingShortcut'){let parts=d.unlocksId.split('-');let role=parts[1];if(CONFIG.trainingDays[role]){CONFIG.trainingDays[role]=Math.max(1,CONFIG.trainingDays[role]-2);addMessage('research','Training shortcut: '+role+' training reduced by 2 days (now '+CONFIG.trainingDays[role]+' days).',[],mc('tab','research'))}}if(d.type==='eventModifier'){let parts=d.unlocksId.split('-');let mod=parts[1];if(!state.flags.eventMods)state.flags.eventMods={};state.flags.eventMods[mod]=(state.flags.eventMods[mod]||0)+1;addMessage('research','Passive modifier: '+d.unlockLabel,[],mc('tab','research'))}if(d.type==='oneTimeEffect'){state.consumables.push({id:'cons-'+Date.now()+'-'+rand(999),label:d.label,effectId:d.unlocksId,used:false});addMessage('research','Consumable ready: '+d.unlockLabel+'. Use from dashboard.',[],mc('tab','dashboard'))}if(d.type==='herbUnlock'){let hName=d.unlockLabel.replace('Unlock herb: ','');let herb={id:d.unlocksId,name:hName,tier:d.tier,cultivated:false,supply:0};state.knownHerbs.push(herb);state.herbSupply[herb.id]=0;addMessage('research','Herb discovered: '+hName+'. Assign a worker to cultivate.',[],mc('tab','people'))}if(d.type==='recipeUnlock'){let rName=d.unlockLabel.replace('Unlock recipe: ','');let recipe={id:d.unlocksId,name:rName,tier:d.tier,ingredients:[],brewTime:3+d.tier*2,effect:{type:'buff',magnitude:d.tier}};state.knownRecipes.push(recipe);addMessage('research','Recipe discovered: '+rName+'. An alchemist can brew this.',[],mc('tab','research'))}}}}

function processDeciphering(){for(let i=state.activeDeciphering.length-1;i>=0;i--){let d=state.activeDeciphering[i];let sch=d.scholarIds.map(id=>getPerson(id)).filter(p=>p&&p.status==='active');if(sch.length===0){state.activeDeciphering.splice(i,1);continue;}let spd=0;for(let s of sch){let st=getPersonStats(s);spd+=st.researchSpeed||1;}d.progress+=spd;let clue=state.clues.find(c=>c.id===d.clueId);if(!clue)continue;let req=clue.tier==='shallows'?1:clue.tier==='greyreach'?2:3;if(d.progress>=req){clue.deciphered=true;state.pendingClues=state.pendingClues.filter(id=>id!==clue.id);sch.forEach(s=>{s.assignment='available';s.exp=Math.min(10,s.exp+1);});state.activeDeciphering.splice(i,1);if(clue.type==='location'){if(!state.decipheredClues.locations[clue.targetId])state.decipheredClues.locations[clue.targetId]=0;state.decipheredClues.locations[clue.targetId]++;let count=state.decipheredClues.locations[clue.targetId];let loc=state.locations.find(l=>l.id===clue.targetId);addMessage('research','Clue deciphered — '+count+'/3 for '+(loc?loc.label:'?')+'.',[],mc('tab','research'));if(count>=3&&loc&&!loc.revealed){loc.revealed=true;addMessage('expedition','Location revealed: '+loc.label+'! Expedition ready.',[],mc('tab','expeditions'));}}else if(clue.type==='final'){let tier=clue.tier;state.decipheredClues.final[tier]++;let total=state.decipheredClues.final.shallows+state.decipheredClues.final.greyreach+state.decipheredClues.final.deep;addMessage('research','Final clue deciphered ('+tier+'). Progress: '+total+'/9.',[],mc('tab','research'));if(total>=9){let sourceDisc={id:'disc-source',label:'The Path to the Source',studyTime:10,tier:4,type:'location',unlocksId:'loc-9',unlockLabel:'Reveals The Source of the Mist',sourceType:'clue',sourceId:null,found:true,studied:false};state.discoveries.push(sourceDisc);if(!state.foundDiscoveries.includes(sourceDisc.id))state.foundDiscoveries.push(sourceDisc.id);addMessage('alert','All 9 clues point to one place. Scholars can now research The Path to the Source.',[],mc('tab','research'));}}}}};function startDeciphering(clueId,scholarId){let clue=state.clues.find(c=>c.id===clueId);if(!clue||clue.deciphered)return;let s=getPerson(scholarId);if(!s||s.role!=='scholar'||s.status!=='active')return;if(state.activeDeciphering.some(d=>d.clueId===clueId))return;s.assignment='deciphering';state.activeDeciphering.push({clueId:clueId,scholarIds:[s.id],progress:0});let req=clue.tier==='shallows'?1:clue.tier==='greyreach'?2:3;addMessage('research',s.name+' begins deciphering a '+(clue.type==='final'?'source':'location')+' clue. ~'+req+'d.',[],mc('tab','research'));render();}function cancelDeciphering(clueId){let idx=state.activeDeciphering.findIndex(d=>d.clueId===clueId);if(idx===-1)return;let d=state.activeDeciphering[idx];d.scholarIds.forEach(id=>{let s=getPerson(id);if(s&&s.status==='active')s.assignment='available';});state.activeDeciphering.splice(idx,1);render();}function addScholarToDecipher(clueId){let d=state.activeDeciphering.find(x=>x.clueId===clueId);if(!d)return;let s=alive().find(p=>p.role==='scholar'&&(p.assignment==='available'||p.assignment==='none')&&!d.scholarIds.includes(p.id));if(!s){addMessage('event','No additional scholars available.');render();return;}s.assignment='deciphering';d.scholarIds.push(s.id);addMessage('research',s.name+' joins deciphering.',[],mc('tab','research'));render();}

function processBuild(){if(!state.activeBuild)return;let builders=(state.activeBuild.engineerIds||[]).map(id=>getPerson(id)).filter(p=>p&&p.status==='active');if(builders.length===0)return;let spd=0;for(let eng of builders){let s=getPersonStats(eng);spd+=(s.buildSpeed||1)}state.activeBuild.progress+=spd;if(state.activeBuild.progress>=state.activeBuild.totalDays){let b=state.buildables.find(x=>x.id===state.activeBuild.buildableId);b.built=true;state.builtSystems.push(b.id);builders.forEach(e=>{e.assignment='available';e.exp=Math.min(10,e.exp+1)});addMessage('system','Built: '+b.label+'. Effect: '+b.effectLabel,[],mc('tab','engineering'));state.activeBuild=null}}

function processDig(){if(!state.activeDig)return;let diggers=alive().filter(p=>p.assignment==='digging');if(diggers.length===0)return;for(let d of diggers){d.digDays=(d.digDays||0)+1;if(d.digDays%5===0){d.exp=Math.min(10,d.exp+1)}}let level=state.digLevels[state.activeDig.levelIndex];if(!level)return;let spd=0;for(let d of diggers){let s=getPersonStats(d);spd+=(s.digSpeed||1)}state.activeDig.progress+=spd;if(!level.named&&state.activeDig.progress>=level.laborDays/2){level.named=true;addMessage('dig','The diggers uncover markings... this place was once called '+level.label+'.',[],mc('tab','engineering'))}if(state.activeDig.progress>=level.laborDays){level.cleared=true;level.named=true;addMessage('dig',flavorText(FLAVOR.digCleared,{})+' '+level.label+' cleared.',[],mc('tab','engineering'));for(let dId of level.yields){if(!state.foundDiscoveries.includes(dId)){state.foundDiscoveries.push(dId);let d=state.discoveries.find(x=>x.id===dId);if(d){d.found=true;d.foundDay=state.day;addMessage('dig',flavorText(FLAVOR.discDig,{disc:d.label})+' '+d.studyTime+'d research. Unlocks: '+d.unlockLabel,[],mc('tab','research'))}}}addDigLevel();let ni=state.digLevels.findIndex(l=>!l.cleared);if(ni!==-1){state.activeDig={levelIndex:ni,progress:0};let nextLv=state.digLevels[ni];let nextName=nextLv.named?nextLv.label:'Level '+(ni+1);addMessage('dig','Diggers advance to '+nextName+'.',[],mc('tab','engineering'))}else{diggers.forEach(d=>{d.assignment='available'});state.activeDig=null}}}

function spawnThreat(cr,ps,dir){let det=getDetectionRange();let fast=chance(15);let minWarn=fast?1:Math.max(2,det-1);let maxWarn=det+1;let actualWarn=minWarn+rand(Math.max(1,maxWarn-minWarn+1));state.threats.push({id:'t-'+state.day+'-'+rand(999),creatureId:cr.id,count:ps,direction:dir,arrivalDayMin:state.day+minWarn,arrivalDayMax:state.day+maxWarn,actualArrivalDay:state.day+actualWarn,scouted:false,status:'approaching'});let crK=creatureKnown(cr.id);let statStr=crK?' (Atk: '+cr.attack+', Def: '+cr.defense+')':'';addMessage('alert',flavorText(FLAVOR.threatSeen,{creature:cr.label,count:String(ps),dir:dir})+' '+cr.label+' \u27d0 '+cr.category+statStr+'. ~'+ps+' spotted. Est. '+minWarn+'-'+maxWarn+'d out.',[],mc('tab','dashboard'));tagLastSound('alert')}
function getThreatCreature(){let eligible=state.creatures;if(state.maxDepthEntered==='none'||state.maxDepthEntered==='shallows'){eligible=eligible.filter(c=>c.category==='physical');}else if(state.maxDepthEntered==='greyreach'){eligible=eligible.filter(c=>c.category==='physical'||c.category==='corrupted');}return pick(eligible)||state.creatures[0]}
function getThreatPackSize(cr){let md=state.maxDistanceTraveled;let sizeBonus=Math.floor(md/3);return Math.min(cr.packMin+sizeBonus+rand(cr.packMax-cr.packMin+1),cr.packMax+2)}
function processThreats(){let DIRS=['northern','southern','eastern','western'];if(state.attention>=CONFIG.threatThreshold&&!state.flags.firstThreat){state.flags.firstThreat=true;let cr=getThreatCreature();let ps=getThreatPackSize(cr);spawnThreat(cr,ps,pick(DIRS))}if(state.attention>=CONFIG.threatThreshold+15&&state.day%CONFIG.threatSpawnInterval===0&&state.threats.filter(t=>t.status==='approaching').length<CONFIG.maxOverlappingThreats){let cr=getThreatCreature();let ps=getThreatPackSize(cr);spawnThreat(cr,ps,pick(DIRS))}for(let t of state.threats){if(t.status==='approaching'&&state.day>=t.actualArrivalDay)resolveThreatAttack(t);if(t.scouted&&t.status==='approaching'&&state.day<t.actualArrivalDay-1){let dl=t.actualArrivalDay-state.day;let cr=state.creatures.find(c=>c.id===t.creatureId);addMessage('alert',(cr?cr.label:'Threat')+' from the '+t.direction+': attack in '+dl+' days. ('+t.count+' confirmed)',[],mc('tab','dashboard'))}if(t.status==='approaching'&&state.day===t.actualArrivalDay-1){let cr=state.creatures.find(c=>c.id===t.creatureId);addMessage('alert','ATTACK TOMORROW from '+t.direction+'! '+(cr?cr.label+' \u27d0 '+cr.category:'Threat')+'.'+(t.scouted?' Count confirmed: '+t.count+'.':' Est. ~'+t.count+'.'),[],mc('tab','dashboard'))}}state.threats=state.threats.filter(t=>t.status!=='resolved')}

function resolveThreatAttack(threat){threat.status='resolved';let cr=state.creatures.find(c=>c.id===threat.creatureId);addMessage('alert','ATTACK! '+cr.label+' from the '+threat.direction+'!',[],mc('tab','dashboard'));tagLastSound('alert');revealCreature(cr.id);let eAtk=cr.attack*threat.count;let eDef=cr.defense*threat.count;if(state.knownWeaknesses.includes(cr.id)){let reduction=cr.weaknessBonus*threat.count;eAtk=Math.max(threat.count,eAtk-reduction);eDef=Math.max(threat.count,eDef-reduction);addMessage('combat','Weakness applied vs '+cr.label+': atk reduced to '+eAtk+', def to '+eDef,[],mc('tab','dashboard'))}let trapsUsed=state.traps;if(trapsUsed>0){state.traps=0;let reduction=2*trapsUsed;let oldAtk=eAtk;eAtk=Math.max(threat.count,eAtk-reduction);addMessage('combat','Traps spring! Enemy attack reduced from '+oldAtk+' to '+eAtk+'. ('+trapsUsed+' traps consumed)',[],mc('tab','dashboard'))}let hasMystic=getMysticInGarrison();let hasCompounds=false;if(cr.category==='corrupted'){hasCompounds=state.compounds>0;let defenders=combat_ready().filter(p=>(p.assignment==='garrison'||p.assignment==='available')&&p.status!=='expedition'&&p.role!=='mistwalker');let nonMWCount=defenders.length;let used=Math.min(state.compounds,nonMWCount);if(used>0){state.compounds-=used;addMessage('combat','Anti-corruption compounds deployed! ('+used+' used by '+nonMWCount+' defenders, '+state.compounds+' remaining)',[],mc('tab','dashboard'))}else if(nonMWCount>0&&!hasCompounds){addMessage('combat','No anti-corruption compounds! Corrupted creatures resist conventional weapons!',[],mc('tab','dashboard'))}}let defOpts={mysticBoost:hasMystic,compoundBoost:hasCompounds};if(hasMystic&&cr.category==='spiritual')addMessage('combat','The Mystic\'s presence makes the ethereal take corporeal form!',[],mc('tab','dashboard'));if(!hasMystic&&cr.category==='spiritual')addMessage('combat','Spiritual creatures phase through your defenses!',[],mc('tab','dashboard'));let def=getDefenseStrengthVs(cr.category,defOpts);
  // Show category effectiveness summary
  let rawDef=getDefenseBreakdown().total;let effNotes=[];let garr2=alive().filter(p=>(p.assignment==='garrison'||p.assignment==='available')&&p.status!=='expedition');let rolesSeen={};for(let p of garr2){let m=getCategoryEffectiveness(p.role,cr.category);if(defOpts.mysticBoost&&cr.category==='spiritual'){m=Math.max(m,getCategoryEffectiveness(p.role,'physical'))}if(defOpts.compoundBoost&&cr.category==='corrupted'&&p.role!=='mistwalker'){m=Math.max(m,getCategoryEffectiveness(p.role,'physical'))}if(!rolesSeen[p.role]){rolesSeen[p.role]=m}}for(let[role,m]of Object.entries(rolesSeen)){if(m>=1.25)effNotes.push(roleLabel(role)+'s strong vs '+cr.category+' (x'+m+')');else if(m<=0.5)effNotes.push(roleLabel(role)+'s weak vs '+cr.category+' (x'+m+')')}if(effNotes.length>0)addMessage('combat','Matchup vs '+cr.category+': '+effNotes.join('. ')+'. (Base def: '+rawDef+' \u2192 Effective: '+def+')',[],mc('tab','dashboard'));
  if(threat.scouted){let scoutBonus=Math.round(def*0.1);def+=scoutBonus;addMessage('combat','Scouted intel advantage: +10% defense ('+scoutBonus+' bonus, total: '+def+')',[],mc('tab','dashboard'))}
  // DECISIVE WIN: def >= enemy atk. No casualties at all.
  let crPl=pluralize(cr.label,threat.count);
  if(def>=eAtk){addMessage('combat',flavorText(FLAVOR.defWin,{creature:cr.label})+' '+threat.count+' '+crPl+' repelled. (Atk '+eAtk+' vs Def '+def+'). No losses.',[],mc('tab','dashboard'));tagLastSound('victory');if(cr.lootArtifact&&!state.foundArtifacts.includes(cr.lootArtifact)&&chance(25)){state.foundArtifacts.push(cr.lootArtifact);let a=state.artifacts.find(x=>x.id===cr.lootArtifact);if(a){a.found=true;addMessage('event','Loot: '+a.label,[],mc('tab','research'));tagLastSound('treasure')}};let carcYield=threat.count;state.carcasses+=carcYield;addMessage('combat','Carcasses collected: '+carcYield,[],mc('tab','dashboard'));let combatants=alive().filter(p=>(p.assignment==='garrison'||p.assignment==='available')&&p.status==='active');for(let cb of combatants){cb.exp=Math.min(10,cb.exp+3)}if(combatants.length>0)addMessage('combat','Garrison gains combat experience. (+3 exp)',[],mc('tab','dashboard'))}
  // NARROW WIN: def >= 60% of enemy atk. Injuries, small chance of death.
  else if(def>=eAtk*0.6){let pool=combat_ready().filter(p=>p.assignment==='garrison'||p.assignment==='farms'||p.assignment==='available');if(pool.length>0){let v=pickCasualty(pool);if(chance(20)){killPerson(v,'overwhelmed by '+crPl);recoverArtifacts(v.id)}else{injure(v,3+rand(4),'wounded fighting '+crPl)}}addMessage('combat',flavorText(FLAVOR.defNarrow,{creature:cr.label})+' '+threat.count+' '+crPl+' repelled. (Atk '+eAtk+' vs Def '+def+').',[],mc('tab','dashboard'));tagLastSound('victory');let carcYield=Math.ceil(threat.count*0.5);state.carcasses+=carcYield;addMessage('combat','Carcasses collected: '+carcYield,[],mc('tab','dashboard'));let combatants2=alive().filter(p=>(p.assignment==='garrison'||p.assignment==='available')&&p.status==='active');for(let cb of combatants2){cb.exp=Math.min(10,cb.exp+3)}if(combatants2.length>0)addMessage('combat','Garrison gains combat experience. (+3 exp)',[],mc('tab','dashboard'))}
  // DEFEAT: def < 60%. Multiple injuries, higher death chance, food loss.
  else{let pool=combat_ready().filter(p=>p.assignment==='garrison'||p.assignment==='farms'||p.assignment==='available'||p.assignment==='perimeter');let cas=Math.min(2,pool.length);let deathOccurred=false;for(let c=0;c<cas;c++){if(pool.length===0)break;let v=pickCasualty(pool);pool=pool.filter(x=>x.id!==v.id);if(c===0&&!deathOccurred){killPerson(v,'killed in breach by '+crPl);recoverArtifacts(v.id);deathOccurred=true}else if(chance(35)){killPerson(v,'killed in breach by '+crPl);recoverArtifacts(v.id)}else{injure(v,4+rand(5),'badly wounded in breach')}}state.food=Math.max(0,state.food-10);addMessage('combat',flavorText(FLAVOR.defLoss,{creature:cr.label})+' '+threat.count+' '+crPl+' breached. (Atk '+eAtk+' vs Def '+def+'). Food damaged.',[],mc('tab','dashboard'));tagLastSound('defeat');let carcYield=rand(2);if(carcYield>0){state.carcasses+=carcYield;addMessage('combat','Carcass salvaged: '+carcYield,[],mc('tab','dashboard'))}if(alive().length<=3)endGame('Too few remain.');let combatants3=alive().filter(p=>(p.assignment==='garrison'||p.assignment==='available')&&p.status==='active');for(let cb of combatants3){cb.exp=Math.min(10,cb.exp+3)}if(combatants3.length>0)addMessage('combat','Garrison gains combat experience. (+3 exp)',[],mc('tab','dashboard'))}}

function generateEvents(){if(state.day===3&&!state.flags.expHint){let mw=alive().find(p=>p.role==='mistwalker'&&p.assignment==='available');if(mw){state.flags.expHint=true;addMessage('event',personTag(mw)+' available for expeditions. Solo or with escort (needs priest shield).',[],mc('tab','expeditions'))}}if(state.day===5&&!state.flags.trainHint){state.flags.trainHint=true;let ua=alive().filter(p=>p.role==='unassigned');if(ua.length>0)addMessage('event',ua.length+' unassigned. Train them in People tab.',[],mc('tab','people'))}if(state.day===8&&getPerimeterStability()<100&&!state.flags.perimHint){state.flags.perimHint=true;addMessage('perimeter','Perimeter at '+getPerimeterStability()+'%. Gaps in coverage weaken defense and expose your people to the mist.',[],mc('tab','dashboard'))}if(state.day>5&&state.day%CONFIG.survivorCheckFrequency===0){let recentDeath=state.people.some(p=>p.status==='dead'&&p.deathDay&&state.day-p.deathDay<=3);let survChance=recentDeath?CONFIG.survivorChanceAfterDeath:CONFIG.survivorChanceBase;if(chance(survChance)){let name=pick(NAMES.survivors.filter(n=>!state.people.some(p=>p.name===n)));if(name){let newId=state.nextId++;state.people.push({id:newId,name:name,role:'unassigned',assignment:'none',traits:{spirit:1+rand(3),body:1+rand(3),mind:1+rand(3)},exp:0,status:'active',completedTraining:[]});addMessage('event','Survivor from mist: '+name+'. Unassigned.',[],mc('person',newId));tagLastSound('arrival');let survDisc=state.discoveries.filter(d=>!d.found&&d.tier===1);if(survDisc.length>0&&chance(40)){let sd=pick(survDisc);sd.found=true;sd.foundDay=state.day;if(!state.foundDiscoveries.includes(sd.id))state.foundDiscoveries.push(sd.id);addMessage('event',name+' carried something from the mist: '+sd.label+'. Needs '+sd.studyTime+'d research.',[],mc('tab','research'))}}}}// Flavor text — only on quiet days
let dayMsgs=state.messages.filter(m=>m.day===state.day);if(dayMsgs.length===0&&state.day>2){let garFarmers=alive().filter(p=>p.role==='worker'&&p.assignment==='garrison'&&p.status==='active');if(garFarmers.length>0&&chance(35)){let gf=pick(garFarmers);let grumbles=[gf.name+' mutters about the weight of the spear. "My sons are too young to keep the farm alone..."',gf.name+' stares out past the perimeter. "I should be tending the fields, not standing watch."',gf.name+' shifts uncomfortably in borrowed armor. "I\'m a worker, not a soldier."',gf.name+' eyes the farmland longingly from the garrison wall. "The crops won\'t tend themselves."',gf.name+' complains to anyone who\'ll listen: "These calluses are for plows, not sword hilts."',gf.name+' asks when they can return to the fields. "The soil needs me more than this wall does."'];addMessage('event',pick(grumbles),[],mc('person',gf.id))}else if(chance(30)){let pool=alive().filter(p=>p.status==='active');if(pool.length>=2){let p1=pick(pool);let p2=pick(pool.filter(p=>p.id!==p1.id));addMessage('event',flavorText(FLAVOR.idle,{name:p1.name,name2:p2.name}))}}else{let flavors=['A quiet day at the monastery. The mist holds steady.','Wind stirs the prayer flags. Nothing moves beyond the perimeter.','Birdsong from somewhere in the mist. A small mercy.','The priests hum softly on the perimeter. All is calm.','Fog thickens, then thins. The day passes without incident.','Smoke rises from the kitchens. A still, unremarkable day.','The monastery breathes. For now, the mist keeps its distance.','Candles flicker in the chapel. The faithful tend their duties.','Rain patters against old stone. The world beyond remains hidden.','A clear sky, if only above the monastery. The mist swirls below.'];addMessage('event',pick(flavors))}}}

// PLAYER ACTIONS
function getTraitReq(role){return{fighter:{body:2},priest:{spirit:3},scholar:{mind:3},engineer:{body:2,mind:2},worker:{},mistwalker:{spirit:3,body:2},mystic:{spirit:2,body:2},alchemist:{spirit:2,mind:2}}[role]||{}}
function meetsTraitReq(p,role){let req=getTraitReq(role);for(let[t,min]of Object.entries(req))if((p.traits[t]||0)<min)return false;return true}
function traitReqLabel(role){let req=getTraitReq(role);let names={spirit:'Spirit',body:'Resilience',mind:'Acuity'};return Object.entries(req).map(([t,v])=>names[t]+' '+v+'+').join(', ')}
function startTrainingAction(pid,targetRole){let p=getPerson(pid);if(!p||p.status!=='active')return;if(targetRole==='mistwalker'){if(!p.completedTraining.includes('fighter')||!p.completedTraining.includes('priest')){addMessage('event',p.name+' needs Fighter + Priest training first.',[],mc('person',pid));closeModal();render();return}if(p.mwPermFail){addMessage('event',p.name+' has permanently failed Mistwalker training.',[],mc('person',pid));closeModal();render();return}}if(targetRole==='mystic'){let hasPrereqs=p.completedTraining.includes('fighter')&&p.completedTraining.includes('priest');let directPath=meetsTraitReq(p,'mystic');if(!hasPrereqs&&!directPath){addMessage('event',p.name+' needs Fighter + Priest training, or Spirit 2+ & Resilience 2+.',[],mc('person',pid));closeModal();render();return}}if(!meetsTraitReq(p,targetRole)){addMessage('event',p.name+' cannot train as '+roleLabel(targetRole)+'. Requires: '+traitReqLabel(targetRole)+'.',[],mc('person',pid));closeModal();render();return}let days=CONFIG.trainingDays[targetRole]||7;let prev=p.role;p.role='training';p.assignment='training';p.status='training';state.training.push({personId:p.id,targetRole:targetRole,previousRole:prev,daysRemaining:days,totalDays:days});if(targetRole==='mistwalker'&&p.traits.body<3)addMessage('training',p.name+' begins Mistwalker training. Outcome uncertain — Resilience is not exceptional.',[],mc('person',pid));else addMessage('training',p.name+' begins '+roleLabel(targetRole)+' training. '+days+'d.',[],mc('person',pid));closeModal();render()}
function cancelTraining(pid){let idx=state.training.findIndex(t=>t.personId===pid);if(idx===-1)return;let t=state.training[idx];let p=getPerson(pid);if(!p)return;p.role='unassigned';p.assignment='none';p.status='active';state.training.splice(idx,1);addMessage('training',p.name+' training cancelled. Returned to unassigned.',[],mc('person',p.id));closeModal();render()}

function reassignPerson(pid,asgn){let p=getPerson(pid);if(!p||p.status!=='active')return;if(asgn==='perimeter'&&p.role!=='priest'){if(p.completedTraining.includes('priest')){let oldRole=p.role;p.role='priest';addMessage('event',personTag(p)+' switches to Priest (cross-trained from '+roleLabel(oldRole)+').',[],mc('person',pid))}else{addMessage('event','Only priests can hold perimeter.');closeModal();render();return}}p.assignment=asgn;let note='';if(asgn==='farms'&&p.role!=='worker')note=' (reduced food)';if(asgn==='garrison'&&p.role!=='fighter'){let s=getPersonStats(p);let d=Math.max(1,p.traits.body);note=' (def: '+d+')'}else if(asgn==='garrison'){let s=getPersonStats(p);note=' (def: '+(s.defense||0)+')'}addMessage('event',personTag(p)+' \u2192 '+asgn+note,[],mc('person',pid));closeModal();render()}

function switchRole(pid,role){let p=getPerson(pid);if(!p||p.status!=='active')return;if(p.role==='mistwalker'){addMessage('event',p.name+' has bonded with the mist. Mistwalkers cannot change roles.',[],mc('person',pid));closeModal();render();return}if(!p.completedTraining.includes(role)){addMessage('event',p.name+' has not completed '+roleLabel(role)+' training.',[],mc('person',pid));closeModal();render();return}let oldRole=p.role;p.role=role;p.assignment=getDefaultAssignment(role);addMessage('event',personTag(p)+' switches from '+roleLabel(oldRole)+' to '+roleLabel(role)+'.',[],mc('person',pid));closeModal();render()}
function equipArtifact(aId,pid){let a=state.artifacts.find(x=>x.id===aId);if(!a)return;if(a.equippedTo){let prev=state.equippedArtifacts[a.equippedTo];if(prev)state.equippedArtifacts[a.equippedTo]=prev.filter(id=>id!==aId)}a.equippedTo=pid;if(!state.equippedArtifacts[pid])state.equippedArtifacts[pid]=[];state.equippedArtifacts[pid].push(aId);addMessage('event',a.label+' equipped to '+getPerson(pid).name,[],mc('person',pid));closeModal();render()}
function unequipArtifact(aId){let a=state.artifacts.find(x=>x.id===aId);if(!a||!a.equippedTo)return;let ownerId=a.equippedTo;let prev=state.equippedArtifacts[ownerId];if(prev)state.equippedArtifacts[ownerId]=prev.filter(id=>id!==aId);let ownerName=getPerson(ownerId)?getPerson(ownerId).name:'?';a.equippedTo=null;addMessage('event',a.label+' unequipped from '+ownerName+'.',[],mc('person',ownerId));render()}

function startResearch(dId){let d=state.discoveries.find(x=>x.id===dId);if(!d||d.studied||state.activeResearch.some(r=>r.discoveryId===dId))return;let scholars=alive().filter(p=>p.role==='scholar'&&(p.assignment==='available'||p.assignment==='none'));if(scholars.length===0){addMessage('event','No scholars available.');render();return}if(scholars.length===1){confirmResearch(dId,scholars[0].id);return}showResearchModal(dId,scholars)}
function showResearchModal(dId,scholars){let d=state.discoveries.find(x=>x.id===dId);let sH=scholars.map(s=>{let st=getPersonStats(s);let spd=st.researchSpeed||1;let est=Math.ceil(d.studyTime/spd);return'<div class="item-row clickable" onclick="confirmResearch(\''+dId+'\','+s.id+')"><div><span class="item-name">'+s.name+'</span><br><span class="item-detail">Research Speed: '+Math.round(spd*100)/100+' | Est. ~'+est+' days</span></div><span class="item-detail">Select</span></div>'}).join('');document.getElementById('modal-content').innerHTML='<h2>Research: '+d.label+'</h2><p>Study time: ~'+d.studyTime+'d. Choose a scholar:</p>'+sH+'<div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal()}
function confirmResearch(dId,scholarId){let d=state.discoveries.find(x=>x.id===dId);let s=getPerson(scholarId);if(!d||!s||s.status!=='active'){addMessage('event','Scholar unavailable.');closeModal();render();return}if(state.activeResearch.some(r=>r.discoveryId===dId)){closeModal();render();return}s.assignment='researching';state.activeResearch.push({discoveryId:dId,scholarIds:[s.id],progress:0});let st=getPersonStats(s);let spd=st.researchSpeed||1;let est=Math.ceil(d.studyTime/spd);addMessage('research',personTag(s)+' researching '+d.label+'. ~'+est+'d.',[],mc('tab','research'));closeModal();render()}

function addScholarToResearch(dId){let r=state.activeResearch.find(x=>x.discoveryId===dId);if(!r)return;let s=alive().find(p=>p.role==='scholar'&&(p.assignment==='available'||p.assignment==='none')&&!r.scholarIds.includes(p.id));if(!s){addMessage('event','No additional scholars.');render();return}s.assignment='researching';r.scholarIds.push(s.id);addMessage('research',s.name+' joins research.',[],mc('tab','research'));render()}
function toggleScholarCrafting(pid){let p=getPerson(pid);if(!p)return;if(p.assignment==='crafting'){p.assignment='available';addMessage('event',p.name+' stops crafting compounds.',[],mc('tab','research'))}else{p.assignment='crafting';addMessage('event',p.name+' begins crafting compounds from carcasses. ('+state.carcasses+' available)',[],mc('tab','research'))}render()}
function toggleEngineerTrapping(pid){let p=getPerson(pid);if(!p)return;if(p.assignment==='trapping'){p.assignment='available';addMessage('event',p.name+' stops building traps.',[],mc('tab','engineering'))}else{p.assignment='trapping';addMessage('event',p.name+' begins building traps. Requires 1 wood per trap. (Wood: '+state.wood+')',[],mc('tab','engineering'))}render()}
function cancelResearch(dId){let idx=state.activeResearch.findIndex(r=>r.discoveryId===dId);if(idx===-1)return;let r=state.activeResearch[idx];let d=state.discoveries.find(x=>x.id===dId);r.scholarIds.forEach(id=>{let p=getPerson(id);if(p&&p.status==='active')p.assignment='available'});state.activeResearch.splice(idx,1);addMessage('research','Research on '+(d?d.label:'?')+' cancelled. Progress lost.',[],mc('tab','research'));render()}
function cancelBuild(){if(!state.activeBuild)return;let b=state.buildables.find(x=>x.id===state.activeBuild.buildableId);(state.activeBuild.engineerIds||[]).forEach(id=>{let p=getPerson(id);if(p&&p.status==='active')p.assignment='available'});let wRef=state.activeBuild.woodSpent||0;let mRef=state.activeBuild.metalSpent||0;state.wood+=wRef;state.metal+=mRef;state.activeBuild=null;addMessage('system','Construction of '+(b?b.label:'?')+' cancelled. Progress lost.'+(wRef>0||mRef>0?' Resources refunded: '+wRef+' wood'+(mRef>0?', '+mRef+' metal':'')+'.' :''),[],mc('tab','engineering'));render()}
function cancelDig(){if(!state.activeDig)return;let lvIdx=state.activeDig.levelIndex;let level=state.digLevels[lvIdx];let digName=(level&&level.named)?level.label:'Level '+(lvIdx+1);alive().filter(p=>p.assignment==='digging').forEach(p=>{p.assignment='available'});if(level)level.named=false;state.activeDig=null;addMessage('dig','Excavation of '+digName+' cancelled. Progress lost.',[],mc('tab','engineering'));render()}
function cancelMistExploration(idx){let me=state.mistExplorations[idx];if(!me)return;let mw=getPerson(me.mwId);if(mw){mw.status='active';mw.assignment='available'}state.mistExplorations.splice(idx,1);addMessage('expedition',me.mwName+' recalled from mist exploration. No findings.',[],mc('tab','expeditions'));render()}
function addDigger(){if(!state.activeDig)return;let digger=alive().find(p=>(p.role==='worker'||p.role==='engineer')&&(p.assignment==='available'||p.assignment==='none')&&p.status==='active');if(!digger){addMessage('event','No workers or engineers available.');render();return}digger.assignment='digging';addMessage('dig',digger.name+' ('+roleLabel(digger.role)+') joins excavation.',[],mc('tab','engineering'));render()}
function addEngineerToBuild(){if(!state.activeBuild)return;let eng=alive().find(p=>p.role==='engineer'&&(p.assignment==='available'||p.assignment==='none'));if(!eng){addMessage('event','No engineers available.');render();return}eng.assignment='building';state.activeBuild.engineerIds.push(eng.id);addMessage('system',eng.name+' joins construction (+30%).',[],mc('tab','engineering'));render()}

function startBuild(bId){if(state.activeBuild){addMessage('event','Already building.');render();return}let b=state.buildables.find(x=>x.id===bId);if(!b||b.built)return;let d=state.discoveries.find(x=>x.id===b.reqDiscovery);if(!d||!d.studied){addMessage('event','Research required discovery first.');render();return}let wc=b.woodCost||0;let mc2=b.metalCost||0;if(state.wood<wc||state.metal<mc2){addMessage('event','Not enough resources. Need '+wc+' wood, '+mc2+' metal. Have '+state.wood+' wood, '+state.metal+' metal.');render();return}let eng=alive().find(p=>p.role==='engineer'&&(p.assignment==='available'||p.assignment==='none'));if(!eng){addMessage('event','Need an engineer to build.');render();return}state.wood-=wc;state.metal-=mc2;eng.assignment='building';state.activeBuild={buildableId:bId,progress:0,totalDays:b.buildTime,engineerIds:[eng.id],woodSpent:wc,metalSpent:mc2};addMessage('system','Building '+b.label+'. '+b.buildTime+'d. Cost: '+wc+' wood'+(mc2>0?', '+mc2+' metal':'')+'. Engineer: '+eng.name,[],mc('tab','engineering'));render()}

function startDig(){if(state.activeDig){addMessage('event','Already digging.');render();return}let ni=state.digLevels.findIndex(l=>!l.cleared);if(ni===-1){addDigLevel();ni=state.digLevels.length-1}let avail=alive().filter(p=>(p.role==='worker'||p.role==='engineer')&&(p.assignment==='available'||p.assignment==='none')&&p.status==='active');if(avail.length===0){addMessage('event','Need a worker or engineer to dig.');render();return}if(avail.length===1){confirmDig(avail[0].id,ni);return}showDigModal(ni,avail)}
function showDigModal(ni,diggers){let lv=state.digLevels[ni];let digName=lv.named?lv.label:'Level '+(ni+1);let eH=diggers.map(e=>{let s=getPersonStats(e);let spd=s.digSpeed||1;return'<div class="item-row clickable" onclick="confirmDig('+e.id+','+ni+')"><div><span class="item-name">'+e.name+' ('+roleLabel(e.role)+')</span><br><span class="item-detail">Dig Speed: '+Math.round(spd*100)/100+'</span></div><button class="btn" onclick="confirmDig('+e.id+','+ni+')">Select</button></div>'}).join('');document.getElementById('modal-content').innerHTML='<h2>Excavation: '+digName+'</h2><p>Choose someone to lead the dig into unknown depths.</p>'+eH+'<div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal()}
function confirmDig(personId,levelIndex){let p=getPerson(personId);if(!p||p.status!=='active'){addMessage('event','Person unavailable.');closeModal();render();return}p.assignment='digging';state.activeDig={levelIndex:levelIndex,progress:0};let lv=state.digLevels[levelIndex];let digName=lv.named?lv.label:'Level '+(levelIndex+1);addMessage('dig','Excavation of '+digName+' begins. '+p.name+' leads the dig into unknown depths.',[],mc('tab','engineering'));closeModal();render()}

function scoutThreat(mwId,threatId){let mw=getPerson(mwId);let t=state.threats.find(x=>x.id===threatId);if(!mw||!t)return;if(mw.status!=='active'||mw.assignment!=='available'){addMessage('event',mw.name+' is not available to scout.',[],mc('person',mw.id));closeModal();render();return}mw.assignment='scouting';mw.status='scouting';t.scoutingMWId=mwId;t.scoutingEndDay=state.day+CONFIG.scoutingDays;let cr=state.creatures.find(c=>c.id===t.creatureId);addMessage('expedition',flavorText(FLAVOR.depart,{name:mw.name})+' Scouting '+t.direction+' for '+(cr?cr.label:'threat')+'. Returns in '+CONFIG.scoutingDays+'d.',[],mc('person',mw.id));closeModal();render()}
function showScoutModal(threatId){let t=state.threats.find(x=>x.id===threatId);if(!t)return;let cr=state.creatures.find(c=>c.id===t.creatureId);let mws=alive().filter(p=>p.role==='mistwalker'&&p.status==='active'&&p.assignment==='available');let mwH=mws.map(m=>'<div class="item-row clickable" onclick="scoutThreat('+m.id+',\''+t.id+'\')"><div><span class="item-name">'+m.name+'</span><br><span class="item-detail">Scout takes '+CONFIG.scoutingDays+'d — reveals exact count and arrival</span></div></div>').join('');document.getElementById('modal-content').innerHTML='<h2>Scout Threat</h2><p>'+(cr?cr.label:'Unknown')+' from the '+t.direction+' (est. '+(t.arrivalDayMin-state.day)+'-'+(t.arrivalDayMax-state.day)+'d)</p><p>Choose a Mistwalker:</p>'+mwH+'<div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal()}
function processScouting(){for(let t of state.threats){if(!t.scoutingMWId)continue;let mw=getPerson(t.scoutingMWId);if(!mw)continue;if(state.day>=t.scoutingEndDay){t.scouted=true;mw.status='active';mw.assignment='available';let cr=state.creatures.find(c=>c.id===t.creatureId);let daysUntil=t.actualArrivalDay-state.day;let crK=cr&&creatureKnown(cr.id);let statStr='';if(crK){let scoutAtk=cr.attack*t.count;let scoutDef=cr.defense*t.count;let wk=state.knownWeaknesses.includes(cr.id);if(wk){scoutAtk=Math.max(t.count,scoutAtk-cr.weaknessBonus*t.count);scoutDef=Math.max(t.count,scoutDef-cr.weaknessBonus*t.count)}statStr=' Total Atk: '+scoutAtk+', Def: '+scoutDef+(wk?' (weakness applied)':'')+'.';}let catStr=cr?' \u27d0 '+cr.category:'';addMessage('expedition',mw.name+' returns with intelligence: '+t.count+' '+(cr?cr.label:'threat')+catStr+' confirmed.'+statStr+' Arrives in '+daysUntil+'d.',[],mc('tab','dashboard'));delete t.scoutingMWId;delete t.scoutingEndDay}}}
function assignToDigging(pid){let p=getPerson(pid);if(!p||p.status!=='active')return;if(!state.activeDig){addMessage('event','No active dig.');closeModal();render();return}p.assignment='digging';addMessage('event',personTag(p)+' assigned to dig.',[],mc('person',pid));closeModal();render()}
function assignToBuilding(pid){let p=getPerson(pid);if(!p||p.status!=='active')return;if(!state.activeBuild){addMessage('event','No active build.');closeModal();render();return}p.assignment='building';if(!state.activeBuild.engineerIds)state.activeBuild.engineerIds=[];state.activeBuild.engineerIds.push(p.id);addMessage('event',personTag(p)+' assigned to build.',[],mc('person',pid));closeModal();render()}

function startSalvage(locId){let loc=state.locations.find(l=>l.id===locId);if(!loc||!loc.explored){addMessage('event','Location must be explored first.');render();return}if(state.salvageRuns.some(s=>s.locationId===locId)){addMessage('event','Already salvaging this location.');render();return}let eng=alive().find(p=>p.role==='engineer'&&(p.assignment==='available'||p.assignment==='none')&&p.status==='active');if(!eng){addMessage('event','No engineers available for salvage.');render();return}eng.assignment='salvaging';eng.status='expedition';let dur=loc.distance*2;state.salvageRuns.push({engineerId:eng.id,locationId:locId,daysOut:0,duration:dur});addMessage('event',eng.name+' departs to salvage '+loc.label+'. Returns in ~'+dur+'d.',[],mc('tab','engineering'));closeModal();render()}
function cancelSalvage(locId){let idx=state.salvageRuns.findIndex(s=>s.locationId===locId);if(idx===-1)return;let sr=state.salvageRuns[idx];let eng=getPerson(sr.engineerId);if(eng&&eng.status!=='dead'){eng.status='active';eng.assignment='available'}state.salvageRuns.splice(idx,1);addMessage('event',(eng?eng.name:'Engineer')+' recalled from salvage. No metal collected.',[],mc('tab','engineering'));render()}

function recallExpedition(expIndex,recallMWId){let exp=state.expeditions[expIndex];let mw=getPerson(recallMWId);if(!exp||!mw)return;if(mw.status!=='active'||mw.assignment!=='available'){addMessage('event',mw.name+' is not available.',[],mc('person',mw.id));closeModal();render();return}let remainingDays=exp.duration-exp.daysOut;let recallTravel=Math.max(1,Math.ceil(remainingDays/CONFIG.recallSpeedMultiplier));exp.recalling=true;exp.recallDay=state.day+recallTravel;exp.recallMWId=recallMWId;mw.assignment='recalling';mw.status='expedition';let leader=getPerson(exp.leaderId);addMessage('expedition',flavorText(FLAVOR.depart,{name:mw.name})+' Dispatched to recall '+(leader?leader.name:'expedition')+'. Will reach them in ~'+recallTravel+'d.',[],mc('tab','expeditions'));closeModal();render()}
function showRecallModal(expIndex){let exp=state.expeditions[expIndex];if(!exp)return;let loc=state.locations.find(l=>l.id===exp.locationId);let remainingDays=exp.duration-exp.daysOut;let mws=alive().filter(p=>p.role==='mistwalker'&&p.status==='active'&&p.assignment==='available');let mwH=mws.map(m=>{let travel=Math.max(1,Math.ceil(remainingDays/CONFIG.recallSpeedMultiplier));return'<div class="item-row clickable" onclick="recallExpedition('+expIndex+','+m.id+')"><div><span class="item-name">'+m.name+'</span><br><span class="item-detail">Travels at 2x speed. ~'+travel+'d to reach, then return journey.</span></div><button class="btn" onclick="recallExpedition('+expIndex+','+m.id+')">Dispatch</button></div>'}).join('');document.getElementById('modal-content').innerHTML='<h2>Recall Expedition</h2><p>Expedition to '+(loc?loc.label:'?')+' (day '+exp.daysOut+'/'+exp.duration+'). Team returns empty-handed.</p><p>Choose a Mistwalker to dispatch:</p>'+mwH+'<div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal()}
function resolveRecalledExpedition(exp){for(let id of exp.team){let p=getPerson(id);if(p&&p.status!=='dead'){p.status='active';p.assignment=getDefaultAssignment(p.role)}}let mw=getPerson(exp.recallMWId);if(mw&&mw.status==='expedition'){mw.status='active';mw.assignment='available'}if(exp.pendingInjury){let pi=getPerson(exp.leaderId);if(pi&&pi.status!=='dead'){injure(pi,exp.pendingInjury.days,exp.pendingInjury.cause)}}if(exp.compounds>0){state.compounds+=exp.compounds}let loc=state.locations.find(l=>l.id===exp.locationId);addMessage('expedition','Expedition recalled from '+(loc?loc.label:'?')+'. No discoveries — the team returns safely.'+(exp.compounds>0?' '+exp.compounds+' compound'+(exp.compounds>1?'s':'')+' returned.':''),[],mc('tab','expeditions'))}
// MIST EXPLORATION
function rollRingReward(ring){let total=ring.rewards.reduce((s,r)=>s+r.w,0);let roll=rand(total);let cum=0;for(let r of ring.rewards){cum+=r.w;if(roll<cum)return r.type}return'nothing'}
function getRingForDay(depth,dayNum){let rings=CONFIG.mistRings;if(depth==='shallows')return rings[0];if(depth==='greyreach')return dayNum<=3?rings[0]:rings[1];if(depth==='deep')return dayNum<=3?rings[0]:dayNum<=6?rings[1]:rings[2];return rings[0]}
function getMistCreatureForRing(ring){let maxTier=ring.id==='shallows'?1:ring.id==='greyreach'?2:3;let eligible=state.creatures.filter(c=>c.tier<=maxTier);return pick(eligible)||state.creatures[0]}
function ringMaxTier(ring){return ring.id==='shallows'?1:ring.id==='greyreach'?2:3}
function applyMistReward(type,ring){if(type==='location'||type==='discovery')return applyMistReward('food',ring);let mt=ringMaxTier(ring);if(type==='food'){let amts={shallows:[3,8],greyreach:[6,12],deep:[10,18]};let[mn,mx]=amts[ring.id]||[3,8];let amt=mn+rand(mx-mn+1);state.food+=amt;return{type:'food',amount:amt}}if(type==='survivor'){let name=pick(NAMES.survivors.filter(n=>!state.people.some(p=>p.name===n)));if(!name)return applyMistReward('food',ring);state.people.push({id:state.nextId++,name:name,role:'unassigned',assignment:'none',traits:{spirit:1+rand(3),body:1+rand(3),mind:1+rand(3)},exp:0,status:'active',completedTraining:[]});return{type:'survivor',name:name,_sound:'arrival'}}if(type==='weakness'){let opts=state.creatures.filter(c=>!state.knownWeaknesses.includes(c.id));if(opts.length===0)return applyMistReward('food',ring);let c=pick(opts);state.knownWeaknesses.push(c.id);revealCreature(c.id);return{type:'weakness',creature:c.label,category:c.category}}if(type==='artifact'){let rarity=rollRarity('daily');let a=generateEquipment(mt,rarity);a.found=true;state.artifacts.push(a);state.foundArtifacts.push(a.id);return{type:'artifact',label:a.label,rarity:rarity,_sound:'treasure'}}return null}
function getDistanceTier(d){return d>=7?3:d>=4?2:1}
let pendingTierConfirm=null;
let pendingCompoundConfirm=null;
function acceptCompoundWarning(){if(pendingCompoundConfirm){let fn=pendingCompoundConfirm;pendingCompoundConfirm=null;fn()}}
function checkTierWarning(newDist,callback){let curTier=getDistanceTier(state.maxDistanceTraveled);let newTier=getDistanceTier(newDist);if(newTier>curTier){let tierNames={2:'Tier 2 — Stronger creatures, larger packs',3:'Tier 3 — The most dangerous creatures emerge'};let warn=tierNames[newTier]||'Higher danger tier';pendingTierConfirm=callback;document.getElementById('modal-content').innerHTML='<h2>\u26a0 Danger Escalation</h2><p style="color:var(--danger-light);font-weight:bold">Pushing to distance '+newDist+' enters '+warn+'.</p><p>Venturing this far will draw attention from more powerful creatures. Threats to the monastery will escalate permanently.</p><p style="font-style:italic;color:var(--text-secondary)">Are you sure you want to proceed?</p><div class="modal-actions"><button class="btn" style="background:var(--danger);color:#fff" onclick="acceptTierWarning()">Proceed — Accept the risk</button><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal();return true}return false}
function acceptTierWarning(){if(pendingTierConfirm){let fn=pendingTierConfirm;pendingTierConfirm=null;fn()}}
function ringEffectiveDist(ringId){return ringId==='shallows'?2:ringId==='greyreach'?4:7}
function launchMistExploration(mwId,depth){let mw=getPerson(mwId);if(!mw||mw.status!=='active'||mw.assignment!=='available'){addMessage('event','Mistwalker not available.');render();return}let range=getMistWalkerRange(mwId);let ringDef=CONFIG.mistRings.find(r=>r.id===depth);if(!ringDef||range<ringDef.minRange){addMessage('event',mw.name+'\'s range ('+range+') insufficient for '+ringDef.label+'.');render();return}let effDist=ringEffectiveDist(depth);if(checkTierWarning(effDist,function(){confirmMistExploration(mwId,depth)}))return;confirmMistExploration(mwId,depth)}
function confirmMistExploration(mwId,depth){let mw=getPerson(mwId);if(!mw||mw.status!=='active'||mw.assignment!=='available'){closeModal();render();return}let range=getMistWalkerRange(mwId);let ringDef=CONFIG.mistRings.find(r=>r.id===depth);let effDist=ringEffectiveDist(depth);mw.status='expedition';mw.assignment='mistExplore';state.maxDistanceTraveled=Math.max(state.maxDistanceTraveled,effDist);if(depth==='shallows'&&state.maxDepthEntered==='none'){state.maxDepthEntered='shallows';addMessage('event','Mistwalker entered the Shallows.');}else if(depth==='greyreach'&&(state.maxDepthEntered==='none'||state.maxDepthEntered==='shallows')){state.maxDepthEntered='greyreach';addMessage('event','Mistwalker reached the Grey Reach.');}else if(depth==='deep'&&state.maxDepthEntered!=='deep'){state.maxDepthEntered='deep';addMessage('event','Mistwalker ventured into the Deep.');}state.mistExplorations.push({mwId:mwId,mwName:mw.name,depth:depth,totalDays:range,daysOut:0});let depthLabel=ringDef.label;addMessage('expedition',flavorText(FLAVOR.depart,{name:mw.name})+' Mist exploration — heading for '+depthLabel+'. ~'+range+'d.',[],mc('person',mwId));state.attention+=CONFIG.expeditionAttention;closeModal();render()}
function processMistExplorations(){for(let i=state.mistExplorations.length-1;i>=0;i--){let exp=state.mistExplorations[i];exp.daysOut++;if(exp.daysOut===Math.floor(exp.totalDays/2))addMessage('expedition',flavorText(FLAVOR.midway,{name:exp.mwName,day:String(exp.daysOut)}),[],mc('tab','expeditions'));if(exp.daysOut>=exp.totalDays){resolveMistExploration(exp);state.mistExplorations.splice(i,1)}}}
function resolveMistExploration(exp){let mw=getPerson(exp.mwId);if(!mw||mw.status==='dead')return;let findings=[];let injured=false;let injDays=0;let daysCompleted=0;for(let d=1;d<=exp.totalDays;d++){let ring=getRingForDay(exp.depth,d);daysCompleted=d;if(chance(ring.encounterChance)){let eligible=state.creatures;if(exp.depth==='shallows'){eligible=eligible.filter(c=>c.category==='physical');}else if(exp.depth==='greyreach'){eligible=eligible.filter(c=>c.category==='physical'||c.category==='corrupted');}let cr=pick(eligible)||pick(state.creatures);injured=true;injDays=ring.injuryMin+rand(ring.injuryMax-ring.injuryMin+1);findings.push({type:'encounter',label:'Ambushed by '+(cr?cr.label:'something')});break}let tierNum=exp.depth==='shallows'?1:exp.depth==='greyreach'?2:3;let unrevealed=state.locations.filter(l=>l.tier===tierNum&&!l.revealed);if(unrevealed.length>0&&chance(1)){let loc=pick(unrevealed);loc.revealed=true;loc.luckyFind=true;findings.push({type:'luckyFind',label:'Discovered '+loc.label+'!'});continue}if(chance(40)){let roll=rand(100);let clue=null;if(roll<60){let pool=state.clues.filter(c=>c.tier===exp.depth&&c.type==='location'&&!c.found);if(pool.length>0)clue=pick(pool)}if(clue){clue.found=true;clue.foundDay=state.day;state.pendingClues.push(clue.id);findings.push({type:'clue',clueType:clue.type,label:clue.label,targetLabel:clue.targetLabel});continue}}let mt=ringMaxTier(ring);let minorTypes=[{type:'food',w:30},{type:'survivor',w:20},{type:'weakness',w:15},{type:'artifact',w:15},{type:'nothing',w:20}];let tw=minorTypes.reduce((s,r)=>s+r.w,0);let mr=rand(tw);let cum=0;let mType='nothing';for(let r of minorTypes){cum+=r.w;if(mr<cum){mType=r.type;break}}let reward=applyMistReward(mType,ring);if(reward)findings.push(reward)}mw.status='active';if(injured){injure(mw,injDays,'wounded in the mist');mw.exp=Math.min(10,mw.exp+Math.min(2,Math.floor(daysCompleted/3)))}else{mw.assignment='available';mw.exp=Math.min(10,mw.exp+Math.min(3,Math.floor(daysCompleted/2)))}let clueCount=findings.filter(f=>f.type==='clue').length;let luckyCount=findings.filter(f=>f.type==='luckyFind').length;let otherFinds=findings.filter(f=>f.type!=='clue'&&f.type!=='luckyFind'&&f.type!=='encounter'&&f.type!=='nothing'&&f.type);let msg=exp.mwName+' returns from the '+(exp.depth==='shallows'?'Shallows':exp.depth==='greyreach'?'Grey Reach':'Deep')+'. ';if(clueCount>0)msg+=clueCount+' clue'+(clueCount>1?'s':'')+' recovered. ';if(luckyCount>0)msg+='Discovered a charted location! ';for(let f of otherFinds){if(f.type==='food')msg+='Found '+f.amount+' food. ';else if(f.type==='survivor')msg+='Rescued '+f.name+'. ';else if(f.type==='weakness')msg+='Learned '+f.creature+' weakness. ';else if(f.type==='artifact')msg+='Found '+f.label+'. '}if(injured)msg+='Injured en route.';addMessage('expedition',msg,[],mc('tab','expeditions'));let bestSound=findings.find(f=>f._sound);if(bestSound)tagLastSound(bestSound._sound);for(let f of findings){if(f.type==='clue')addMessage('research','Clue found: "'+f.label+'" — '+(f.clueType==='final'?'points toward the Source':'hints at '+f.targetLabel)+'.',[],mc('tab','research'));if(f.type==='luckyFind')addMessage('expedition',f.label+' Expedition ready.',[],mc('tab','expeditions'))}state.attention+=CONFIG.expeditionAttention}

function launchExpedition(locId){let loc=state.locations.find(l=>l.id===locId);if(!loc||!loc.revealed)return;let mw=alive().filter(p=>p.role==='mistwalker'&&p.assignment==='available');if(mw.length===0){addMessage('event','No mist walkers available.');render();return}showExpeditionModal(loc,mw)}

function confirmExpeditionLaunch(locId,leaderId,priestId,escortIds){let loc=state.locations.find(l=>l.id===locId);let leader=getPerson(leaderId);let range=getMistWalkerRange(leaderId);if(range<loc.distance){addMessage('event',leader.name+'\'s range ('+range+') < distance ('+loc.distance+').');closeModal();render();return}if(escortIds.length>0&&!priestId){addMessage('event','Escort needs priest shield.');closeModal();render();return}if(priestId&&escortIds.length>0){let pr=getPerson(priestId);let st=getPersonStats(pr);if(escortIds.length>(st.shields||2)){addMessage('event',pr.name+'\'s shield ('+( st.shields||2)+') too small for '+escortIds.length+' escort.');closeModal();render();return}}let expTeamSize=1+(priestId?1:0)+escortIds.length;let hasCorrupted=loc.scouted&&state.creatures.some(c=>c.category==='corrupted'&&c.locationIds.includes(loc.id));if(hasCorrupted&&state.compounds<expTeamSize&&state.compounds>0){pendingCompoundConfirm=function(){if(checkTierWarning(loc.distance,function(){doExpeditionLaunch(locId,leaderId,priestId,escortIds)}))return;doExpeditionLaunch(locId,leaderId,priestId,escortIds)};document.getElementById('modal-content').innerHTML='<h2>\u26a0 Low Compounds</h2><p>Corrupted creatures sighted at '+loc.label+'. Team needs '+expTeamSize+' compounds but only '+state.compounds+' available.</p><div class="modal-actions"><button class="btn" onclick="acceptCompoundWarning()">Proceed anyway</button><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal();return}if(hasCorrupted&&state.compounds===0){pendingCompoundConfirm=function(){if(checkTierWarning(loc.distance,function(){doExpeditionLaunch(locId,leaderId,priestId,escortIds)}))return;doExpeditionLaunch(locId,leaderId,priestId,escortIds)};document.getElementById('modal-content').innerHTML='<h2>\u26a0 No Compounds</h2><p>Corrupted creatures sighted at '+loc.label+' and the team has no anti-corruption compounds.</p><div class="modal-actions"><button class="btn" onclick="acceptCompoundWarning()">Proceed anyway</button><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal();return}if(checkTierWarning(loc.distance,function(){doExpeditionLaunch(locId,leaderId,priestId,escortIds)}))return;doExpeditionLaunch(locId,leaderId,priestId,escortIds)}
function doExpeditionLaunch(locId,leaderId,priestId,escortIds){let loc=state.locations.find(l=>l.id===locId);let leader=getPerson(leaderId);leader.assignment='expedition';leader.status='expedition';let team=[leaderId];if(priestId){let pr=getPerson(priestId);pr.assignment='expedition';pr.status='expedition';team.push(priestId)}escortIds.forEach(id=>{let p=getPerson(id);p.assignment='expedition';p.status='expedition';team.push(id)});state.maxDistanceTraveled=Math.max(state.maxDistanceTraveled,loc.distance);let dur=loc.distance*2+rand(3);let expCompounds=Math.min(state.compounds,team.length);state.compounds-=expCompounds;state.expeditions.push({locationId:loc.id,leaderName:leader.name,leaderId:leaderId,priestId:priestId||0,team:team,daysOut:0,duration:dur,compounds:expCompounds});state.attention+=CONFIG.expeditionAttention;addMessage('expedition',flavorText(FLAVOR.depart,{name:leader.name})+' Expedition to '+loc.label+'. ~'+dur+'d. Team: '+team.map(id=>personTag(getPerson(id))).join(', ')+(expCompounds>0?'. Carrying '+expCompounds+' compound'+(expCompounds>1?'s':'')+'.' :''),[],mc('tab','expeditions'));closeModal();render()}

function endGame(reason){state.gameOver=true;document.getElementById('gameover-reason').textContent=reason;document.getElementById('gameover-stats').textContent='Survived '+state.day+'d. '+alive().length+' alive. '+state.studiedDiscoveries.length+' researched. '+state.exploredLocations.length+' explored.';document.getElementById('gameover').classList.add('open')}

// RENDERING
function render(){renderHeader();renderFeed();renderDashboard();renderPeople();renderExpeditions();renderResearch();renderEngineering();renderArtifacts();updateTabIndicators()}
function updateTabIndicators(){let tabs=document.querySelectorAll('.tab');tabs.forEach(t=>{t.classList.remove('has-action');t.classList.remove('has-new')});let ppl=alive().filter(p=>p.role==='unassigned').length>0;let schAvail=alive().some(p=>p.role==='scholar'&&(p.assignment==='available'||p.assignment==='none')&&p.status==='active');let schCrafting=alive().some(p=>p.role==='scholar'&&p.assignment==='crafting');let unresearched=state.discoveries.some(d=>d.found&&!d.studied&&!state.activeResearch.some(r=>r.discoveryId===d.id));let undeciphered=state.pendingClues.some(id=>{let c=state.clues.find(x=>x.id===id);return c&&!c.deciphered&&!state.activeDeciphering.some(d=>d.clueId===id)});let res=(schAvail&&(unresearched||undeciphered))||schCrafting;let eng=(!state.activeDig||!state.activeBuild)&&alive().some(p=>p.role==='engineer'&&(p.assignment==='available'||p.assignment==='none'))&&((!state.activeDig&&state.digLevels.some((l,i)=>!l.cleared&&(i===0||state.digLevels[i-1].cleared)))||(!state.activeBuild&&state.buildables.some(b=>!b.built&&state.studiedDiscoveries.includes(b.reqDiscovery))));let exp=alive().some(p=>p.role==='mistwalker'&&p.assignment==='available'&&p.status==='active');let art=state.artifacts.some(a=>a.found&&!state.seenArtifacts.includes(a.id));let newStates={people:ppl,research:res,engineering:eng,expeditions:exp,artifacts:art};for(let[tab,active] of Object.entries(newStates)){if(active){let t=document.querySelector('.tab[data-tab="'+tab+'"]');if(t)t.classList.add('has-action')}}lastTabStates=Object.assign({},newStates)}

let lastRenderedDay=0;let lastRenderedPop=0;let headerDayInit=false;
function renderHeader(){let dayEl=document.getElementById('header-day');lastRenderedDay=state.day;if(!headerDayInit){dayEl.innerHTML='<span class="ver">'+VERSION+'</span><span class="day-num" id="day-num-span">Day '+state.day+'</span>';headerDayInit=true}else{let dn=document.getElementById('day-num-span');if(dn)dn.textContent='Day '+state.day}let fn=Math.round((getFoodProduction()-getFoodConsumption())*10)/10;let fc=state.food<20?'danger':state.food<50?'warning':'good';let ps=getPerimeterStability();let pc=ps<50?'danger':ps<100?'warning':'good';let hPopTip='Mistwalkers: '+byRole('mistwalker').length+'\nMystics: '+byRole('mystic').length+'\nPriests: '+byRole('priest').length+'\nFighters: '+byRole('fighter').length+'\nWorkers: '+byRole('worker').length+'\nScholars: '+byRole('scholar').length+'\nEngineers: '+byRole('engineer').length+'\nUnassigned: '+byRole('unassigned').length;let hInj=alive().filter(p=>p.status==='injured').length;if(hInj>0)hPopTip+='\nInjured: '+hInj;let hFoodTip=alive().filter(p=>p.assignment==='farms').map(p=>{if(p.role==='worker'){let s=getPersonStats(p);return p.name+', Yield: '+((s.yield||3)+getGlobalBuff('food'))}return p.name+', Yield: 2'}).join('\n');if(getGlobalBuff('food')>0)hFoodTip+='\nGlobal Buff: +'+getGlobalBuff('food');hFoodTip+='\nConsumption: '+getFoodConsumption()+' ('+alive().length+' people)';let hPb=getPerimeterBreakdown();let hPerimTip=hPb.map(d=>d.name+', Contrib: '+d.contrib+'%').join('\n');if(ps<100){let hGap=100-ps;hPerimTip+='\n\nGap: '+hGap+'%';hPerimTip+='\nDefense reduced by '+hGap+'%';hPerimTip+='\n'+Math.round(hGap*10)/100+'% daily risk per exposed person';hPerimTip+='\n'+Math.round(hGap*10)/100+'% daily food spoilage'}let hDb=getDefenseBreakdown();let hDefTip=hDb.detail.map(d=>d.name+', Def: '+d.defense).join('\n');if(hDb.gap>0)hDefTip+='\n\nPerimeter gap: -'+hDb.gap+'% ('+hDb.rawTotal+' \u2192 '+hDb.total+')';let hAtkVal='None';let hAtkColor='';let hAtkTip='Detection range: '+getDetectionRange()+' days';let hNextAtk=state.threats.filter(t=>t.status==='approaching');if(hNextAtk.length>0){hNextAtk.sort((a,b)=>(a.scouted?a.actualArrivalDay:a.arrivalDayMin)-(b.scouted?b.actualArrivalDay:b.arrivalDayMin));let nt=hNextAtk[0];let cr=state.creatures.find(c=>c.id===nt.creatureId);if(nt.scouted){let dl=nt.actualArrivalDay-state.day;hAtkVal=dl+'d';hAtkColor=dl<=1?'danger':'warning'}else{let minD=nt.arrivalDayMin-state.day;let maxD=nt.arrivalDayMax-state.day;hAtkVal=minD+'-'+maxD+'d';hAtkColor=minD<=2?'danger':'warning'}hAtkTip+=(cr?'\n'+cr.label+' \u27d0 '+cr.category:'');hAtkTip+='\nCount: '+(nt.scouted?nt.count+' confirmed':'~'+nt.count+' est.');if(hNextAtk.length>1)hAtkTip+='\n+'+(hNextAtk.length-1)+' more threat(s)'}let hWoodTip=alive().filter(p=>p.assignment==='chopping').length+' chopping';let hMetalTip=state.salvageRuns.length+' salvaging';let curPop=alive().length;lastRenderedPop=curPop;let foodNeg=fn<0;let foodCls=foodNeg?'danger'+(state.food<20?' food-pulse':''):fc;document.getElementById('header-stats').innerHTML='<div class="stat" data-tip="'+hPopTip+'"><span class="stat-label">Pop:</span> <span class="stat-value">'+curPop+'</span></div><div class="stat" data-tip="'+hFoodTip+'"><span class="stat-label">Food:</span> <span class="stat-value '+foodCls+'">'+Math.round(state.food)+'</span> <span class="stat-label'+(foodNeg?' food-pulse" style="color:var(--danger-light)':'')+'">('+( fn>=0?'+':'')+fn+'/d)</span></div><div class="stat" data-tip="'+hPerimTip+'"><span class="stat-label">Perim:</span> <span class="stat-value '+pc+'">'+ps+'%</span></div><div class="stat" data-tip="'+hDefTip+'"><span class="stat-label">Def:</span> <span class="stat-value">'+getDefenseStrength()+'</span></div><div class="stat" data-tip="'+hAtkTip+'"><span class="stat-label">Atk:</span> <span class="stat-value'+(hAtkColor?' '+hAtkColor:'')+'">'+hAtkVal+'</span></div><div class="stat" data-tip="'+hWoodTip+'"><span class="stat-label">Wood:</span> <span class="stat-value">'+state.wood+'</span></div><div class="stat" data-tip="'+hMetalTip+'"><span class="stat-label">Metal:</span> <span class="stat-value">'+state.metal+'</span></div>'}

function renderFeed(){let c=document.getElementById('feed-scroll');let fl=document.getElementById('feed-filter-label');let curFilter=feedFilterTypes[feedFilterIdx];if(fl){fl.textContent=(curFilter==='all'?'All \u25BE':curFilter.charAt(0).toUpperCase()+curFilter.slice(1)+' \u25BE');fl.style.color=feedFilterColors[curFilter]||'var(--text-muted)'}let msgs=feedFilteredMsgs();let html='';let cd=-1;for(let i=0;i<msgs.length;i++){let m=msgs[i];if(m.day!==cd){cd=m.day;html+='<div class="day-header">\u2014 Day '+cd+' \u2014</div>'}let ah='';if(m.actions&&m.actions.length>0)ah='<div class="msg-actions">'+m.actions.map(a=>'<button class="btn" onclick="'+a.action+'">'+a.label+'</button>').join('')+'</div>';let clk=m.clickAction?' clickable" onclick="handleFeedClick('+i+')':'';html+='<div class="message cat-'+m.category+clk+'"><div class="msg-category">'+m.category.toUpperCase()+'</div><div class="msg-text">'+m.text+(m.clickAction?' <span class="msg-goto">\u203a</span>':'')+'</div>'+ah+'</div>'}if(!html)html='<div class="empty-state">'+(curFilter==='all'?'The monastery awaits.':'No '+curFilter+' messages.')+'</div>';c.innerHTML=html}

function renderDashboard(){let c=document.getElementById('view-dashboard');let db=getDefenseBreakdown();let fn=Math.round((getFoodProduction()-getFoodConsumption())*10)/10;let fc=state.food<20?'danger':state.food<50?'warning':'good';let ps=getPerimeterStability();let pc=ps<50?'danger':ps<100?'warning':'good';let pb=getPerimeterBreakdown();let pPriestCount=alive().filter(p=>p.assignment==='perimeter').length;let df=fn<0?Math.floor(state.food/Math.abs(fn)):'\u221e';
let sysH='';if(state.builtSystems.length>0||state.activeBuild){sysH='<div class="section-title">Systems</div>';for(let bId of state.builtSystems){let b=state.buildables.find(x=>x.id===bId);sysH+='<div class="item-row"><span class="item-name">'+b.label+'</span><span class="status-good">'+b.effectLabel+'</span></div>'}if(state.activeBuild){let b=state.buildables.find(x=>x.id===state.activeBuild.buildableId);let pct=Math.round(state.activeBuild.progress/state.activeBuild.totalDays*100);sysH+='<div class="item-row"><span class="item-name">'+b.label+'</span><span class="status-warn">Building '+pct+'%</span></div>'}}
let trH='';if(state.training.length>0){trH='<div class="section-title">Training</div>';for(let t of state.training){let p=getPerson(t.personId);let pct=Math.round((t.totalDays-t.daysRemaining)/t.totalDays*100);trH+='<div class="item-row"><span class="item-name">'+(p?p.name:'?')+' \u2192 '+roleLabel(t.targetRole)+'</span><span class="status-warn">'+t.daysRemaining+'d ('+pct+'%)</span></div>'}}
let thH='';let app=state.threats.filter(t=>t.status==='approaching');if(app.length>0){thH='<div class="section-title" style="color:var(--danger-light)">Incoming Threats</div>';for(let t of app){let cr=state.creatures.find(c=>c.id===t.creatureId);let wk=cr&&state.knownWeaknesses.includes(cr.id);let countStr=t.scouted?t.count+' confirmed':'~'+t.count+' est.';let eAtk=cr?cr.attack*t.count:0;let eDef=cr?cr.defense*t.count:0;if(wk){eDef=Math.max(t.count,eDef-cr.weaknessBonus*t.count)}let timeStr='';if(t.scouted){let dl=t.actualArrivalDay-state.day;timeStr=dl<=1?'<strong style="color:var(--danger-light)">TOMORROW</strong>':'arrives in '+dl+'d'}else{let minD=Math.max(0,t.arrivalDayMin-state.day);let maxD=Math.max(0,t.arrivalDayMax-state.day);timeStr=minD<=1?'<strong style="color:var(--danger-light)">IMMINENT</strong>':'arrives in ~'+minD+'-'+maxD+'d'}let scoutBtn='';if(!t.scouted&&!t.scoutingMWId){let hasMW=alive().some(p=>p.role==='mistwalker'&&p.status==='active'&&p.assignment==='available');scoutBtn=hasMW?'<button class="btn" onclick="showScoutModal(\''+t.id+'\')" style="margin-left:8px">Scout</button>':'<span class="item-detail" style="margin-left:8px">(no MW to scout)</span>'}else if(t.scoutingMWId){let scMW=getPerson(t.scoutingMWId);scoutBtn='<span class="item-detail" style="margin-left:8px">Scouting... '+(scMW?scMW.name:'')+'</span>'}let crKnown=cr&&creatureKnown(cr.id);let catTag=cr?' \u27d0 '+cr.category:'';let dashMystic=getMysticInGarrison();let warnStr='';if(cr&&cr.category==='spiritual'&&!dashMystic)warnStr='<br><span class="item-detail" style="color:var(--danger-light)">No Mystic — spiritual defense compromised!</span>';if(cr&&cr.category==='corrupted'&&state.compounds===0)warnStr='<br><span class="item-detail" style="color:var(--danger-light)">No compounds — corrupted defense compromised!</span>';thH+='<div class="item-row"><div><span class="item-name">'+(cr?cr.label:'?')+catTag+' '+(crKnown?'(Atk: '+cr.attack+', Def: '+cr.defense+')':'(unknown)')+' \u2014 '+countStr+' from '+t.direction+'</span><br><span class="item-detail">'+(crKnown?'Total Atk: '+eAtk+' | Total Def: '+eDef+(wk?' (weakness known)':''):'Stats unknown — must encounter or research first')+'</span><br><span class="item-detail">'+timeStr+'</span>'+warnStr+'</div><div style="text-align:right"><span class="status-bad">'+(t.scouted?'in '+(t.actualArrivalDay-state.day)+'d':'~'+(Math.max(0,t.arrivalDayMin-state.day))+'-'+(Math.max(0,t.arrivalDayMax-state.day))+'d')+'</span>'+scoutBtn+'</div></div>'}}
let foodWorkers=alive().filter(p=>p.assignment==='farms');let foodYB=getGlobalBuff('food');let foodTip=foodWorkers.map(p=>{if(p.role==='worker'){let s=getPersonStats(p);return p.name+', Yield: '+((s.yield||3)+foodYB)}return p.name+', Yield: 2'}).join('\n');if(foodYB>0)foodTip+='\nGlobal Buff: +'+foodYB;foodTip+='\nConsumption: '+getFoodConsumption()+' ('+alive().length+' people)';let defTip=db.detail.map(d=>d.name+', Def: '+d.defense).join('\n');if(db.gap>0)defTip+='\n\nPerimeter gap: -'+db.gap+'% ('+db.rawTotal+' \u2192 '+db.total+')';let perimTip=pb.map(d=>d.name+', Contrib: '+d.contrib+'%').join('\n');if(ps<100){let gap=100-ps;perimTip+='\n\nGap: '+gap+'%';perimTip+='\nDefense reduced by '+gap+'%';perimTip+='\n'+Math.round(gap*10)/100+'% daily risk per exposed person';perimTip+='\n'+Math.round(gap*10)/100+'% daily food spoilage'}let nextAtk=state.threats.filter(t=>t.status==='approaching');let naTip='Detection range: '+getDetectionRange()+' days';let naVal='None';let naColor='success-light';if(nextAtk.length>0){nextAtk.sort((a,b)=>(a.scouted?a.actualArrivalDay:a.arrivalDayMin)-(b.scouted?b.actualArrivalDay:b.arrivalDayMin));let nt=nextAtk[0];if(nt.scouted){let dl=nt.actualArrivalDay-state.day;naVal='Day '+nt.actualArrivalDay;naColor=dl<=1?'danger-light':dl<=3?'warning-light':'text-secondary'}else{naVal='~Day '+nt.arrivalDayMin+'-'+nt.arrivalDayMax;let minD=nt.arrivalDayMin-state.day;naColor=minD<=2?'danger-light':'warning-light'}let cr=state.creatures.find(c=>c.id===nt.creatureId);naTip+=(cr?'\n'+cr.label+' \u27d0 '+cr.category:'');naTip+='\nCount: '+(nt.scouted?nt.count+' confirmed':'~'+nt.count+' est.');if(nextAtk.length>1)naTip+='\n+'+(nextAtk.length-1)+' more threat(s)'}let popTip='Mistwalkers: '+byRole('mistwalker').length+'\nMystics: '+byRole('mystic').length+'\nPriests: '+byRole('priest').length+'\nFighters: '+byRole('fighter').length+'\nWorkers: '+byRole('worker').length+'\nScholars: '+byRole('scholar').length+'\nEngineers: '+byRole('engineer').length+'\nUnassigned: '+byRole('unassigned').length;let injCount=alive().filter(p=>p.status==='injured').length;if(injCount>0)popTip+='\nInjured: '+injCount;let unexploredLocs=state.locations.filter(l=>l.revealed&&!l.explored);let exploredLocsList=state.locations.filter(l=>l.revealed&&l.explored);let expTip='Unexplored: '+unexploredLocs.length;for(let el of unexploredLocs)expTip+='\n  '+el.label;expTip+='\nExplored: '+exploredLocsList.length;for(let el of exploredLocsList)expTip+='\n  '+el.label;let knownLocs=state.locations.filter(l=>l.revealed).length;let unstudiedDiscs=state.discoveries.filter(d=>d.found&&!d.studied);let studiedDiscs=state.discoveries.filter(d=>d.studied);let resTip='Unstudied: '+unstudiedDiscs.length;for(let ud of unstudiedDiscs)resTip+='\n  '+ud.label;resTip+='\nStudied: '+studiedDiscs.length;for(let sd of studiedDiscs)resTip+='\n  '+sd.label;let researchedCount=state.studiedDiscoveries.length;let availResearch=state.discoveries.filter(d=>d.found&&!d.studied&&!state.activeResearch.some(r=>r.discoveryId===d.id)).length;let activeResearch=state.activeResearch.length;let levelsCleared=state.digLevels.filter(l=>l.cleared).length;let excTip='Levels cleared: '+levelsCleared;if(state.activeDig){let digLv=state.digLevels[state.activeDig.levelIndex];let digPpl=alive().filter(p=>p.assignment==='digging');let pctDig=Math.round(state.activeDig.progress/digLv.laborDays*100);excTip+='\n'+digLv.label+' in progress ('+pctDig+'%)';if(digPpl.length>0)excTip+='\n'+digPpl.map(p=>p.name).join(', ')}c.innerHTML='<div class="dashboard-grid"><div class="dash-card"><h3>Food</h3><div class="dash-value" data-tip="'+foodTip+'" style="color:var(--'+(fc==='good'?'success-light':fc==='warning'?'warning-light':'danger-light')+')">'+Math.round(state.food)+'</div><div class="dash-detail">'+getFoodProduction()+' prod / '+getFoodConsumption()+' cons ('+(fn>=0?'+':'')+fn+'/d)</div><div class="dash-detail">'+(fn<0?'~'+df+'d left':'Surplus')+'</div></div><div class="dash-card"><h3>Perimeter</h3><div class="dash-value" data-tip="'+perimTip+'" style="color:var(--'+(pc==='good'?'success-light':pc==='warning'?'warning-light':'danger-light')+')">'+ps+'%</div><div class="dash-detail">'+pPriestCount+' priests</div></div><div class="dash-card"><h3>Population</h3><div class="dash-value" data-tip="'+popTip+'">'+alive().length+'</div><div class="dash-detail">'+(injCount>0?'<span style="color:var(--danger-light)">'+injCount+' injured</span>':'All healthy')+'</div></div><div class="dash-card"><h3>Defense</h3><div class="dash-value" data-tip="'+defTip+'">'+db.total+'</div><div class="dash-detail">'+db.detail.length+' defenders</div></div></div><div class="dashboard-grid"><div class="dash-card"><h3>Exploration</h3><div class="dash-value" data-tip="'+expTip+'">'+unexploredLocs.length+'</div><div class="dash-detail">'+(unexploredLocs.length>0?unexploredLocs.length+' unexplored':'All explored')+' of '+knownLocs+' known</div></div><div class="dash-card"><h3>Research</h3><div class="dash-value" data-tip="'+resTip+'">'+researchedCount+'</div><div class="dash-detail">'+(availResearch>0?availResearch+' awaiting':'')+(activeResearch>0?(availResearch>0?' | ':'')+activeResearch+' in progress':'')+(availResearch===0&&activeResearch===0?'No discoveries to research':'')+'</div></div></div><div class="dashboard-grid"><div class="dash-card"><h3>Next Attack</h3><div class="dash-value" data-tip="'+naTip+'" style="color:var(--'+naColor+')">'+naVal+'</div></div><div class="dash-card"><h3>Excavation</h3><div class="dash-value" data-tip="'+excTip+'">Level '+levelsCleared+'</div><div class="dash-detail">'+(state.activeDig?'Digging... '+alive().filter(p=>p.assignment==='digging').length+' digger(s)':'Idle')+'</div></div></div>'+(state.carcasses>0||state.compounds>0||state.traps>0||alive().some(p=>p.assignment==='crafting'||p.assignment==='trapping')?'<div class="dashboard-grid"><div class="dash-card"><h3>Carcasses</h3><div class="dash-value">'+state.carcasses+'</div><div class="dash-detail">From creature kills</div></div><div class="dash-card"><h3>Compounds</h3><div class="dash-value" data-tip="'+alive().filter(p=>p.assignment==='crafting').length+' scholars crafting (requires carcasses)">'+state.compounds+'</div><div class="dash-detail">'+alive().filter(p=>p.assignment==='crafting').length+' crafting</div></div><div class="dash-card"><h3>Traps</h3><div class="dash-value" data-tip="'+alive().filter(p=>p.assignment==='trapping').length+' engineers trapping (reduces enemy atk by 2 each)">'+state.traps+'</div><div class="dash-detail">'+alive().filter(p=>p.assignment==='trapping').length+' building</div></div></div>':'')+thH+sysH+trH}

function renderPeople(){let c=document.getElementById('view-people');let gs=[{r:'unassigned',l:'\u2753 Unassigned'},{r:'mistwalker',l:'🥾 Mistwalkers'},{r:'priest',l:'\u2728 Priests'},{r:'mystic',l:'\ud83d\udd2e Mystics'},{r:'fighter',l:'\u2694\ufe0f Fighters'},{r:'scholar',l:'\ud83d\udcdc Scholars'},{r:'engineer',l:'\ud83d\udd27 Engineers'},{r:'alchemist',l:'🧪 Alchemists'},{r:'worker',l:'\ud83c\udf3e Workers'}];let trainingPpl=alive().filter(p=>p.role==='training');if(trainingPpl.length>0){let insertIdx=gs.findIndex(g=>g.r!=='unassigned');if(insertIdx<0)insertIdx=gs.length;gs.splice(insertIdx,0,{r:'training',l:'\ud83c\udfaf Training'})};let infirmaryPpl=alive().filter(p=>p.status==='injured'||p.assignment==='tending');let infirmaryIds=new Set(infirmaryPpl.map(p=>p.id));let html='';function renderPersonRow(p){let det=getAssignmentLabel(p);let st=getPersonStats(p);let ss=Object.entries(st).map(([k,v])=>k+':'+( typeof v==='number'?Math.round(v*10)/10:v)).join(' ');let garBadge=(p.assignment==='garrison'&&p.role!=='fighter')?'<span class="garrison-badge">GARRISON</span>':'';let cancelBtn=p.status==='training'?'<button class="btn" onclick="event.stopPropagation();cancelTraining('+p.id+')" style="margin-left:8px;font-size:0.7rem;padding:2px 6px">Cancel</button>':'';return'<div class="item-row clickable" onclick="showPersonModal('+p.id+')"><div><span class="item-name">'+p.name+'</span>'+garBadge+' <span class="item-detail">'+det+'</span><br><span class="item-detail">'+ss+'</span></div><span class="item-status '+(p.status==='injured'||p.status==='lost'?'status-bad':p.status==='expedition'||p.status==='rescuing'?'status-expedition':p.status==='training'?'status-warn':'status-good')+'">'+p.status+(p.status==='injured'?' ('+p.injuryDays+'d)':p.status==='lost'?' ('+(state.day-p.lostDay)+'d)':'')+cancelBtn+'</span></div>'}for(let g of gs){let pp=alive().filter(p=>p.role===g.r&&!infirmaryIds.has(p.id));if(pp.length===0)continue;html+='<div class="role-group"><div class="role-header">'+g.l+' ('+pp.length+')</div>';for(let p of pp)html+=renderPersonRow(p);html+='</div>';if(g.r==='training'||(g.r==='unassigned'&&trainingPpl.length===0)){if(infirmaryPpl.length>0){html+='<div class="role-group"><div class="role-header">\ud83c\udfe5 Infirmary ('+infirmaryPpl.length+')</div>';for(let p of infirmaryPpl)html+=renderPersonRow(p);html+='</div>'}}}let dead=state.people.filter(p=>p.status==='dead').sort((a,b)=>(b.deathDay||0)-(a.deathDay||0));if(dead.length>0){html+='<div class="role-group"><div class="role-header">Fallen ('+dead.length+')</div>';for(let p of dead)html+='<div class="item-row clickable" style="opacity:0.5" onclick="showPersonModal('+p.id+')"><span class="item-name">'+p.name+' ('+roleLabel(p.role)+')</span><span class="status-bad">fallen day '+p.deathDay+'</span></div>';html+='</div>'}c.innerHTML=html}

function getAssignmentLabel(p){if(p.status==='injured'){let hasTending=alive().some(x=>x.role==='priest'&&x.assignment==='tending');return'Injured \u2014 Recovery: '+(p.injuryDays||'?')+'d'+(hasTending?' (tended)':'')}if(p.assignment==='perimeter')return'Perimeter';if(p.assignment==='garrison')return'Garrison';if(p.assignment==='farms')return p.role==='worker'?'Farms':'Farms (reduced)';if(p.assignment==='expedition')return'Expedition';if(p.assignment==='training'){let t=state.training.find(t=>t.personId===p.id);return t?'Training \u2192 '+roleLabel(t.targetRole)+' ('+t.daysRemaining+'d)':'Training'}if(p.assignment==='researching')return'Researching';if(p.assignment==='digging')return'Excavating';if(p.assignment==='building')return'Building';if(p.assignment==='tending'){let injCount=alive().filter(x=>x.status==='injured').length;return'Tending injured ('+injCount+')'}if(p.assignment==='crafting')return'Crafting compounds';if(p.assignment==='deciphering'){let dc=state.activeDeciphering.find(d=>d.scholarIds&&d.scholarIds.includes(p.id));let cl=dc?state.clues.find(c=>c.id===dc.clueId):null;return'Deciphering '+(cl?cl.type+' clue':'clue')}if(p.assignment==='trapping')return'Building traps';if(p.assignment==='chopping')return'Chopping wood';if(p.assignment==='herbgarden')return'Cultivating herbs';if(p.assignment==='brewing'){let recipe=state.knownRecipes.find(r=>r.id===p.brewingRecipe);return'Brewing'+(recipe?' '+recipe.name:'')}if(p.assignment==='experimenting')return'Experimenting';if(p.assignment==='salvaging'){let sr=state.salvageRuns.find(s=>s.engineerId===p.id);let loc=sr?state.locations.find(l=>l.id===sr.locationId):null;return'Salvaging '+(loc?loc.label:'location')+' ('+(sr?sr.daysOut+'/'+sr.duration+'d':'')+')'}if(p.assignment==='scouting')return'Scouting threat';if(p.assignment==='recalling')return'Recalling expedition';if(p.assignment==='mistExplore'){let me=state.mistExplorations.find(e=>e.mwId===p.id);return me?'Exploring mist ('+me.daysOut+'/'+me.totalDays+'d)':'Exploring the mist'}if(p.assignment==='resting')return'Resting';if(p.assignment==='lost')return'Lost in the mist'+(p.lostDay?' ('+(state.day-p.lostDay)+'d)':'');if(p.assignment==='rescuing'){let tgt=getPerson(p.rescueTarget);return'Rescuing '+(tgt?tgt.name:'someone')}if(p.assignment==='available')return'Available';return'Idle'}

function renderExpeditions(){let c=document.getElementById('view-expeditions');let availMW=alive().filter(p=>p.role==='mistwalker'&&p.assignment==='available');let expMW=alive().filter(p=>p.role==='mistwalker'&&p.status==='expedition');let totalMW=byRole('mistwalker').length;let injuredMW=alive().filter(p=>p.role==='mistwalker'&&p.status==='injured');let injStr='';if(injuredMW.length>0){let soonest=Math.min(...injuredMW.map(p=>p.injuryDays||99));injStr=' \u2014 '+injuredMW.length+' injured, next ready in '+soonest+'d'}let html='<div class="item-row" style="margin-bottom:12px;border-left:3px solid var(--expedition-light)"><span class="item-name">Mistwalkers: <span class="'+(availMW.length>0?'status-good':'status-bad')+'">'+availMW.length+' available</span></span><span class="item-detail">'+expMW.length+' on expedition / '+totalMW+' total'+injStr+'</span></div>';let mwCandidates=alive().filter(p=>p.completedTraining.includes('fighter')&&p.completedTraining.includes('priest')&&meetsTraitReq(p,'mistwalker')&&p.role!=='mistwalker'&&p.role!=='training'&&!p.mwPermFail);if(mwCandidates.length>0){html+='<div class="item-row" style="margin-bottom:12px;border-left:3px solid var(--expedition-light);background:rgba(100,180,255,0.05)"><span class="item-detail" style="color:var(--expedition-light)">MW Candidates: '+mwCandidates.map(p=>'<span class="clickable" style="text-decoration:underline;cursor:pointer" onclick="showPersonModal('+p.id+')">'+p.name+'</span>').join(', ')+' \u2014 eligible for Mistwalker training</span></div>'}let lostPpl=state.people.filter(p=>p.status==='lost');if(lostPpl.length>0){html+='<div class="section-title" style="color:var(--danger-light)">Lost in the Mist</div>';for(let lp of lostPpl){let daysLost=state.day-lp.lostDay;let daysLeft=10-daysLost;let rescueMWs=alive().filter(m=>m.role==='mistwalker'&&m.status==='active'&&m.assignment==='available');html+='<div class="item-row"><div><span class="item-name" style="color:var(--danger-light)">'+lp.name+' ('+roleLabel(lp.role)+')</span><br><span class="item-detail">Lost '+daysLost+'d ago \u2014 '+daysLeft+'d to rescue</span></div><div style="text-align:right">'+(rescueMWs.length>0?rescueMWs.map(m=>'<button class="btn" onclick="rescueLost('+m.id+','+lp.id+')" style="margin:2px">Send '+m.name+'</button>').join(''):'<span class="item-detail" style="color:var(--danger-light)">No MW available</span>')+'</div></div>'}}let expThreats=state.threats.filter(t=>t.status==='approaching');if(expThreats.length>0){html+='<div class="section-title" style="color:var(--danger-light)">Incoming Threats</div>';for(let t of expThreats){let cr=state.creatures.find(c=>c.id===t.creatureId);let countStr=t.scouted?t.count+' confirmed':'~'+t.count+' est.';let timeStr='';if(t.scouted){let dl=t.actualArrivalDay-state.day;timeStr=dl<=1?'TOMORROW':'arrives in ~'+dl+'d'}else{let minD=Math.max(0,t.arrivalDayMin-state.day);let maxD=Math.max(0,t.arrivalDayMax-state.day);timeStr=minD<=1?'IMMINENT':'arrives in ~'+minD+'-'+maxD+'d'}let scoutBtn='';if(!t.scouted&&!t.scoutingMWId){let hasMW=alive().some(p=>p.role==='mistwalker'&&p.status==='active'&&p.assignment==='available');scoutBtn=hasMW?'<button class="btn" onclick="showScoutModal(\''+t.id+'\')" style="margin:2px">Scout</button>':''}html+='<div class="item-row"><div><span class="item-name" style="color:var(--danger-light)">'+(cr?cr.label:'?')+' \u27d0 '+(cr?cr.category:'?')+' \u2014 '+countStr+'</span><br><span class="item-detail">'+timeStr+' from '+t.direction+'</span></div><div style="text-align:right">'+scoutBtn+'</div></div>'}}if(state.mistExplorations.length>0){html+='<div class="section-title">Mist Exploration — Active</div>';for(let mei=0;mei<state.mistExplorations.length;mei++){let me=state.mistExplorations[mei];let depthLabel=CONFIG.mistRings.find(r=>r.id===me.depth).label;let pct=Math.round(me.daysOut/me.totalDays*100);html+='<div class="item-row"><div><span class="item-name">'+me.mwName+' \u2192 '+depthLabel+'</span><br><span class="item-detail">Day '+me.daysOut+'/'+me.totalDays+'</span></div><div style="text-align:right"><span class="status-expedition">Exploring ('+pct+'%)</span><br><button class="btn" style="margin-top:4px;opacity:0.7" onclick="cancelMistExploration('+mei+')">Cancel</button></div></div>'}}if(availMW.length>0){html+='<div class="section-title">Mist Exploration</div>';html+='<div class="item-detail" style="margin-bottom:8px;font-style:italic">Send a Mistwalker into the unknown. Deeper rings yield rarer finds but more danger.</div>';for(let mw of availMW){let r=getMistWalkerRange(mw.id);let btns='';for(let ring of CONFIG.mistRings){let canGo=r>=ring.minRange;btns+='<button class="btn" style="margin:2px;font-size:0.75rem" '+(canGo?'onclick="launchMistExploration('+mw.id+',\''+ring.id+'\')"':'disabled title="Needs '+ring.minRange+' range"')+'>'+ring.label+(canGo?' ('+ring.encounterChance+'% risk)':'')+'</button>'}html+='<div class="item-row"><div><span class="item-name">'+mw.name+'</span><br><span class="item-detail">Range: '+r+'</span></div><div style="text-align:right">'+btns+'</div></div>'}}if(state.expeditions.length>0){html+='<div class="section-title">Active Expeditions</div>';for(let ei=0;ei<state.expeditions.length;ei++){let e=state.expeditions[ei];let tm=e.team.map(id=>{let p=getPerson(id);return p?personTag(p):'?'}).join(', ');let loc=state.locations.find(l=>l.id===e.locationId);let statusStr='In progress';let recallBtn='';if(e.recalling){if(e.returnEndDay){statusStr='Returning (~'+(e.returnEndDay-state.day)+'d)'}else{statusStr='Recall sent'}}else{let hasMW=alive().some(p=>p.role==='mistwalker'&&p.status==='active'&&p.assignment==='available');recallBtn=hasMW?'<button class="btn" onclick="showRecallModal('+ei+')" style="margin-top:4px">Recall</button>':''}html+='<div class="item-row"><div><span class="item-name">'+e.leaderName+' \u2192 '+(loc?loc.label:'?')+'</span><br><span class="item-detail">Team: '+tm+'</span><br><span class="item-detail">Day '+e.daysOut+'/'+e.duration+'</span></div><div style="text-align:right"><span class="status-expedition">'+statusStr+'</span><br>'+recallBtn+'</div></div>'}}html+='<div class="section-title">Locations</div>';let tierLabels={1:'The Shallows',2:'The Grey Reach',3:'The Deep',4:'The Source'};for(let t=1;t<=4;t++){let tierLocs=state.locations.filter(l=>l.tier===t);let anyRevealed=tierLocs.some(l=>l.revealed);let anyClues=tierLocs.some(l=>(state.decipheredClues.locations[l.id]||0)>0);if(!anyRevealed&&!anyClues&&t<4)continue;if(t===4&&!tierLocs.some(l=>l.revealed)){let total=(state.decipheredClues.final.shallows||0)+(state.decipheredClues.final.greyreach||0)+(state.decipheredClues.final.deep||0);if(total<1)continue;}html+='<div class="section-title">'+tierLabels[t]+'</div>';for(let loc of tierLocs){if(loc.revealed){let expStatus=loc.explored?'<span class="status-good">Explored</span>':'<span class="status-warn">Unexplored</span>';let avMW=alive().filter(p=>p.role==='mistwalker'&&p.assignment==='available'&&getMistWalkerRange(p.id)>=loc.distance);let activeExp=state.expeditions.find(e=>e.locationId===loc.id);html+='<div class="item-row"><div><span class="item-name">'+loc.label+'</span> <span class="item-detail">dist '+loc.distance+'</span>';html+='<br><span class="item-detail">'+loc.desc+'</span></div>';html+='<div style="text-align:right">'+expStatus;if(!loc.explored&&!activeExp&&avMW.length>0)html+='<br><button class="btn" onclick="launchExpedition(\''+loc.id+'\')" >Explore</button>';html+='</div></div>';}else{let count=state.decipheredClues.locations[loc.id]||0;if(count>0||t===4){let total=(state.decipheredClues.final.shallows||0)+(state.decipheredClues.final.greyreach||0)+(state.decipheredClues.final.deep||0);let label=t===4?'??? ('+total+'/9 source clues)':'??? ('+count+'/3 clues)';html+='<div class="item-row" style="opacity:0.5"><span class="item-name">'+label+'</span></div>';}}}};c.innerHTML=html;}

function renderResearch(){let c=document.getElementById('view-research');let availSch=alive().filter(p=>p.role==='scholar'&&(p.assignment==='available'||p.assignment==='none'));let busySch=alive().filter(p=>p.role==='scholar'&&p.assignment==='researching');let craftSch=alive().filter(p=>p.role==='scholar'&&p.assignment==='crafting');let totalSch=byRole('scholar').length;let html='<div class="item-row" style="margin-bottom:12px;border-left:3px solid var(--warning-light)"><span class="item-name">Scholars: <span class="'+(availSch.length>0?'status-good':'status-bad')+'">'+availSch.length+' available</span></span><span class="item-detail">'+busySch.length+' researching, '+craftSch.length+' crafting / '+totalSch+' total</span></div>';html+='<div class="section-title">Craft Compounds</div>';html+='<div class="item-row"><div><span class="item-detail">Distill compounds from creature carcasses. Each non-MW unit consumes 1 compound vs corrupted creatures.</span><br><span class="item-detail">Carcasses: <strong>'+state.carcasses+'</strong> | Compounds: <strong>'+state.compounds+'</strong>'+(craftSch.length>0?' (+'+Math.min(craftSch.length,state.carcasses)+'/day)':'')+'</span></div>';let freeSchCraft=alive().find(p=>p.role==='scholar'&&p.status==='active'&&p.assignment!=='researching'&&p.assignment!=='crafting');if(craftSch.length>0){html+='<button class="btn" onclick="toggleScholarCrafting('+craftSch[0].id+')" style="margin-left:8px">Stop</button>'}else if(freeSchCraft){html+='<button class="btn" onclick="toggleScholarCrafting('+freeSchCraft.id+')" style="margin-left:8px">Craft</button>'}else{html+='<button class="btn" disabled title="No scholar available" style="margin-left:8px">Craft</button>'}html+='</div>';if(state.activeResearch.length>0){html+='<div class="section-title">Active Research</div>';for(let r of state.activeResearch){let d=state.discoveries.find(x=>x.id===r.discoveryId);let pct=Math.round(r.progress/d.studyTime*100);let sch=r.scholarIds.map(id=>{let p=getPerson(id);return p?p.name:'?'}).join(', ');let hasAvailSch=availSch.some(s=>!r.scholarIds.includes(s.id));html+='<div class="item-row"><div><span class="item-name">'+d.label+'</span><br><span class="item-detail">Scholars: '+sch+' | '+pct+'% ('+Math.round(r.progress)+'/'+d.studyTime+'d)</span><br><span class="item-detail">Unlocks: '+d.unlockLabel+'</span></div><div style="text-align:right">'+(hasAvailSch?'<button class="btn" onclick="addScholarToResearch(\''+d.id+'\')">+ Scholar</button><br>':'')+'<button class="btn" style="margin-top:4px;opacity:0.7" onclick="cancelResearch(\''+d.id+'\')">Cancel</button></div></div>';}}let pendingUndeciphered=state.pendingClues.filter(id=>{let c=state.clues.find(x=>x.id===id);return c&&!c.deciphered&&!state.activeDeciphering.some(d=>d.clueId===id)});let activeDecipher=state.activeDeciphering;if(pendingUndeciphered.length>0||activeDecipher.length>0){html+='<div class="section-title">Clues to Decipher</div>';for(let d of activeDecipher){let clue=state.clues.find(c=>c.id===d.clueId);if(!clue)continue;let req=clue.tier==='shallows'?1:clue.tier==='greyreach'?2:3;let pct=Math.min(100,Math.round(d.progress/req*100));let schNames=d.scholarIds.map(id=>{let p=getPerson(id);return p?p.name:'?'}).join(', ');html+='<div class="item-row"><div><span class="item-name">'+(clue.type==='final'?'Source':'Location')+' Clue</span>';html+='<br><span class="item-detail" style="font-style:italic">"'+clue.label+'"</span>';html+='<br><span class="item-detail">'+clue.tier+' | '+schNames+' | '+pct+'%</span></div>';let hasAvailSchD=availSch.some(s=>!d.scholarIds.includes(s.id));html+='<div style="text-align:right">'+(hasAvailSchD&&req>1?'<button class="btn" onclick="addScholarToDecipher(\''+d.clueId+'\')" style="margin:2px;font-size:0.75rem">+ Scholar</button><br>':'')+'<button class="btn" onclick="cancelDeciphering(\''+d.clueId+'\')" style="margin:2px;font-size:0.75rem;opacity:0.7">Cancel</button></div></div>';}for(let cId of pendingUndeciphered){let clue=state.clues.find(c=>c.id===cId);if(!clue)continue;let req=clue.tier==='shallows'?1:clue.tier==='greyreach'?2:3;let isNewClue=!state.seenClues.includes(cId);html+='<div class="item-row"><div><span class="item-name">'+(clue.type==='final'?'Source':'Location')+' Clue'+(isNewClue?'<span class="badge-new">New</span>':'')+'</span>';html+='<br><span class="item-detail" style="font-style:italic">"'+clue.label+'"</span>';html+='<br><span class="item-detail">'+clue.tier+' | '+req+'d to decipher</span></div>';html+='<div style="text-align:right"><button class="btn" onclick="showDecipherModal(\''+cId+'\')" style="margin:2px">Decipher</button></div></div>';}}let avail=state.discoveries.filter(d=>d.found&&!d.studied&&!state.activeResearch.some(r=>r.discoveryId===d.id));if(avail.length>0){html+='<div class="section-title">Awaiting Research</div>';for(let d of avail){let isNewDisc=!state.seenDiscoveries.includes(d.id);html+='<div class="item-row"><div><span class="item-name">'+d.label+(isNewDisc?'<span class="badge-new">New</span>':'')+'</span><br><span class="item-detail">'+d.studyTime+'d | Unlocks: '+d.unlockLabel+'</span></div><button class="btn" onclick="startResearch(\''+d.id+'\')">Research</button></div>'}}if(state.activeResearch.length===0&&avail.length===0){html+='<div class="empty-state" style="margin:12px 0;opacity:0.6">No technologies available. Find discoveries through expeditions or digging.</div>'}let done=state.discoveries.filter(d=>d.studied);if(done.length>0){html+='<div class="section-title">Completed</div>';for(let d of done)html+='<div class="item-row" style="opacity:0.7"><span class="item-name">'+d.label+'</span><span class="status-good">'+d.unlockLabel+'</span></div>'}if(!html)html='<div class="empty-state">Find discoveries through expeditions or digging.</div>';else html+='<div class="section-title">Mist Clue Progress</div>';let tierLabels={1:'The Shallows',2:'The Grey Reach',3:'The Deep'};for(let t=1;t<=3;t++){let tierName=tierLabels[t];let tierKey=t===1?'shallows':t===2?'greyreach':'deep';let tierLocs=state.locations.filter(l=>l.tier===t);html+='<div class="item-row" style="flex-direction:column;align-items:flex-start"><span class="item-name">'+tierName+'</span>';for(let loc of tierLocs){let count=state.decipheredClues.locations[loc.id]||0;let status='';if(loc.revealed&&loc.luckyFind)status='<span class="status-good">Found directly</span>';else if(loc.revealed){let locSourceClue=state.clues.find(c=>c.type==='final'&&c.targetId===loc.id);if(locSourceClue&&locSourceClue.deciphered)status='<span class="status-good">Cleared \u2713 Source clue \u2713</span>';else if(locSourceClue&&locSourceClue.found)status='<span class="status-good">Cleared</span> <span class="status-warn">Source clue found</span>';else status='<span class="status-good">Charted \u2713</span>';}else status='<span class="status-bad">'+count+'/3 clues</span>';html+='<div style="margin-left:12px;font-size:0.85rem"><span class="item-detail">'+loc.label+': </span>'+status+'</div>';}let finalCount=state.decipheredClues.final[tierKey]||0;html+='<div style="margin-left:12px;font-size:0.85rem;margin-top:4px"><span class="item-detail">Source clues: <strong>'+finalCount+'/3</strong></span></div>';html+='</div>';}let totalFinal=(state.decipheredClues.final.shallows||0)+(state.decipheredClues.final.greyreach||0)+(state.decipheredClues.final.deep||0);let sourceStatus=totalFinal>=9?'<span class="status-good">Path discovered!</span>':'<span class="item-detail">'+totalFinal+'/9</span>';html+='<div class="item-row" style="border-left:3px solid var(--accent);padding-left:8px"><span class="item-name">The Source of the Mist</span><span>'+sourceStatus+'</span></div>';c.innerHTML=html}

function renderEngineering(){let c=document.getElementById('view-engineering');let availEng=alive().filter(p=>p.role==='engineer'&&(p.assignment==='available'||p.assignment==='none'));let busyEng=alive().filter(p=>p.role==='engineer'&&(p.assignment==='digging'||p.assignment==='building'));let trapEng=alive().filter(p=>p.role==='engineer'&&p.assignment==='trapping');let totalEng=byRole('engineer').length;let html='<div class="item-row" style="margin-bottom:12px;border-left:3px solid #7a6a5a"><span class="item-name">Engineers: <span class="'+(availEng.length>0?'status-good':'status-bad')+'">'+availEng.length+' available</span></span><span class="item-detail">'+busyEng.length+' busy, '+trapEng.length+' trapping / '+totalEng+' total</span></div>';html+='<div class="section-title">Build Traps</div>';html+='<div class="item-row"><div><span class="item-detail">Rig defenses. Costs 1 wood per trap. Reduces incoming attack by 2 each. Consumed when triggered.</span><br><span class="item-detail">Traps: <strong>'+state.traps+'</strong> | Wood: <strong>'+state.wood+'</strong>'+(trapEng.length>0?' (+'+Math.min(trapEng.length,state.wood)+'/day)':'')+'</span></div>';let freeEngTrap=alive().find(p=>p.role==='engineer'&&p.status==='active'&&p.assignment!=='digging'&&p.assignment!=='building'&&p.assignment!=='trapping');if(trapEng.length>0){html+='<button class="btn" onclick="toggleEngineerTrapping('+trapEng[0].id+')" style="margin-left:8px">Stop</button>'}else if(freeEngTrap){html+='<button class="btn" onclick="toggleEngineerTrapping('+freeEngTrap.id+')" style="margin-left:8px">Build</button>'}else{html+='<button class="btn" disabled title="No engineer available" style="margin-left:8px">Build</button>'}html+='</div>';
// BUILD SECTION
let canB=state.buildables.filter(b=>!b.built&&state.studiedDiscoveries.includes(b.reqDiscovery));if(canB.length>0||state.activeBuild){html+='<div class="section-title">Build</div>';if(state.activeBuild){let b=state.buildables.find(x=>x.id===state.activeBuild.buildableId);let pctB=Math.round(state.activeBuild.progress/state.activeBuild.totalDays*100);let engNames=(state.activeBuild.engineerIds||[]).map(id=>{let p=getPerson(id);return p?p.name:'?'}).join(', ');let hasAvailEngBuild=availEng.length>0;html+='<div class="item-row"><div><span class="item-name">'+b.label+'</span><br><span class="item-detail">Engineers: '+engNames+' | '+pctB+'% ('+Math.round(state.activeBuild.progress)+'/'+state.activeBuild.totalDays+'d)</span><br><span class="item-detail">Effect: '+b.effectLabel+'</span></div><div style="text-align:right"><span class="status-warn">Building</span>'+(hasAvailEngBuild?'<br><button class="btn" style="margin-top:4px" onclick="addEngineerToBuild()">+ Engineer (+30%)</button>':'')+'<br><button class="btn" style="margin-top:4px;opacity:0.7" onclick="cancelBuild()">Cancel</button></div></div>'}for(let b of canB){if(state.activeBuild&&state.activeBuild.buildableId===b.id)continue;let costStr=(b.woodCost||0)+'W'+(b.metalCost>0?', '+(b.metalCost||0)+'M':'');html+='<div class="item-row"><div><span class="item-name">'+b.label+'</span><br><span class="item-detail">'+b.buildTime+'d | '+b.effectLabel+' | Cost: '+costStr+'</span></div>'+(state.activeBuild?'<span class="item-detail">Queue</span>':'<button class="btn" onclick="startBuild(\''+b.id+'\')">Build</button>')+'</div>'}}
// DIG SECTION
html+='<div class="section-title">Excavation</div><p class="item-detail" style="margin-bottom:12px">Workers and engineers dig beneath the monastery. Each level yields one significant discovery.</p>';for(let i=0;i<state.digLevels.length;i++){let lv=state.digLevels[i];let isNext=!lv.cleared&&(i===0||state.digLevels[i-1].cleared);let isAct=state.activeDig&&state.activeDig.levelIndex===i;let pastHalf=isAct&&lv.named;let digDisplayName=(lv.named||lv.cleared)?lv.label:'Level '+(i+1);html+='<div class="item-row"><div><span class="item-name">'+digDisplayName+(isAct?' <span style="color:var(--warning-light);font-weight:bold">(In Progress)</span>':'')+'</span>';if(lv.cleared){let yStr=lv.yields.map(dId=>{let d=state.discoveries.find(x=>x.id===dId);return d?(d.found?d.label+' \u2713':d.label):'?'}).join('');html+='<br><span class="item-detail">Discovery: '+(yStr||'?')+'</span>'}else if(isAct){let digPpl=alive().filter(p=>p.assignment==='digging');let digNames=digPpl.map(d=>{let s=getPersonStats(d);return d.name+' ('+Math.round((s.digSpeed||0.5)*10)/10+'t/d)'}).join(', ');let totalSpd=0;digPpl.forEach(d=>{let s=getPersonStats(d);totalSpd+=(s.digSpeed||0.5)});totalSpd=Math.round(totalSpd*10)/10;if(pastHalf){let pct=Math.round(state.activeDig.progress/lv.laborDays*100);let prog=Math.round(state.activeDig.progress*10)/10;let rem=lv.laborDays-state.activeDig.progress;let estRem=totalSpd>0?Math.ceil(rem/totalSpd):'?';html+='<br><span class="item-detail">'+digNames+'</span><br><span class="item-detail">'+prog+'/'+lv.laborDays+' tons ('+pct+'%) \u2014 Rate: <strong>'+totalSpd+' tons/day</strong> \u2014 ~'+estRem+'d remaining</span>'}else{html+='<br><span class="item-detail">'+digNames+'</span><br><span class="item-detail">Rate: <strong>'+totalSpd+' tons/day</strong> \u2014 depth unknown</span>'}}html+='</div>';if(lv.cleared)html+='<span class="status-good">Cleared</span>';else if(isAct){let hasAvailDig=alive().some(p=>(p.role==='worker'||p.role==='engineer')&&(p.assignment==='available'||p.assignment==='none')&&p.status==='active');html+='<div style="text-align:right">'+(hasAvailDig?'<button class="btn" onclick="addDigger()">+ Digger</button><br>':'')+'<button class="btn" style="margin-top:4px;opacity:0.7" onclick="cancelDig()">Cancel</button></div>'}else if(isNext)html+='<button class="btn" onclick="startDig()">Begin</button>';else html+='<span class="item-detail">Locked</span>';html+='</div>'}let exploredForSalvage=state.locations.filter(l=>l.explored);let activeSalvage=state.salvageRuns||[];if(exploredForSalvage.length>0||activeSalvage.length>0){html+='<div class="section-title">Salvage Runs (Metal: '+state.metal+')</div>';html+='<p class="item-detail" style="margin-bottom:8px">Send engineers to salvage explored locations for metal. Metal is used for advanced buildings.</p>';for(let sr of activeSalvage){let eng=getPerson(sr.engineerId);let loc=state.locations.find(l=>l.id===sr.locationId);let pct=Math.round(sr.daysOut/sr.duration*100);html+='<div class="item-row"><div><span class="item-name">'+(eng?eng.name:'?')+' → '+(loc?loc.label:'?')+'</span><br><span class="item-detail">Day '+sr.daysOut+'/'+sr.duration+'</span></div><div style="text-align:right"><span class="status-expedition">Salvaging ('+pct+'%)</span><br><button class="btn" style="margin-top:4px;opacity:0.7" onclick="cancelSalvage(\''+sr.locationId+'\')">Cancel</button></div></div>'}for(let loc of exploredForSalvage){if(activeSalvage.some(s=>s.locationId===loc.id))continue;let hasEng=alive().some(p=>p.role==='engineer'&&(p.assignment==='available'||p.assignment==='none')&&p.status==='active');html+='<div class="item-row"><div><span class="item-name">'+loc.label+'</span><span class="item-detail"> (dist '+loc.distance+')</span></div>'+(hasEng?'<button class="btn" onclick="startSalvage(\''+loc.id+'\')">Salvage</button>':'<span class="item-detail">No engineer available</span>')+'</div>'}}c.innerHTML=html}

// MODALS
function showPersonModal(pid){let p=getPerson(pid);if(!p)return;let st=getPersonStats(p);let sStr=Object.entries(st).map(([k,v])=>'<strong>'+k+':</strong> '+(typeof v==='number'?Math.round(v*10)/10:v)).join(' &nbsp; ');let tH=['spirit','body','mind'].map(t=>{let l={spirit:'Spirit',body:'Resilience',mind:'Acuity'}[t];let h={spirit:'Priest(3), MW(3), Mystic(2+), Alch(2+)',body:'Fighter(2+), Eng(2+), MW(2+), Mystic(2+)',mind:'Scholar(3), Eng(2+), Alch(2+)'}[t];return'<div class="trait-bar"><span class="trait-label">'+l+'</span><div class="trait-dots">'+[1,2,3].map(i=>'<div class="trait-dot '+(i<=p.traits[t]?'filled':'')+'"></div>').join('')+'</div><span class="trait-hint">'+h+'</span></div>'}).join('');let eq=(state.equippedArtifacts[p.id]||[]).map(aId=>{let a=state.artifacts.find(x=>x.id===aId);return a?a.label:'?'}).join(', ')||'None';let comp=p.completedTraining.map(r=>roleLabel(r)).join(', ')||'None';let aH='';if(p.status==='lost'){let daysLost=state.day-p.lostDay;let mws=alive().filter(m=>m.role==='mistwalker'&&m.status==='active'&&m.assignment==='available');aH+='<div class="reassign-section" style="color:var(--danger-light)"><strong>Lost in the mist</strong> \u2014 '+daysLost+' day(s). Will die if not rescued within '+(10-daysLost)+' days.</div>';if(mws.length>0){aH+='<div class="reassign-section"><h3>Rescue</h3><div class="modal-actions">';for(let mw of mws)aH+='<button class="btn" onclick="rescueLost('+mw.id+','+p.id+')">Send '+mw.name+' (1d)</button>';aH+='</div></div>'}else{aH+='<div class="reassign-section"><span class="item-detail" style="color:var(--danger-light)">No Mistwalker available to rescue.</span></div>'}}if(p.status==='injured'){let hasTending=alive().some(x=>x.role==='priest'&&x.assignment==='tending');aH+='<div class="reassign-section" style="color:var(--danger-light)"><strong>Injured</strong> \u2014 Recovering for '+(p.injuryDays||'?')+' more day(s).'+(hasTending?' <span style="color:var(--success-light)">A priest is tending — recovery hastened.</span>':'')+' Will return to '+getDefaultAssignment(p.role)+' when healed.</div>'}if(p.status==='active'){aH+='<div class="reassign-section"><h3>Train</h3>';if(p.mwPermFail){aH+='<div style="color:var(--danger-light);font-style:italic;margin-bottom:8px">Mistwalker training: permanently failed</div>'}aH+='<div class="modal-actions">';let tr=['priest','fighter','scholar','engineer','worker','mistwalker','mystic','alchemist'].filter(r=>r!==p.role&&!p.completedTraining.includes(r));for(let r of tr){let canTrain=meetsTraitReq(p,r);let reason='';if(r==='mistwalker'){if(!p.completedTraining.includes('fighter')||!p.completedTraining.includes('priest')){canTrain=false;reason=' (need F+P)'}else if(p.mwPermFail){canTrain=false;reason=' (failed)'}else if(!canTrain){reason=' ('+traitReqLabel(r)+')'}}else if(r==='mystic'){let hasPrereqs=p.completedTraining.includes('fighter')&&p.completedTraining.includes('priest');let directPath=meetsTraitReq(p,r);if(!hasPrereqs&&!directPath){canTrain=false;reason=' (need F+P or Spi2+Res2+)'}else{canTrain=true}}else if(!canTrain){reason=' ('+traitReqLabel(r)+')'}let days=CONFIG.trainingDays[r]||7;let lb=roleLabel(r)+(canTrain?' ('+days+'d)':'')+reason;aH+='<button class="btn" '+(canTrain?'':'disabled')+' onclick="startTrainingAction('+p.id+',\''+r+'\')">'+lb+'</button>'}aH+='</div></div>';let switchRoles=p.completedTraining.filter(r=>r!==p.role&&r!=='mistwalker');if(switchRoles.length>0&&p.role!=='mistwalker'){aH+='<div class="reassign-section"><h3>Switch Role</h3><div class="modal-actions">';for(let r of switchRoles)aH+='<button class="btn" onclick="switchRole('+p.id+',\''+r+'\')">'+roleLabel(r)+'</button>';aH+='</div></div>'}aH+='<div class="reassign-section"><h3>Assign</h3><div class="modal-actions">';if(p.assignment!=='farms')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'farms\')">Farms</button>';if(p.assignment!=='garrison')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'garrison\')">Garrison</button>';if(p.role==='priest'&&p.assignment!=='perimeter')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'perimeter\')">Perimeter</button>';if(p.assignment!=='available')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'available\')">Unassign</button>';if(p.role==='scholar'&&p.assignment!=='crafting')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'crafting\')">Craft</button>';if(p.role==='worker'&&p.assignment!=='chopping')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'chopping\')">Chop</button>';if(p.role==='worker'&&p.assignment!=='herbgarden'&&state.knownHerbs.length>0)aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'herbgarden\')">Herb Garden</button>';if(p.role==='alchemist'&&p.assignment!=='brewing'&&state.knownRecipes.length>0)aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'brewing\')">Brew</button>';if(p.role==='alchemist'&&p.assignment!=='experimenting')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'experimenting\')">Experiment</button>';if(p.role==='engineer'&&p.assignment!=='trapping')aH+='<button class="btn" onclick="reassignPerson('+p.id+',\'trapping\')">Trap</button>';if(state.activeDig&&(p.role==='worker'||p.role==='engineer')&&p.assignment!=='digging')aH+='<button class="btn" onclick="assignToDigging('+p.id+')">Dig</button>';if(state.activeBuild&&p.role==='engineer'&&p.assignment!=='building')aH+='<button class="btn" onclick="assignToBuilding('+p.id+')">Build</button>';aH+='</div></div>'}let effSum=getEffectivenessSummary(p.role);document.getElementById('modal-content').innerHTML='<h2>'+p.name+'</h2><p><strong>Role:</strong> '+roleLabel(p.role)+' | <strong>Exp:</strong> '+p.exp+' | <strong>Status:</strong> '+p.status+'</p><p><strong>Training:</strong> '+comp+'</p><p style="font-size:0.85rem;color:var(--text-secondary)"><strong>Combat:</strong> '+effSum+'</p><div style="margin:10px 0">'+tH+'</div><p>'+sStr+'</p><p><strong>Artifacts:</strong> '+eq+'</p>'+aH+'<div class="modal-actions" style="margin-top:12px"><button class="btn" onclick="closeModal()">Close</button></div>';document.getElementById('modal').classList.add('open');positionModal()}

function showExpeditionModal(loc,mw){let priests=alive().filter(p=>p.role==='priest'&&p.assignment==='perimeter');let garrison=alive().filter(p=>p.assignment==='garrison');let wO=mw.map(w=>{let r=getMistWalkerRange(w.id);let ws=getPersonStats(w);return'<option value="'+w.id+'" '+(r>=loc.distance?'':'disabled')+'>'+w.name+' (end:'+r+', atk:'+(ws.attack||0)+', def:'+(ws.defense||0)+(r>=loc.distance?'':' - short')+')</option>'}).join('');let pO='<option value="0">None (solo)</option>'+priests.map(p=>{let s=getPersonStats(p);return'<option value="'+p.id+'">'+p.name+' (shield:'+(s.shields||2)+', end:'+(s.endurance||0)+')</option>'}).join('');let eH=garrison.length>0?garrison.map(f=>{let s=getPersonStats(f);return'<label style="display:block;margin:3px 0;font-size:0.85rem;color:var(--text-secondary);cursor:pointer"><input type="checkbox" value="'+f.id+'" class="escort-cb" disabled style="margin-right:6px"> '+f.name+' ('+roleLabel(f.role)+', atk:'+(s.attack||0)+' def:'+(s.defense||0)+')</label>'}).join(''):'<span class="item-detail">No garrison available.</span>';let locCr=state.creatures.filter(c=>c.locationIds.includes(loc.id));let crInfo=loc.scouted?(locCr.length>0?locCr.map(c=>c.label+' \u27d0 '+c.category+(creatureKnown(c.id)?' (atk:'+c.attack+' def:'+c.defense+')':'')).join(', '):'No threats detected'):'Unscouted — threats unknown';document.getElementById('modal-content').innerHTML='<h2>Expedition: '+loc.label+'</h2><p>Dist:'+loc.distance+' Risk:'+loc.risk+'%. MW solo or with escort.</p><p class="item-detail">Threats: '+crInfo+'</p><div class="select-group"><label>Leader (Mistwalker)</label><select id="exp-leader">'+wO+'</select></div><div class="select-group"><label>Priest (required for escort)</label><select id="exp-priest" onchange="toggleEscortCbs()">'+pO+'</select></div><div class="select-group"><label>Escort</label><div id="escort-section" style="opacity:0.4">'+eH+'</div><div id="escort-hint" class="item-detail" style="font-style:italic;margin-top:4px">Select a priest first to enable escort.</div></div><div class="modal-actions"><button class="btn btn-primary" onclick="submitExpeditionModal(\''+loc.id+'\')">Launch</button><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal').classList.add('open');positionModal()}

function submitExpeditionModal(locId){let lid=parseInt(document.getElementById('exp-leader').value);let pid=parseInt(document.getElementById('exp-priest').value)||0;let eids=[...document.querySelectorAll('.escort-cb:checked')].map(cb=>parseInt(cb.value));confirmExpeditionLaunch(locId,lid,pid,eids)}

function showEquipModal(aId){let a=state.artifacts.find(x=>x.id===aId);if(!a)return;let mwAllowed=['attack','defense','mistEndurance'];let cands=alive().filter(p=>{if(p.role===a.forRole)return true;if(p.role==='mistwalker')return Object.keys(a.effects).some(k=>mwAllowed.includes(k));return false});let fx=Object.entries(a.effects).map(([k,v])=>k+':+'+v).join(', ');let html='<h2>Equip '+a.label+'</h2><p>For: '+roleLabel(a.forRole)+' | '+fx+'</p>';if(cands.length===0)html+='<p>No eligible people.</p>';else{html+='<div class="section-title">Choose</div>';for(let p of cands){let st=getPersonStats(p);let sStr=Object.entries(st).map(([k,v])=>k+':'+( typeof v==='number'?Math.round(v*10)/10:v)).join(' ');let eq=(state.equippedArtifacts[p.id]||[]).map(eId=>{let ea=state.artifacts.find(x=>x.id===eId);return ea?ea.label:'?'}).join(', ')||'none';html+='<div class="item-row clickable" onclick="equipArtifact(\''+a.id+'\','+p.id+')"><div><span class="item-name">'+p.name+' ['+roleLabel(p.role)+']</span><br><span class="item-detail">'+sStr+'</span><br><span class="item-detail">Equipped: '+eq+'</span></div></div>'}}html+='<div class="modal-actions"><button class="btn" onclick="closeModal()">Cancel</button></div>';document.getElementById('modal-content').innerHTML=html;document.getElementById('modal').classList.add('open');positionModal()}

function toggleEscortCbs(){let v=parseInt(document.getElementById('exp-priest').value);let cbs=document.querySelectorAll('.escort-cb');let sec=document.getElementById('escort-section');let hint=document.getElementById('escort-hint');if(v>0){cbs.forEach(cb=>cb.disabled=false);if(sec)sec.style.opacity='1';if(hint)hint.style.display='none'}else{cbs.forEach(cb=>{cb.disabled=true;cb.checked=false});if(sec)sec.style.opacity='0.4';if(hint)hint.style.display='block'}}
function renderArtifacts(){let c=document.getElementById('view-artifacts');let fArts=state.artifacts.filter(a=>a.found);if(fArts.length===0){c.innerHTML='<div class="empty-state" style="margin:12px 0;opacity:0.6">No artifacts found yet. Discover them through expeditions or mist exploration.</div>';return}let availArts=fArts.filter(a=>!a.equippedTo);let equipArts=fArts.filter(a=>a.equippedTo);let html='<div class="item-row" style="margin-bottom:12px;border-left:3px solid var(--accent)"><span class="item-name">Artifacts: '+fArts.length+' found</span><span class="item-detail">'+availArts.length+' available, '+equipArts.length+' equipped</span></div>';if(availArts.length>0){html+='<div class="section-title">Available</div>';for(let a of availArts){let isNew=!state.seenArtifacts.includes(a.id);let fx=Object.entries(a.effects).map(([k,v])=>k+':+'+v).join(', ');html+='<div class="item-row"><div><span class="item-name">'+a.label+(isNew?'<span class="badge-new">New</span>':'')+'</span><br><span class="item-detail">For: '+roleLabel(a.forRole)+' | '+fx+'</span></div><button class="btn" onclick="showEquipModal(\''+a.id+'\')">Equip</button></div>'}}if(equipArts.length>0){html+='<div class="section-title">Equipped</div>';for(let a of equipArts){let fx=Object.entries(a.effects).map(([k,v])=>k+':+'+v).join(', ');let own=getPerson(a.equippedTo);html+='<div class="item-row"><div><span class="item-name">'+a.label+'</span><br><span class="item-detail">For: '+roleLabel(a.forRole)+' | '+fx+'</span><br><span class="item-detail">Equipped: '+(own?own.name:'?')+'</span></div><button class="btn" onclick="unequipArtifact(\''+a.id+'\')">Unequip</button></div>'}}let unfound=state.artifacts.filter(a=>!a.found).length;if(unfound>0)html+='<div class="item-detail" style="margin-top:12px;opacity:0.5">'+unfound+' artifact'+(unfound>1?'s':'')+' still undiscovered.</div>';c.innerHTML=html}
let lastClickX=0,lastClickY=0;document.addEventListener('click',function(e){lastClickX=e.clientX;lastClickY=e.clientY},true);
function positionModal(){let mc=document.getElementById('modal-content');mc.style.left='0';mc.style.top='0';let rect=mc.getBoundingClientRect();let w=rect.width,h=rect.height;let vw=window.innerWidth,vh=window.innerHeight;let x=Math.max(8,Math.min(lastClickX-w/2,vw-w-8));let y=Math.max(8,Math.min(lastClickY-40,vh-h-8));mc.style.left=x+'px';mc.style.top=y+'px'}
function closeModal(){document.getElementById('modal').classList.remove('open')}
function showDecipherModal(clueId){let clue=state.clues.find(c=>c.id===clueId);if(!clue)return;let avail=alive().filter(p=>p.role==='scholar'&&(p.assignment==='available'||p.assignment==='none'));let req=clue.tier==='shallows'?1:clue.tier==='greyreach'?2:3;let html='<h2>Decipher Clue</h2><p style="color:var(--text-secondary);font-style:italic">"'+clue.label+'"</p>';html+='<p>'+(clue.type==='final'?'Source clue':'Location clue')+' ('+clue.tier+') — '+req+' day'+(req>1?'s':'')+'</p>';if(avail.length===0){html+='<p style="color:var(--danger-light)">No scholars available.</p>';}else{html+='<p>Select scholar:</p>';for(let s of avail){let st=getPersonStats(s);html+='<button class="btn" onclick="startDeciphering(\''+clueId+'\','+s.id+');closeModal()" style="margin:4px">'+s.name+' (spd '+(st.researchSpeed||1)+')</button> ';}}html+='<br><button class="btn" onclick="closeModal()" style="margin-top:12px;opacity:0.7">Cancel</button>';document.getElementById('modal-content').innerHTML=html;document.getElementById('modal').classList.add('open');positionModal()}
function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));document.querySelector('.tab[data-tab="'+tab+'"]').classList.add('active');document.getElementById('view-'+tab).classList.add('active');if(tab==='research'){state.discoveries.filter(d=>d.found&&!d.studied).forEach(d=>{if(!state.seenDiscoveries.includes(d.id))state.seenDiscoveries.push(d.id)});state.pendingClues.forEach(id=>{let c=state.clues.find(x=>x.id===id);if(c&&!c.deciphered&&!state.seenClues.includes(id))state.seenClues.push(id)});updateTabIndicators()}if(tab==='artifacts'){state.artifacts.filter(a=>a.found).forEach(a=>{if(!state.seenArtifacts.includes(a.id))state.seenArtifacts.push(a.id)});updateTabIndicators()}}

function startGame(){document.getElementById('intro').classList.add('fading');setTimeout(()=>{document.getElementById('intro').style.display='none'},1000);initState();let autoTrain={'Maria':'priest','Cedric':'fighter','Felix':'engineer','Greta':'worker'};for(let[name,role]of Object.entries(autoTrain)){let p=state.people.find(x=>x.name===name&&x.role==='unassigned');if(p)startTrainingAction(p.id,role)}let ruth=state.people.find(x=>x.name==='Ruth');if(ruth)ruth.assignment='chopping';addMessage('event','The monastery. '+alive().length+' souls. '+byRole('worker').length+' workers, '+byRole('fighter').length+' fighters, '+byRole('priest').length+' priests, '+byRole('scholar').length+' scholar, '+byRole('engineer').length+' engineer, '+byRole('mistwalker').length+' mist walker. '+alive().filter(p=>p.role==='unassigned').length+' unassigned.');addMessage('event','Perimeter: '+getPerimeterStability()+'%. Food: '+state.food+' ('+Math.round(getFoodProduction()-getFoodConsumption())+'/d).');addMessage('event',state.locations.filter(l=>l.revealed).length+' locations known. MW explores outward. Workers farm, chop wood, and dig. Engineers build and salvage for metal. Scholars research.');addMessage('event','MW can go solo. Escort needs priest shield. MW training requires Fighter + Priest first.');render()}

document.getElementById('header-stats').innerHTML='';
</script>
</body>
</html>
